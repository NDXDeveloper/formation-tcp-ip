ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 5.3.1 Processus DORA

## Introduction

DHCP repose sur un Ã©change de **quatre messages** entre le client et le serveur, formant ce qu'on appelle le **processus DORA** :
- **D**iscover (DÃ©couverte)
- **O**ffer (Offre)
- **R**equest (RequÃªte)
- **A**cknowledge (Acquittement)

Ce processus, bien qu'il puisse sembler complexe au premier abord, est remarquablement Ã©lÃ©gant et robuste. Il a Ã©tÃ© conÃ§u pour fonctionner mÃªme dans les conditions les plus difficiles : client sans adresse IP, serveurs multiples, perte de paquets, etc.

Dans cette section, nous allons dÃ©composer chaque Ã©tape, examiner les messages en dÃ©tail, et comprendre pourquoi ce processus fonctionne si bien.

## Vue d'ensemble du processus DORA

### Les quatre Ã©tapes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Processus DORA complet                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client (0.0.0.0)                           Serveur DHCP (192.168.1.1)
       â”‚                                            â”‚
       â”‚                                            â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”                                        â”‚
   â”‚  1.   â”‚  DHCPDISCOVER (broadcast)              â”‚
   â”‚   D   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”˜  "Y a-t-il un serveur DHCP ici ?"      â”‚
       â”‚                                            â”‚
       â”‚                                        â”Œâ”€â”€â”€â”´â”€â”€â”€â”
       â”‚      DHCPOFFER (unicast ou broadcast)  â”‚  2.   â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   O   â”‚
       â”‚  "Oui ! Je peux t'offrir 192.168.1.50" â””â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                            â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”                                        â”‚
   â”‚  3.   â”‚  DHCPREQUEST (broadcast)               â”‚
   â”‚   R   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”˜  "J'accepte l'offre du serveur X"      â”‚
       â”‚                                            â”‚
       â”‚                                        â”Œâ”€â”€â”€â”´â”€â”€â”€â”
       â”‚       DHCPACK (unicast ou broadcast)   â”‚  4.   â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   A   â”‚
       â”‚  "ConfirmÃ© ! L'IP est Ã  toi"           â””â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                            â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”                                        â”‚
   â”‚ PrÃªt! â”‚  Configuration appliquÃ©e               â”‚
   â”‚  IP   â”‚  Client peut communiquer               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
```

### Pourquoi 4 messages et pas 2 ?

On pourrait penser qu'un simple Ã©change requÃªte-rÃ©ponse suffirait. Voyons pourquoi 4 messages sont nÃ©cessaires :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ScÃ©nario hypothÃ©tique avec 2 messages seulement              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client â†’ Broadcast : "Donnez-moi une IP"
Serveur A â†’ Client : "Prends 192.168.1.50"
Serveur B â†’ Client : "Prends 192.168.1.75"  â† ProblÃ¨me !

Lequel choisir ? Les deux serveurs ne savent pas
que l'autre a rÃ©pondu. Conflit potentiel.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Avec le processus DORA (4 messages)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client â†’ Broadcast : "Donnez-moi une IP" (DISCOVER)
Serveur A â†’ Client : "Je propose 192.168.1.50" (OFFER)
Serveur B â†’ Client : "Je propose 192.168.1.75" (OFFER)

Client â†’ Broadcast : "J'accepte l'offre de Serveur A" (REQUEST)
                     â†‘ Les deux serveurs entendent !

Serveur A â†’ Client : "OK, confirmÃ© !" (ACK)
Serveur B : (entend le REQUEST, sait que son offre est refusÃ©e)

âœ“ Pas de conflit
âœ“ Tous les serveurs synchronisÃ©s
âœ“ Un seul serveur attribue l'IP
```

## Ã‰tape 1 : DHCPDISCOVER

### Principe

Le client **dÃ©couvre** les serveurs DHCP disponibles sur le rÃ©seau.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contexte du client                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ Situation :                                              â”‚
â”‚ â€¢ Vient de se connecter au rÃ©seau                        â”‚
â”‚ â€¢ N'a AUCUNE adresse IP                                  â”‚
â”‚ â€¢ Ne sait PAS oÃ¹ est le serveur DHCP                     â”‚
â”‚ â€¢ Doit contacter le serveur sans savoir oÃ¹ il est        â”‚
â”‚                                                          â”‚
â”‚ Solution :                                               â”‚
â”‚ â€¢ Envoyer en BROADCAST                                   â”‚
â”‚ â€¢ Tous les appareils du rÃ©seau reÃ§oivent                 â”‚
â”‚ â€¢ Serveur(s) DHCP rÃ©pondent                              â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Format du message DHCPDISCOVER

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Paquet DHCPDISCOVER                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

COUCHE ETHERNET :
â”œâ”€ MAC source      : 00:1A:2B:3C:4D:5E (client)
â””â”€ MAC destination : FF:FF:FF:FF:FF:FF (broadcast)

COUCHE IP :
â”œâ”€ IP source       : 0.0.0.0 (client n'a pas d'IP)
â””â”€ IP destination  : 255.255.255.255 (broadcast)

COUCHE UDP :
â”œâ”€ Port source     : 68 (client DHCP)
â””â”€ Port destination: 67 (serveur DHCP)

MESSAGE DHCP :
â”œâ”€ Op              : 1 (BOOTREQUEST)
â”œâ”€ Htype           : 1 (Ethernet)
â”œâ”€ Hlen            : 6 (longueur MAC)
â”œâ”€ Hops            : 0
â”œâ”€ Transaction ID  : 0x12345678 (gÃ©nÃ©rÃ© alÃ©atoirement)
â”œâ”€ Seconds         : 0
â”œâ”€ Flags           : 0x0000 ou 0x8000 (broadcast flag)
â”œâ”€ Client IP       : 0.0.0.0
â”œâ”€ Your IP         : 0.0.0.0
â”œâ”€ Server IP       : 0.0.0.0
â”œâ”€ Gateway IP      : 0.0.0.0
â”œâ”€ Client MAC      : 00:1A:2B:3C:4D:5E
â”œâ”€ Server name     : (vide)
â”œâ”€ Boot filename   : (vide)
â””â”€ Options         :
    â”œâ”€ Option 53   : DHCP Message Type = 1 (DISCOVER)
    â”œâ”€ Option 55   : Parameter Request List
    â”‚               (1=subnet mask, 3=router, 6=DNS, 15=domain...)
    â”œâ”€ Option 61   : Client Identifier (MAC)
    â””â”€ Option 255  : End
```

### Champs importants

**Transaction ID (XID)**
```
RÃ´le : Identifiant unique de la transaction
Valeur : Nombre alÃ©atoire 32 bits (ex: 0x12345678)
Usage : Permet au client d'associer les rÃ©ponses Ã  ses requÃªtes

Exemple :
Client gÃ©nÃ¨re XID : 0xABCD1234
Toute rÃ©ponse avec XID diffÃ©rent â†’ IgnorÃ©e
Toute rÃ©ponse avec XID identique â†’ TraitÃ©e

Important : Ã‰vite confusion si plusieurs clients simultanÃ©s
```

**Broadcast Flag**
```
Position : Bit 15 du champ Flags
Valeurs :
â”œâ”€ 0x0000 : Serveur peut rÃ©pondre en unicast
â””â”€ 0x8000 : Serveur DOIT rÃ©pondre en broadcast

Pourquoi broadcast ?
Certains clients ne peuvent pas recevoir unicast avant d'avoir une IP
(limitations matÃ©rielles ou OS)

Cas typique :
â”œâ”€ PXE boot (dÃ©marrage rÃ©seau)
â”œâ”€ Certains devices IoT
â””â”€ SÃ©curitÃ© : Ã©viter qu'un switch ne route mal
```

**Parameter Request List (Option 55)**
```
Le client indique quels paramÃ¨tres il souhaite recevoir

Exemple typique :
Option 55 : Parameter Request List
  â”œâ”€ 1   : Subnet Mask
  â”œâ”€ 3   : Router (Gateway)
  â”œâ”€ 6   : Domain Name Server
  â”œâ”€ 15  : Domain Name
  â”œâ”€ 42  : NTP Servers
  â””â”€ 119 : Domain Search

Le serveur rÃ©pond avec ces informations (si disponibles)
```

### Exemple concret de DHCPDISCOVER

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capture Wireshark d'un DHCPDISCOVER                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Frame 1: 342 bytes on wire

Ethernet II
â”œâ”€ Destination: Broadcast (ff:ff:ff:ff:ff:ff)
â””â”€ Source: Dell_3c:4d:5e (00:1a:2b:3c:4d:5e)
   Type: IPv4 (0x0800)

Internet Protocol Version 4
â”œâ”€ Source: 0.0.0.0
â””â”€ Destination: 255.255.255.255

User Datagram Protocol
â”œâ”€ Source Port: 68
â””â”€ Destination Port: 67

Bootstrap Protocol (Discover)
â”œâ”€ Message type: Boot Request (1)
â”œâ”€ Hardware type: Ethernet (0x01)
â”œâ”€ Hardware address length: 6
â”œâ”€ Hops: 0
â”œâ”€ Transaction ID: 0x3d1d6b5c
â”œâ”€ Seconds elapsed: 0
â”œâ”€ Bootp flags: 0x0000 (Unicast)
â”œâ”€ Client IP address: 0.0.0.0
â”œâ”€ Your (client) IP address: 0.0.0.0
â”œâ”€ Next server IP address: 0.0.0.0
â”œâ”€ Relay agent IP address: 0.0.0.0
â”œâ”€ Client MAC address: 00:1a:2b:3c:4d:5e
â”œâ”€ Client hardware address padding: 00000000000000000000
â”œâ”€ Server host name: (empty)
â””â”€ Boot file name: (empty)

Option: (53) DHCP Message Type (Discover)
Option: (55) Parameter Request List
    â”œâ”€ 1 (Subnet Mask)
    â”œâ”€ 3 (Router)
    â”œâ”€ 6 (Domain Name Server)
    â”œâ”€ 15 (Domain Name)
    â””â”€ ...
Option: (61) Client identifier
    â””â”€ Hardware type: Ethernet (0x01)
    â””â”€ Client MAC address: 00:1a:2b:3c:4d:5e
Option: (255) End
```

## Ã‰tape 2 : DHCPOFFER

### Principe

Le(s) serveur(s) DHCP **proposent** une configuration au client.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Serveur DHCP reÃ§oit DHCPDISCOVER                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ 1. VÃ©rification :                                        â”‚
â”‚    â”œâ”€ Transaction ID notÃ©                                â”‚
â”‚    â”œâ”€ MAC client identifiÃ©e                              â”‚
â”‚    â””â”€ VÃ©rifier rÃ©servation pour cette MAC ?              â”‚
â”‚                                                          â”‚
â”‚ 2. SÃ©lection d'IP :                                      â”‚
â”‚    â”œâ”€ Si rÃ©servation existe â†’ Utiliser IP rÃ©servÃ©e       â”‚
â”‚    â”œâ”€ Sinon chercher dans le pool d'IPs libres           â”‚
â”‚    â””â”€ Marquer IP comme "offerte" (temporairement)        â”‚
â”‚                                                          â”‚
â”‚ 3. PrÃ©paration de l'offre :                              â”‚
â”‚    â”œâ”€ IP proposÃ©e : 192.168.1.50                         â”‚
â”‚    â”œâ”€ DurÃ©e de bail : 86400s (24h)                       â”‚
â”‚    â”œâ”€ Masque : 255.255.255.0                             â”‚
â”‚    â”œâ”€ Passerelle : 192.168.1.1                           â”‚
â”‚    â”œâ”€ DNS : 192.168.1.10, 8.8.8.8                        â”‚
â”‚    â””â”€ Autres options demandÃ©es                           â”‚
â”‚                                                          â”‚
â”‚ 4. Envoi de l'offre                                      â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Format du message DHCPOFFER

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Paquet DHCPOFFER                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

COUCHE ETHERNET :
â”œâ”€ MAC source      : AA:BB:CC:DD:EE:FF (serveur)
â””â”€ MAC destination : 00:1A:2B:3C:4D:5E (client, unicast)
                     ou FF:FF:FF:FF:FF:FF (si broadcast flag)

COUCHE IP :
â”œâ”€ IP source       : 192.168.1.1 (serveur DHCP)
â””â”€ IP destination  : 192.168.1.50 (IP offerte, unicast)
                     ou 255.255.255.255 (si broadcast flag)

COUCHE UDP :
â”œâ”€ Port source     : 67 (serveur DHCP)
â””â”€ Port destination: 68 (client DHCP)

MESSAGE DHCP :
â”œâ”€ Op              : 2 (BOOTREPLY)
â”œâ”€ Htype           : 1 (Ethernet)
â”œâ”€ Hlen            : 6
â”œâ”€ Hops            : 0
â”œâ”€ Transaction ID  : 0x12345678 (MÃŠME que DISCOVER !)
â”œâ”€ Seconds         : 0
â”œâ”€ Flags           : 0x0000 (ou 0x8000 si client a demandÃ©)
â”œâ”€ Client IP       : 0.0.0.0
â”œâ”€ Your IP         : 192.168.1.50 â† IP OFFERTE
â”œâ”€ Server IP       : 192.168.1.1
â”œâ”€ Gateway IP      : 0.0.0.0
â”œâ”€ Client MAC      : 00:1A:2B:3C:4D:5E
â””â”€ Options         :
    â”œâ”€ Option 53   : DHCP Message Type = 2 (OFFER)
    â”œâ”€ Option 54   : Server Identifier = 192.168.1.1
    â”œâ”€ Option 51   : IP Address Lease Time = 86400 (24h)
    â”œâ”€ Option 1    : Subnet Mask = 255.255.255.0
    â”œâ”€ Option 3    : Router = 192.168.1.1
    â”œâ”€ Option 6    : DNS Servers = 192.168.1.10, 8.8.8.8
    â”œâ”€ Option 15   : Domain Name = example.com
    â””â”€ Option 255  : End
```

### Unicast vs Broadcast dans l'OFFER

Le serveur peut rÃ©pondre de deux faÃ§ons :

**Unicast (dÃ©faut) :**
```
Condition : Broadcast flag = 0 dans DISCOVER

Paquet IP :
â”œâ”€ Destination : 192.168.1.50 (IP offerte)
â””â”€ MÃªme si le client n'a pas encore configurÃ© cette IP !

Paquet Ethernet :
â””â”€ Destination : 00:1A:2B:3C:4D:5E (MAC du client)

Avantage :
âœ“ Moins de trafic broadcast sur le rÃ©seau
âœ“ Plus propre

Risque :
âœ— Certains OS/matÃ©riels ne peuvent pas recevoir
  un paquet avec une IP qu'ils n'ont pas encore
```

**Broadcast (si demandÃ©) :**
```
Condition : Broadcast flag = 1 dans DISCOVER

Paquet IP :
â””â”€ Destination : 255.255.255.255

Paquet Ethernet :
â””â”€ Destination : FF:FF:FF:FF:FF:FF

Avantage :
âœ“ Compatible avec tous les clients
âœ“ Garantit rÃ©ception

InconvÃ©nient :
âœ— Tous les appareils reÃ§oivent (pollution rÃ©seau)
```

### Offres multiples

Si plusieurs serveurs DHCP sont prÃ©sents :

```
ScÃ©nario : 2 serveurs DHCP sur le rÃ©seau

Client â†’ Broadcast DHCPDISCOVER

Serveur A reÃ§oit :
â”œâ”€ Choisit IP : 192.168.1.50
â”œâ”€ Envoie DHCPOFFER
â””â”€ Marque IP "offerte" temporairement

Serveur B reÃ§oit :
â”œâ”€ Choisit IP : 192.168.1.75
â”œâ”€ Envoie DHCPOFFER
â””â”€ Marque IP "offerte" temporairement

Client reÃ§oit 2 offres :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Offre A : 192.168.1.50 (serveur A)  â”‚
â”‚ Offre B : 192.168.1.75 (serveur B)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client doit choisir : GÃ©nÃ©ralement la PREMIÃˆRE reÃ§ue
(ou selon d'autres critÃ¨res : serveur prÃ©fÃ©rÃ©, meilleur bail, etc.)
```

### Exemple concret de DHCPOFFER

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capture Wireshark d'un DHCPOFFER                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Frame 2: 342 bytes on wire

Ethernet II
â”œâ”€ Destination: Dell_3c:4d:5e (00:1a:2b:3c:4d:5e)
â””â”€ Source: Cisco_11:22:33 (aa:bb:cc:11:22:33)
   Type: IPv4 (0x0800)

Internet Protocol Version 4
â”œâ”€ Source: 192.168.1.1
â””â”€ Destination: 192.168.1.50

User Datagram Protocol
â”œâ”€ Source Port: 67
â””â”€ Destination Port: 68

Bootstrap Protocol (Offer)
â”œâ”€ Message type: Boot Reply (2)
â”œâ”€ Hardware type: Ethernet (0x01)
â”œâ”€ Transaction ID: 0x3d1d6b5c (MÃŠME que DISCOVER)
â”œâ”€ Client IP address: 0.0.0.0
â”œâ”€ Your (client) IP address: 192.168.1.50 â† IP offerte
â”œâ”€ Next server IP address: 192.168.1.1
â”œâ”€ Client MAC address: 00:1a:2b:3c:4d:5e

Option: (53) DHCP Message Type (Offer)
Option: (54) Server Identifier
    â””â”€ DHCP Server: 192.168.1.1
Option: (51) IP Address Lease Time
    â””â”€ 86400 seconds (1 day)
Option: (1) Subnet Mask
    â””â”€ 255.255.255.0
Option: (3) Router
    â””â”€ 192.168.1.1
Option: (6) Domain Name Server
    â”œâ”€ 192.168.1.10
    â””â”€ 8.8.8.8
Option: (15) Domain Name
    â””â”€ "example.com"
Option: (255) End
```

## Ã‰tape 3 : DHCPREQUEST

### Principe

Le client **demande formellement** l'IP offerte par un serveur spÃ©cifique.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client a reÃ§u une ou plusieurs offres                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ DÃ©cision :                                               â”‚
â”‚ â”œâ”€ Choisir une offre (gÃ©nÃ©ralement la premiÃ¨re)          â”‚
â”‚ â”œâ”€ Rejeter les autres (implicitement)                    â”‚
â”‚ â””â”€ Demander formellement l'IP choisie                    â”‚
â”‚                                                          â”‚
â”‚ Important : REQUEST envoyÃ© en BROADCAST                  â”‚
â”‚ Pourquoi ?                                               â”‚
â”‚ â”œâ”€ Informer TOUS les serveurs du choix                   â”‚
â”‚ â”œâ”€ Serveur choisi : confirme l'attribution               â”‚
â”‚ â””â”€ Autres serveurs : libÃ¨rent leurs offres               â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Format du message DHCPREQUEST

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Paquet DHCPREQUEST                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

COUCHE ETHERNET :
â”œâ”€ MAC source      : 00:1A:2B:3C:4D:5E (client)
â””â”€ MAC destination : FF:FF:FF:FF:FF:FF (broadcast !)

COUCHE IP :
â”œâ”€ IP source       : 0.0.0.0 (client n'a toujours pas d'IP)
â””â”€ IP destination  : 255.255.255.255 (broadcast !)

COUCHE UDP :
â”œâ”€ Port source     : 68
â””â”€ Port destination: 67

MESSAGE DHCP :
â”œâ”€ Op              : 1 (BOOTREQUEST)
â”œâ”€ Transaction ID  : 0x12345678 (MÃŠME que DISCOVER/OFFER)
â”œâ”€ Client IP       : 0.0.0.0
â”œâ”€ Your IP         : 0.0.0.0
â”œâ”€ Server IP       : 0.0.0.0
â”œâ”€ Client MAC      : 00:1A:2B:3C:4D:5E
â””â”€ Options         :
    â”œâ”€ Option 53   : DHCP Message Type = 3 (REQUEST)
    â”œâ”€ Option 54   : Server Identifier = 192.168.1.1 â† Serveur choisi
    â”œâ”€ Option 50   : Requested IP Address = 192.168.1.50 â† IP demandÃ©e
    â”œâ”€ Option 55   : Parameter Request List (mÃªme que DISCOVER)
    â””â”€ Option 255  : End
```

### Pourquoi REQUEST est en broadcast ?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ScÃ©nario avec 2 serveurs                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Sans broadcast (hypothÃ©tique) :
â”œâ”€ Client â†’ Serveur A (unicast) : "J'accepte ton offre"
â”œâ”€ Serveur B ne sait PAS que son offre est refusÃ©e
â””â”€ Serveur B attend, bloque l'IP inutilement

Avec broadcast (rÃ©el) :
â”œâ”€ Client â†’ Broadcast : "J'accepte l'offre de Serveur A"
â”‚   (Option 54 = adresse de Serveur A)
â”œâ”€ Serveur A entend : "C'est moi ! Je confirme (ACK)"
â”œâ”€ Serveur B entend : "Ce n'est pas moi, je libÃ¨re mon offre"
â””â”€ Tous les serveurs synchronisÃ©s âœ“

RÃ©sultat :
âœ“ Pas de conflits
âœ“ IPs non utilisÃ©es retournent au pool
âœ“ SystÃ¨me robuste et dÃ©centralisÃ©
```

### Ã‰tats oÃ¹ REQUEST est envoyÃ©

Le message REQUEST n'est pas envoyÃ© uniquement lors de l'obtention initiale. Il est aussi utilisÃ© pour :

**1. Obtention initiale (SELECTING)**
```
Ã‰tat : Client vient de recevoir des offres
Contenu du REQUEST :
â”œâ”€ Option 54 : Server Identifier (serveur choisi)
â”œâ”€ Option 50 : Requested IP (IP de l'offre choisie)
â””â”€ Broadcast pour informer tous les serveurs
```

**2. Renouvellement (RENEWING)**
```
Ã‰tat : Bail arrive Ã  50% d'expiration
Contenu du REQUEST :
â”œâ”€ PAS d'option 54 (Server Identifier)
â”œâ”€ Client IP : IP actuelle (dans le champ ciaddr)
â””â”€ Unicast vers le serveur d'origine

Timing : T1 = 50% du bail
Si bail = 24h â†’ Renouvellement Ã  12h
```

**3. Rebinding (REBINDING)**
```
Ã‰tat : Renouvellement T1 a Ã©chouÃ©, 87.5% du bail Ã©coulÃ©
Contenu du REQUEST :
â”œâ”€ PAS d'option 54
â”œâ”€ Client IP : IP actuelle
â””â”€ Broadcast (serveur original ne rÃ©pond pas)

Timing : T2 = 87.5% du bail
Si bail = 24h â†’ Rebinding Ã  21h

Peut accepter rÃ©ponse d'un autre serveur DHCP
```

**4. VÃ©rification aprÃ¨s reboot (INIT-REBOOT)**
```
Ã‰tat : Client redÃ©marre, se souvient de son ancienne IP
Contenu du REQUEST :
â”œâ”€ Option 50 : Requested IP (ancienne IP)
â”œâ”€ PAS d'option 54
â””â”€ Broadcast

But : VÃ©rifier si l'ancienne IP est toujours valide
```

### Exemple concret de DHCPREQUEST

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capture Wireshark d'un DHCPREQUEST (initial)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Frame 3: 342 bytes on wire

Ethernet II
â”œâ”€ Destination: Broadcast (ff:ff:ff:ff:ff:ff)
â””â”€ Source: Dell_3c:4d:5e (00:1a:2b:3c:4d:5e)

Internet Protocol Version 4
â”œâ”€ Source: 0.0.0.0
â””â”€ Destination: 255.255.255.255

User Datagram Protocol
â”œâ”€ Source Port: 68
â””â”€ Destination Port: 67

Bootstrap Protocol (Request)
â”œâ”€ Message type: Boot Request (1)
â”œâ”€ Transaction ID: 0x3d1d6b5c
â”œâ”€ Client IP address: 0.0.0.0
â”œâ”€ Your (client) IP address: 0.0.0.0
â”œâ”€ Client MAC address: 00:1a:2b:3c:4d:5e

Option: (53) DHCP Message Type (Request)
Option: (54) DHCP Server Identifier
    â””â”€ DHCP Server: 192.168.1.1 â† Serveur choisi
Option: (50) Requested IP Address
    â””â”€ 192.168.1.50 â† IP demandÃ©e
Option: (55) Parameter Request List
    â”œâ”€ 1 (Subnet Mask)
    â”œâ”€ 3 (Router)
    â””â”€ ...
Option: (255) End
```

## Ã‰tape 4 : DHCPACK

### Principe

Le serveur **confirme** l'attribution de l'IP au client.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Serveur DHCP reÃ§oit REQUEST                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ VÃ©rifications :                                          â”‚
â”‚ â”œâ”€ Option 54 = mon adresse ? (oui, c'est pour moi)       â”‚
â”‚ â”œâ”€ Transaction ID correspond ?                           â”‚
â”‚ â”œâ”€ IP demandÃ©e disponible/valide ?                       â”‚
â”‚ â””â”€ Client autorisÃ© (MAC) ?                               â”‚
â”‚                                                          â”‚
â”‚ Si tout OK :                                             â”‚
â”‚ â”œâ”€ Marquer IP comme ATTRIBUÃ‰E                            â”‚
â”‚ â”œâ”€ Enregistrer : MAC â†” IP + timestamp                    â”‚
â”‚ â”œâ”€ CrÃ©er le bail (lease)                                 â”‚
â”‚ â””â”€ Envoyer DHCPACK avec configuration complÃ¨te           â”‚
â”‚                                                          â”‚
â”‚ Si problÃ¨me :                                            â”‚
â”‚ â””â”€ Envoyer DHCPNAK (refus)                               â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Format du message DHCPACK

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Paquet DHCPACK                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

COUCHE ETHERNET :
â”œâ”€ MAC source      : AA:BB:CC:DD:EE:FF (serveur)
â””â”€ MAC destination : 00:1A:2B:3C:4D:5E (client, unicast)
                     ou FF:FF:FF:FF:FF:FF (si broadcast)

COUCHE IP :
â”œâ”€ IP source       : 192.168.1.1 (serveur)
â””â”€ IP destination  : 192.168.1.50 (IP attribuÃ©e)
                     ou 255.255.255.255 (si broadcast)

COUCHE UDP :
â”œâ”€ Port source     : 67
â””â”€ Port destination: 68

MESSAGE DHCP :
â”œâ”€ Op              : 2 (BOOTREPLY)
â”œâ”€ Transaction ID  : 0x12345678 (MÃŠME que tout le reste)
â”œâ”€ Client IP       : 0.0.0.0
â”œâ”€ Your IP         : 192.168.1.50 â† IP ATTRIBUÃ‰E
â”œâ”€ Server IP       : 192.168.1.1
â”œâ”€ Client MAC      : 00:1A:2B:3C:4D:5E
â””â”€ Options         :
    â”œâ”€ Option 53   : DHCP Message Type = 5 (ACK)
    â”œâ”€ Option 54   : Server Identifier = 192.168.1.1
    â”œâ”€ Option 51   : Lease Time = 86400 (24h)
    â”œâ”€ Option 58   : Renewal Time (T1) = 43200 (12h = 50%)
    â”œâ”€ Option 59   : Rebinding Time (T2) = 75600 (21h = 87.5%)
    â”œâ”€ Option 1    : Subnet Mask = 255.255.255.0
    â”œâ”€ Option 3    : Router = 192.168.1.1
    â”œâ”€ Option 6    : DNS = 192.168.1.10, 8.8.8.8
    â”œâ”€ Option 15   : Domain Name = example.com
    â””â”€ Option 255  : End
```

### DHCPACK vs DHCPNAK

Le serveur peut rÃ©pondre de deux faÃ§ons au REQUEST :

**DHCPACK (Acknowledgement - Acceptation)**
```
Condition : Tout est OK
Message : "ConfirmÃ©, l'IP est Ã  toi !"
RÃ©sultat :
â”œâ”€ Client configure son interface rÃ©seau
â”œâ”€ Client opÃ©rationnel
â””â”€ Bail crÃ©Ã©/renouvelÃ©
```

**DHCPNAK (Negative Acknowledgement - Refus)**
```
Conditions possibles :
â”œâ”€ IP demandÃ©e dÃ©jÃ  attribuÃ©e Ã  un autre
â”œâ”€ IP hors du scope du serveur
â”œâ”€ Configuration du rÃ©seau a changÃ©
â”œâ”€ Bail expirÃ© et IP rÃ©attribuÃ©e
â””â”€ Client sur le mauvais rÃ©seau

Message : "RefusÃ©, recommence depuis le dÃ©but"

RÃ©sultat :
â”œâ”€ Client doit abandonner l'IP
â””â”€ Client recommence avec DISCOVER
```

**Exemple de DHCPNAK :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ScÃ©nario NAK                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Contexte :
â”œâ”€ Laptop utilisÃ© au bureau hier : 192.168.1.50
â”œâ”€ Laptop ramenÃ© Ã  la maison aujourd'hui
â””â”€ Se connecte au WiFi maison (rÃ©seau 192.168.0.0/24)

Processus :
1. Laptop dÃ©marre, se souvient de 192.168.1.50
2. Envoie REQUEST pour 192.168.1.50 (INIT-REBOOT)
3. Serveur DHCP maison reÃ§oit :
   â””â”€ 192.168.1.50 n'est pas dans mon rÃ©seau !
   â””â”€ IP invalide pour ce rÃ©seau
4. Serveur rÃ©pond : DHCPNAK
5. Laptop abandonne 192.168.1.50
6. Laptop recommence : DISCOVER â†’ OFFER â†’ REQUEST â†’ ACK
7. ReÃ§oit nouvelle IP : 192.168.0.42 (rÃ©seau maison)
```

### Exemple concret de DHCPACK

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capture Wireshark d'un DHCPACK                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Frame 4: 342 bytes on wire

Ethernet II
â”œâ”€ Destination: Dell_3c:4d:5e (00:1a:2b:3c:4d:5e)
â””â”€ Source: Cisco_11:22:33 (aa:bb:cc:11:22:33)

Internet Protocol Version 4
â”œâ”€ Source: 192.168.1.1
â””â”€ Destination: 192.168.1.50

User Datagram Protocol
â”œâ”€ Source Port: 67
â””â”€ Destination Port: 68

Bootstrap Protocol (ACK)
â”œâ”€ Message type: Boot Reply (2)
â”œâ”€ Transaction ID: 0x3d1d6b5c
â”œâ”€ Your (client) IP address: 192.168.1.50 â† IP confirmÃ©e
â”œâ”€ Next server IP address: 192.168.1.1
â”œâ”€ Client MAC address: 00:1a:2b:3c:4d:5e

Option: (53) DHCP Message Type (ACK)
Option: (54) Server Identifier
    â””â”€ 192.168.1.1
Option: (51) IP Address Lease Time
    â””â”€ 86400 seconds (1 day)
Option: (58) Renewal Time Value (T1)
    â””â”€ 43200 seconds (12 hours)
Option: (59) Rebinding Time Value (T2)
    â””â”€ 75600 seconds (21 hours)
Option: (1) Subnet Mask
    â””â”€ 255.255.255.0
Option: (3) Router
    â””â”€ 192.168.1.1
Option: (6) Domain Name Server
    â”œâ”€ 192.168.1.10
    â””â”€ 8.8.8.8
Option: (15) Domain Name
    â””â”€ "example.com"
Option: (255) End
```

## AprÃ¨s DHCPACK : Configuration et vÃ©rification

### Application de la configuration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client reÃ§oit DHCPACK                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰tape 1 : VÃ©rification ARP (optionnelle mais recommandÃ©e)
â”œâ”€ Client envoie ARP Probe pour 192.168.1.50
â”œâ”€ "Qui a 192.168.1.50 ?" (depuis 0.0.0.0)
â”œâ”€ Attend 1-2 secondes
â””â”€ Si rÃ©ponse reÃ§ue â†’ IP en conflit ! â†’ Envoie DHCPDECLINE

Ã‰tape 2 : Configuration interface rÃ©seau
â”œâ”€ Configurer IP : 192.168.1.50/24
â”œâ”€ Configurer passerelle : 192.168.1.1
â”œâ”€ Configurer DNS : 192.168.1.10, 8.8.8.8
â””â”€ Autres paramÃ¨tres reÃ§us

Ã‰tape 3 : ARP Announcement (optionnel)
â”œâ”€ Client envoie ARP gratuit
â”œâ”€ "192.168.1.50 est Ã  moi (00:1A:2B:3C:4D:5E)"
â””â”€ Mise Ã  jour des caches ARP du rÃ©seau

Ã‰tape 4 : DÃ©marrage timer de renouvellement
â”œâ”€ T1 (50% du bail) : 12 heures
â”œâ”€ T2 (87.5% du bail) : 21 heures
â””â”€ Expiration : 24 heures

Client est maintenant opÃ©rationnel ! âœ“
```

### VÃ©rification de conflits (ARP Probe)

```
Pourquoi ?
Le serveur DHCP pense que l'IP est libre, mais :
â”œâ”€ Un appareil avec IP statique pourrait l'utiliser
â”œâ”€ Une erreur de configuration
â””â”€ Un conflit suite Ã  un problÃ¨me rÃ©seau

Processus ARP Probe :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client envoie ARP Request :                        â”‚
â”‚ â€¢ Sender IP : 0.0.0.0 (pas encore configurÃ©)       â”‚
â”‚ â€¢ Target IP : 192.168.1.50 (IP Ã  vÃ©rifier)         â”‚
â”‚ â€¢ Sender MAC : 00:1A:2B:3C:4D:5E                   â”‚
â”‚                                                    â”‚
â”‚ Attente 1-2 secondes                               â”‚
â”‚                                                    â”‚
â”‚ Si rÃ©ponse reÃ§ue :                                 â”‚
â”‚ â†’ Un autre appareil a cette IP !                   â”‚
â”‚ â†’ Client envoie DHCPDECLINE                        â”‚
â”‚ â†’ Recommence le processus DORA                     â”‚
â”‚                                                    â”‚
â”‚ Si pas de rÃ©ponse :                                â”‚
â”‚ â†’ IP libre, OK pour l'utiliser âœ“                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Timeline complÃ¨te du processus DORA

### Vue dÃ©taillÃ©e avec timings

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Timeline dÃ©taillÃ©e DHCP (rÃ©seau local)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T = 0ms : Client se connecte au rÃ©seau
          â””â”€ Interface rÃ©seau dÃ©tecte lien actif

T = 50ms : Client gÃ©nÃ¨re DHCPDISCOVER
           â””â”€ Transaction ID : 0xABCD1234
           â””â”€ Envoie en broadcast

T = 55ms : Serveur DHCP reÃ§oit DISCOVER
           â””â”€ SÃ©lectionne IP : 192.168.1.50
           â””â”€ PrÃ©pare OFFER

T = 60ms : Serveur envoie DHCPOFFER
           â””â”€ IP : 192.168.1.50
           â””â”€ Bail : 86400s

T = 65ms : Client reÃ§oit OFFER
           â””â”€ Attente courte (1-3s) pour autres offres
           â””â”€ PrÃ©pare REQUEST

T = 2065ms : Client envoie DHCPREQUEST (aprÃ¨s attente)
             â””â”€ Option 54 : Serveur 192.168.1.1
             â””â”€ Option 50 : IP 192.168.1.50
             â””â”€ Broadcast

T = 2070ms : Serveur reÃ§oit REQUEST
             â””â”€ VÃ©rifie validitÃ©
             â””â”€ Marque IP comme attribuÃ©e
             â””â”€ PrÃ©pare ACK

T = 2075ms : Serveur envoie DHCPACK
             â””â”€ Confirmation complÃ¨te

T = 2080ms : Client reÃ§oit ACK
             â””â”€ Lance ARP Probe

T = 2085ms : Client envoie ARP Probe
             â””â”€ "Qui a 192.168.1.50 ?"

T = 4085ms : Pas de rÃ©ponse ARP (timeout 2s)
             â””â”€ IP confirmÃ©e libre

T = 4090ms : Client configure interface
             â””â”€ IP : 192.168.1.50/24
             â””â”€ Passerelle : 192.168.1.1
             â””â”€ DNS : 192.168.1.10, 8.8.8.8

T = 4095ms : Client envoie ARP gratuit
             â””â”€ Annonce son IP au rÃ©seau

T = 4100ms : Client OPÃ‰RATIONNEL âœ“
             â””â”€ Peut communiquer sur le rÃ©seau
             â””â”€ DurÃ©e totale : ~4 secondes

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Timers dÃ©marrÃ©s                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ T1 (Renewal)   : Dans 12 heures (50%)                    â”‚
â”‚ T2 (Rebinding) : Dans 21 heures (87.5%)                  â”‚
â”‚ Expiration     : Dans 24 heures (100%)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Optimisations de timing

```
Dans la vraie vie, les dÃ©lais varient :

RÃ©seau local (Ethernet/WiFi) :
â”œâ”€ DORA complet : 100ms - 2s
â”œâ”€ Broadcast quasi instantanÃ©
â””â”€ Principalement limitÃ© par traitement serveur

RÃ©seau avec DHCP Relay :
â”œâ”€ DORA complet : 200ms - 5s
â”œâ”€ + DÃ©lai de routage
â””â”€ + Traitement relay agent

RÃ©seau chargÃ© :
â”œâ”€ DORA complet : jusqu'Ã  10s
â”œâ”€ Perte de paquets possible
â””â”€ Retransmissions nÃ©cessaires
```

## Renouvellement de bail (Renewal)

### Processus de renouvellement Ã  T1

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Renouvellement normal (T1 = 50% du bail)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Contexte :
â”œâ”€ Bail obtenu : 24 heures
â”œâ”€ T1 : 12 heures (50%)
â””â”€ Client attend 12 heures...

T = 12h : Timer T1expire
          â””â”€ Client prÃ©pare DHCPREQUEST

DHCPREQUEST (Renouvellement) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DiffÃ©rences avec REQUEST initial :                 â”‚
â”‚                                                    â”‚
â”‚ Envoi : UNICAST vers serveur DHCP original         â”‚
â”‚         (pas broadcast)                            â”‚
â”‚                                                    â”‚
â”‚ Champs :                                           â”‚
â”‚ â”œâ”€ ciaddr : 192.168.1.50 (IP actuelle)             â”‚
â”‚ â”œâ”€ PAS d'option 54 (Server Identifier)             â”‚
â”‚ â””â”€ PAS d'option 50 (Requested IP)                  â”‚
â”‚                                                    â”‚
â”‚ Signification :                                    â”‚
â”‚ "Je suis 192.168.1.50, je veux renouveler          â”‚
â”‚  mon bail avec toi, serveur 192.168.1.1"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Serveur rÃ©pond :
â”œâ”€ DHCPACK : Bail renouvelÃ© pour 24h supplÃ©mentaires
â””â”€ ou DHCPNAK : Bail refusÃ©, recommencer

Si ACK reÃ§u :
â”œâ”€ Nouveau bail : 24h Ã  partir de maintenant
â”œâ”€ Nouveau T1 : Dans 12h
â””â”€ Client continue normalement

Si pas de rÃ©ponse :
â”œâ”€ Client garde son IP
â”œâ”€ RÃ©essaie pÃ©riodiquement
â””â”€ Attend T2 (87.5%) pour rebinding
```

### Diagramme de renouvellement

```
Client (192.168.1.50)              Serveur DHCP (192.168.1.1)
       â”‚                                    â”‚
       â”‚  DHCPREQUEST (unicast)             â”‚
       â”‚  ciaddr: 192.168.1.50              â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                    â”‚
       â”‚  DHCPACK                           â”‚
       â”‚  Bail renouvelÃ© : +24h             â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                    â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”                                â”‚
   â”‚ Bail  â”‚ Nouveau bail : 24h             â”‚
   â”‚renouv.â”‚ Nouveau T1 : 12h               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
```

## Rebinding Ã  T2

### Processus de rebinding

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rebinding (T2 = 87.5% du bail)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Contexte :
â”œâ”€ Tentatives de renouvellement Ã  T1 ont Ã©chouÃ©
â”œâ”€ Serveur DHCP original ne rÃ©pond pas/plus
â””â”€ 87.5% du bail Ã©coulÃ© (21h sur 24h)

T = 21h : Timer T2 expire
          â””â”€ Client entre en mode REBINDING

DHCPREQUEST (Rebinding) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Envoi : BROADCAST (pas unicast)                    â”‚
â”‚         N'importe quel serveur DHCP peut rÃ©pondre  â”‚
â”‚                                                    â”‚
â”‚ Champs :                                           â”‚
â”‚ â”œâ”€ ciaddr : 192.168.1.50                           â”‚
â”‚ â”œâ”€ PAS d'option 54                                 â”‚
â”‚ â””â”€ PAS d'option 50                                 â”‚
â”‚                                                    â”‚
â”‚ Signification :                                    â”‚
â”‚ "Je suis 192.168.1.50, j'ai besoin de renouveler   â”‚
â”‚  mon bail, N'IMPORTE QUEL serveur peut rÃ©pondre!"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ScÃ©narios possibles :

1. Serveur original rÃ©pond :
   â””â”€ DHCPACK : Bail renouvelÃ© âœ“

2. Autre serveur DHCP rÃ©pond :
   â””â”€ DHCPACK : Bail renouvelÃ© avec nouveau serveur âœ“

3. Aucun serveur ne rÃ©pond :
   â””â”€ Continue jusqu'Ã  expiration complÃ¨te
   â””â”€ Ã€ expiration : DOIT arrÃªter d'utiliser l'IP
   â””â”€ Recommence DORA complet
```

### Timeline T1/T2/Expiration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cycle de vie d'un bail de 24 heures                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

0h                    12h                  21h           24h
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚                    â”‚             â”‚
â”‚   UTILISATION       â”‚   RENOUVELLEMENT   â”‚  REBINDING  â”‚
â”‚     NORMALE         â”‚      (T1)          â”‚     (T2)    â”‚
â”‚                     â”‚                    â”‚             â”‚
â”‚ Client utilise IP   â”‚ Essaie de renouve- â”‚ Broadcast   â”‚
â”‚ normalement         â”‚ ler (unicast)      â”‚ pour tout   â”‚
â”‚                     â”‚                    â”‚ serveur     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†‘                    â†‘             â†‘
                      50%                 87.5%        100%

Actions :
â”œâ”€ 0-12h  : Utilisation normale
â”œâ”€ 12h    : Tentative renouvellement (unicast)
â”‚          Si Ã©chec : rÃ©essaie pÃ©riodiquement
â”œâ”€ 21h    : Rebinding (broadcast)
â”‚          Peut accepter n'importe quel serveur
â””â”€ 24h    : Si toujours pas renouvelÃ© :
            â”œâ”€ DOIT arrÃªter d'utiliser l'IP
            â””â”€ Recommence DISCOVER
```

## LibÃ©ration d'IP (DHCPRELEASE)

### LibÃ©ration volontaire

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client libÃ¨re volontairement son IP                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Situations :
â”œâ”€ ArrÃªt propre du systÃ¨me (shutdown)
â”œâ”€ DÃ©connexion explicite du rÃ©seau
â”œâ”€ Commande manuelle : ipconfig /release (Windows)
â””â”€                     dhclient -r (Linux)

Message DHCPRELEASE :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Envoi : Unicast vers serveur DHCP                  â”‚
â”‚                                                    â”‚
â”‚ Champs :                                           â”‚
â”‚ â”œâ”€ ciaddr : 192.168.1.50 (IP libÃ©rÃ©e)              â”‚
â”‚ â”œâ”€ Option 53 : Message Type = 7 (RELEASE)          â”‚
â”‚ â””â”€ Option 54 : Server Identifier                   â”‚
â”‚                                                    â”‚
â”‚ Pas de rÃ©ponse attendue                            â”‚
â”‚ (RELEASE est un one-way message)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Serveur reÃ§oit RELEASE :
â”œâ”€ Marque IP comme LIBRE
â”œâ”€ Supprime le bail
â”œâ”€ IP retourne dans le pool
â””â”€ Disponible immÃ©diatement pour attribution
```

### LibÃ©ration vs Expiration

```
DHCPRELEASE (volontaire) :
âœ“ IP libÃ©rÃ©e immÃ©diatement
âœ“ Disponible de suite pour autres clients
âœ“ Bon citoyen du rÃ©seau

Expiration (passive) :
âœ— IP bloquÃ©e jusqu'Ã  expiration complÃ¨te
âœ— Gaspillage de ressources
âœ— Pool rÃ©duit inutilement

Exemple :
â”œâ”€ Laptop au cafÃ© : bail de 1h
â”œâ”€ Utilisateur part aprÃ¨s 10 minutes
â”‚
â”‚ Sans RELEASE :
â”‚ â””â”€ IP bloquÃ©e 50 minutes inutilement
â”‚
â”‚ Avec RELEASE :
â”‚ â””â”€ IP libÃ©rÃ©e immÃ©diatement
â”‚ â””â”€ Disponible pour le prochain client
```

## DÃ©cliner une IP (DHCPDECLINE)

### DÃ©tection de conflit

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client dÃ©tecte un conflit d'adresse                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ScÃ©nario :
1. Client reÃ§oit DHCPACK pour 192.168.1.50
2. Client fait ARP Probe pour vÃ©rifier
3. ReÃ§oit rÃ©ponse ARP â†’ IP dÃ©jÃ  utilisÃ©e !
4. Client envoie DHCPDECLINE

Message DHCPDECLINE :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Envoi : Broadcast                                  â”‚
â”‚                                                    â”‚
â”‚ Champs :                                           â”‚
â”‚ â”œâ”€ Option 53 : Message Type = 4 (DECLINE)          â”‚
â”‚ â”œâ”€ Option 54 : Server Identifier                   â”‚
â”‚ â””â”€ Option 50 : Declined IP (192.168.1.50)          â”‚
â”‚                                                    â”‚
â”‚ Signification :                                    â”‚
â”‚ "L'IP que tu m'as donnÃ©e est dÃ©jÃ  utilisÃ©e !       â”‚
â”‚  Je ne peux pas l'accepter."                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Serveur reÃ§oit DECLINE :
â”œâ”€ Marque IP comme CONFLICTUELLE
â”œâ”€ N'attribue plus cette IP (temporairement)
â”œâ”€ Loggue le problÃ¨me
â””â”€ Admin doit investiguer

Client :
â”œâ”€ Abandonne cette IP
â”œâ”€ Recommence DORA complet
â””â”€ EspÃ¨re recevoir une IP diffÃ©rente
```

### Exemple de conflit

```
Timeline d'un conflit :

T = 0s : Serveur attribue 192.168.1.50 au client
T = 1s : Client reÃ§oit ACK
T = 2s : Client envoie ARP Probe
         "Qui a 192.168.1.50 ?"
T = 2.1s : Imprimante (IP statique mal configurÃ©e) rÃ©pond !
          "Moi ! 192.168.1.50 = AA:BB:CC:DD:EE:FF"
T = 2.2s : Client dÃ©tecte conflit
T = 2.3s : Client envoie DHCPDECLINE
T = 3s : Client recommence DISCOVER
T = 5s : ReÃ§oit nouvelle offre : 192.168.1.51
T = 6s : ARP Probe pour 192.168.1.51
T = 8s : Pas de rÃ©ponse â†’ OK âœ“
T = 9s : Client configure 192.168.1.51
```

## Messages DHCP complets

### Tableau rÃ©capitulatif

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Types de messages DHCP (Option 53)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚ Type â”‚ Nom         â”‚ EnvoyÃ© par â”‚ Direction â”‚ Usage            â”‚
â”‚â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  1   â”‚ DISCOVER    â”‚ Client     â”‚ Broadcast â”‚ DÃ©couverte       â”‚
â”‚  2   â”‚ OFFER       â”‚ Serveur    â”‚ Uni/Broad â”‚ Offre            â”‚
â”‚  3   â”‚ REQUEST     â”‚ Client     â”‚ Uni/Broad â”‚ Demande          â”‚
â”‚  4   â”‚ DECLINE     â”‚ Client     â”‚ Broadcast â”‚ Refus (conflit)  â”‚
â”‚  5   â”‚ ACK         â”‚ Serveur    â”‚ Uni/Broad â”‚ Confirmation     â”‚
â”‚  6   â”‚ NAK         â”‚ Serveur    â”‚ Uni/Broad â”‚ Refus            â”‚
â”‚  7   â”‚ RELEASE     â”‚ Client     â”‚ Unicast   â”‚ LibÃ©ration       â”‚
â”‚  8   â”‚ INFORM      â”‚ Client     â”‚ Broadcast â”‚ Info (a dÃ©jÃ  IP) â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DHCPINFORM

Un type de message particulier :

```
DHCPINFORM :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client : "J'ai dÃ©jÃ  une IP (statique), mais        â”‚
â”‚           donne-moi les autres paramÃ¨tres"         â”‚
â”‚                                                    â”‚
â”‚ Usage :                                            â”‚
â”‚ â”œâ”€ Client avec IP statique                         â”‚
â”‚ â”œâ”€ Veut DNS, passerelle, etc. depuis DHCP          â”‚
â”‚ â””â”€ Simplifie config (IP fixe + params auto)        â”‚
â”‚                                                    â”‚
â”‚ Champs :                                           â”‚
â”‚ â”œâ”€ ciaddr : 192.168.1.100 (IP statique actuelle)   â”‚
â”‚ â””â”€ Option 53 : 8 (INFORM)                          â”‚
â”‚                                                    â”‚
â”‚ Serveur rÃ©pond avec DHCPACK contenant :            â”‚
â”‚ â”œâ”€ Pas d'attribution d'IP (client en a dÃ©jÃ )       â”‚
â”‚ â””â”€ Juste les autres options (DNS, gateway, etc.)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Gestion des erreurs et timeout

### Retransmissions

Si le client ne reÃ§oit pas de rÃ©ponse :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StratÃ©gie de retransmission (RFC 2131)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DHCPDISCOVER :

Tentative 1 : T = 0s, attendre 4s
Tentative 2 : T = 4s, attendre 8s
Tentative 3 : T = 12s, attendre 16s
Tentative 4 : T = 28s, attendre 32s
...
Jusqu'Ã  abandon ou succÃ¨s

Algorithme :
â”œâ”€ DÃ©lai initial : 4 secondes
â”œâ”€ DÃ©lai double Ã  chaque tentative
â”œâ”€ Maximum : 64 secondes entre tentatives
â””â”€ Randomization : Â±1s pour Ã©viter tempÃªte broadcast

DHCPREQUEST (aprÃ¨s OFFER) :

Si pas de ACK reÃ§u :
â”œâ”€ RÃ©essayer REQUEST quelques fois
â”œâ”€ Si Ã©chec : retour Ã  DISCOVER
â””â”€ (l'OFFER a peut-Ãªtre expirÃ©)
```

### Timeout et abandon

```
AprÃ¨s plusieurs tentatives sans succÃ¨s :

Client a deux options :

1. Configuration automatique de lien-local (IPv4LL)
   â”œâ”€ Adresse 169.254.x.x (APIPA)
   â”œâ”€ Permet communication locale uniquement
   â””â”€ Continue d'essayer DHCP en arriÃ¨re-plan

2. Pas de connectivitÃ© rÃ©seau
   â”œâ”€ Pas d'IP attribuÃ©e
   â”œâ”€ Interface marquÃ©e comme "non configurÃ©e"
   â””â”€ Continue d'essayer DHCP

Windows :
â””â”€ Utilise APIPA (169.254.x.x) par dÃ©faut

Linux :
â””â”€ DÃ©pend de la configuration
â””â”€ NetworkManager : peut utiliser link-local
â””â”€ dhclient : gÃ©nÃ©ralement abandonne
```

## Points clÃ©s Ã  retenir

ğŸ”‘ **DORA : 4 messages essentiels (Discover, Offer, Request, Acknowledge)**

ğŸ”‘ **DISCOVER en broadcast car client n'a pas encore d'IP**

ğŸ”‘ **REQUEST aussi en broadcast pour informer tous les serveurs du choix**

ğŸ”‘ **Transaction ID identique dans les 4 messages pour associer requÃªte/rÃ©ponse**

ğŸ”‘ **Plusieurs serveurs peuvent offrir, client choisit une seule offre**

ğŸ”‘ **ARP Probe vÃ©rifie absence de conflit avant configuration**

ğŸ”‘ **Renouvellement Ã  T1 (50%) en unicast, rebinding Ã  T2 (87.5%) en broadcast**

ğŸ”‘ **DHCPNAK force le client Ã  recommencer depuis le dÃ©but**

ğŸ”‘ **DHCPRELEASE libÃ¨re l'IP proprement (bon citoyen rÃ©seau)**

ğŸ”‘ **DHCPDECLINE signale un conflit d'adresse au serveur**

---

## Ce que nous avons appris

Dans cette section, nous avons explorÃ© en dÃ©tail :

- âœ… Les 4 Ã©tapes du processus DORA avec schÃ©mas complets
- âœ… Le format dÃ©taillÃ© de chaque message DHCP
- âœ… Les champs importants (Transaction ID, flags, options)
- âœ… Pourquoi REQUEST est en broadcast (synchronisation serveurs)
- âœ… Le processus de renouvellement (T1) et rebinding (T2)
- âœ… La libÃ©ration volontaire (RELEASE) vs expiration
- âœ… La dÃ©tection et gestion des conflits (DECLINE)
- âœ… Les messages supplÃ©mentaires (NAK, INFORM)
- âœ… La gestion des erreurs et retransmissions
- âœ… Les timings et timeouts du processus

## Conclusion

Le processus DORA est un exemple remarquable d'ingÃ©nierie rÃ©seau : simple en apparence, mais robuste et bien pensÃ©. Les 4 messages permettent une coordination parfaite entre clients et serveurs multiples, Ã©vitent les conflits, et assurent une utilisation optimale des adresses IP disponibles.

Comprendre DORA en profondeur permet de diagnostiquer efficacement les problÃ¨mes DHCP et d'apprÃ©cier l'Ã©lÃ©gance de ce protocole qui fonctionne silencieusement des milliards de fois par jour Ã  travers le monde.

---

**Prochaine section : Baux et renouvellement (dÃ©tails avancÃ©s)** ğŸ‘‰

â­ï¸ [Baux et renouvellement](/05-couche-application/03.2-dhcp-baux-renouvellement.md)
