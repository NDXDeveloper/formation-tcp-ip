ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 5.2.4 Cache DNS et TTL

## Introduction

Le cache DNS est l'un des mÃ©canismes les plus importants d'Internet. Sans lui, chaque rÃ©solution DNS nÃ©cessiterait de parcourir toute la hiÃ©rarchie (racine â†’ TLD â†’ autoritaire), gÃ©nÃ©rant un trafic immense et des latences insupportables. Le **Time To Live (TTL)** est le mÃ©canisme qui contrÃ´le combien de temps les informations peuvent rester en cache.

Comprendre le cache DNS et le TTL est essentiel pour :
- **Optimiser les performances** de vos applications
- **Planifier les migrations** et changements d'infrastructure
- **Diagnostiquer** les problÃ¨mes de rÃ©solution DNS
- **Comprendre** pourquoi les changements DNS ne sont pas instantanÃ©s

Dans cette section, nous allons explorer en profondeur ces concepts fondamentaux.

## Qu'est-ce que le cache DNS ?

### DÃ©finition

Le **cache DNS** est une mÃ©moire temporaire qui stocke les rÃ©ponses aux requÃªtes DNS rÃ©centes, permettant de rÃ©utiliser ces informations sans interroger Ã  nouveau les serveurs DNS autoritaires.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Principe du cache                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ PremiÃ¨re requÃªte pour www.example.com :                 â”‚
â”‚   Client â†’ RÃ©solveur â†’ [RÃ©solution complÃ¨te] â†’ Cache    â”‚
â”‚   Temps : 150ms                                         â”‚
â”‚                                                         â”‚
â”‚ DeuxiÃ¨me requÃªte pour www.example.com :                 â”‚
â”‚   Client â†’ RÃ©solveur â†’ [Lit le cache] â†’ Client          â”‚
â”‚   Temps : 10ms (93% plus rapide !)                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pourquoi le cache est crucial ?

**Sans cache :**
```
Volume de requÃªtes DNS :
â€¢ Gmail : 1 milliard d'utilisateurs
â€¢ Chacun vÃ©rifie mail 10Ã—/jour
â€¢ = 10 milliards de requÃªtes/jour
â€¢ = 115 740 requÃªtes/seconde

Vers les serveurs google.com :
â€¢ Charge Ã‰NORME
â€¢ Latence Ã©levÃ©e
â€¢ CoÃ»ts d'infrastructure prohibitifs
â€¢ Impact environnemental significatif
```

**Avec cache (TTL = 300s) :**
```
MÃªme scÃ©nario :
â€¢ 10 milliards de requÃªtes/jour
â€¢ Mais cache rÃ©duit de 95%+
â€¢ = ~500 millions vers serveurs google.com
â€¢ = ~5 787 requÃªtes/seconde

BÃ©nÃ©fices :
âœ“ Latence 10Ã— plus faible
âœ“ Charge serveur 20Ã— plus faible
âœ“ Bande passante Ã©conomisÃ©e
âœ“ ExpÃ©rience utilisateur fluide
```

## Le TTL (Time To Live)

### DÃ©finition et rÃ´le

Le **TTL** (Time To Live) est une valeur en **secondes** qui indique combien de temps un enregistrement DNS peut Ãªtre conservÃ© en cache avant d'Ãªtre considÃ©rÃ© comme obsolÃ¨te.

```
Exemple d'enregistrement DNS avec TTL :

www.example.com.  3600  IN  A  93.184.216.34
                  â†‘
                  TTL = 3600 secondes (1 heure)

Signification :
"Cette information est valide pour 1 heure.
 AprÃ¨s, tu dois la redemander."
```

### Anatomie du TTL dans une rÃ©ponse DNS

```
RequÃªte DNS :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Question : www.example.com A ?                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RÃ©ponse DNS :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Answer Section:                                      â”‚
â”‚ www.example.com.  3600  IN  A  93.184.216.34         â”‚
â”‚                   â†‘                                  â”‚
â”‚                   â””â”€ TTL initial                     â”‚
â”‚                                                      â”‚
â”‚ Le client/rÃ©solveur met ceci en cache                â”‚
â”‚ avec un timestamp : 2024-12-06 10:00:00              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Utilisation du cache :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã€ 10:00:00 : TTL = 3600 (cache frais)                â”‚
â”‚ Ã€ 10:15:00 : TTL = 2700 (encore 45 minutes)          â”‚
â”‚ Ã€ 10:30:00 : TTL = 1800 (encore 30 minutes)          â”‚
â”‚ Ã€ 10:59:00 : TTL = 60 (presque expirÃ©)               â”‚
â”‚ Ã€ 11:00:00 : TTL = 0 (expirÃ©, suppression)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### TTL dÃ©crÃ©mental

Le TTL **diminue** au fil du temps dans le cache :

```bash
# PremiÃ¨re requÃªte
$ dig www.example.com
www.example.com.        3600    IN      A       93.184.216.34
                        â†‘
                        TTL = 3600s (1 heure)

# 10 minutes plus tard (mÃªme cache)
$ dig www.example.com
www.example.com.        3000    IN      A       93.184.216.34
                        â†‘
                        TTL = 3000s (50 minutes restantes)

# 30 minutes aprÃ¨s la premiÃ¨re requÃªte
$ dig www.example.com
www.example.com.        1800    IN      A       93.184.216.34
                        â†‘
                        TTL = 1800s (30 minutes restantes)

# 1 heure aprÃ¨s (cache expirÃ©, nouvelle rÃ©solution)
$ dig www.example.com
www.example.com.        3600    IN      A       93.184.216.34
                        â†‘
                        TTL reset Ã  3600s (nouveau cache)
```

## Les niveaux de cache DNS

Le cache DNS existe Ã  **plusieurs niveaux** dans le systÃ¨me :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 HIÃ‰RARCHIE DES CACHES                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Niveau 1 : Cache Application
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Navigateur (Chrome, Firefox...)     â”‚  DurÃ©e : Minutes
â”‚ â€¢ Cache propre Ã  l'application      â”‚  Taille : Petite (quelques Mo)
â”‚ â€¢ Quelques centaines d'entrÃ©es      â”‚  PortÃ©e : Application
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Niveau 2 : Cache SystÃ¨me d'exploitation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Windows DNS Client                  â”‚  DurÃ©e : Selon TTL
â”‚ systemd-resolved (Linux)            â”‚  Taille : Moyenne (~1000 entrÃ©es)
â”‚ mDNSResponder (macOS)               â”‚  PortÃ©e : Toute la machine
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Niveau 3 : Cache Routeur/Box
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Box Internet/Routeur (192.168.1.1)  â”‚  DurÃ©e : Selon TTL
â”‚ â€¢ dnsmasq, etc.                     â”‚  Taille : Petite-Moyenne
â”‚ â€¢ Cache partagÃ© du rÃ©seau local     â”‚  PortÃ©e : RÃ©seau local
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Niveau 4 : Cache RÃ©solveur RÃ©cursif
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google DNS (8.8.8.8)                â”‚  DurÃ©e : Selon TTL
â”‚ Cloudflare (1.1.1.1)                â”‚  Taille : Ã‰norme (Go-To)
â”‚ DNS du FAI                          â”‚  PortÃ©e : Millions d'utilisateurs
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Niveau 5 : Pas de cache
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Serveurs autoritaires               â”‚  DurÃ©e : N/A
â”‚ â€¢ Serveurs racine                   â”‚  Taille : N/A
â”‚ â€¢ Serveurs TLD                      â”‚  PortÃ©e : Source de vÃ©ritÃ©
â”‚ â€¢ Serveurs de domaine               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Impact des diffÃ©rents niveaux

```
RequÃªte DNS pour www.example.com :

VÃ©rification niveau 1 (Navigateur) :
â”œâ”€ TrouvÃ© ? â†’ Utilise (0-2ms) âœ“
â””â”€ Pas trouvÃ© ? â†’ Niveau 2

VÃ©rification niveau 2 (OS) :
â”œâ”€ TrouvÃ© ? â†’ Utilise (1-5ms) âœ“
â””â”€ Pas trouvÃ© ? â†’ Niveau 3

VÃ©rification niveau 3 (Routeur) :
â”œâ”€ TrouvÃ© ? â†’ Utilise (5-15ms) âœ“
â””â”€ Pas trouvÃ© ? â†’ Niveau 4

VÃ©rification niveau 4 (RÃ©solveur rÃ©cursif) :
â”œâ”€ TrouvÃ© ? â†’ Utilise (10-50ms) âœ“
â””â”€ Pas trouvÃ© ? â†’ RÃ©solution complÃ¨te (100-200ms)
```

### Exemple pratique : Chronologie d'une rÃ©solution

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T = 0 : PremiÃ¨re visite de www.example.com             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Chrome : Cache vide â†’ Passe au niveau suivant
2. Windows : Cache vide â†’ Passe au niveau suivant
3. Box : Cache vide â†’ Passe au niveau suivant
4. RÃ©solveur (8.8.8.8) : Cache vide â†’ RÃ©solution complÃ¨te
   â””â”€ Racine â†’ TLD â†’ Autoritaire
   â””â”€ Temps : 150ms

RÃ©sultat : www.example.com = 93.184.216.34 (TTL: 3600s)

Tous les niveaux mettent en cache :
â€¢ Chrome : 3600s
â€¢ Windows : 3600s
â€¢ Box : 3600s
â€¢ RÃ©solveur : 3600s

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T = 5 min : DeuxiÃ¨me visite de www.example.com         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Chrome : TrouvÃ© ! TTL = 3300s restant
   â””â”€ Temps : 0ms (instantanÃ©)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T = 30 min : Visite depuis Firefox (mÃªme machine)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Firefox : Cache vide â†’ Passe au niveau suivant
2. Windows : TrouvÃ© ! TTL = 1800s restant
   â””â”€ Temps : 2ms

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T = 1h30 : Nouvelle visite (tous caches expirÃ©s)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Chrome : ExpirÃ© â†’ Passe au niveau suivant
2. Windows : ExpirÃ© â†’ Passe au niveau suivant
3. Box : ExpirÃ© â†’ Passe au niveau suivant
4. RÃ©solveur : ExpirÃ© â†’ RÃ©solution complÃ¨te
   â””â”€ Temps : 150ms (comme la premiÃ¨re fois)
```

## Fonctionnement dÃ©taillÃ© du cache

### Structure d'une entrÃ©e de cache

Chaque entrÃ©e dans un cache DNS contient :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EntrÃ©e de cache pour www.example.com                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚ Nom (QNAME)    : www.example.com                    â”‚
â”‚ Type (QTYPE)   : A                                  â”‚
â”‚ Classe (QCLASS): IN                                 â”‚
â”‚                                                     â”‚
â”‚ RÃ©ponse        : 93.184.216.34                      â”‚
â”‚ TTL initial    : 3600                               â”‚
â”‚ Timestamp      : 2024-12-06 10:00:00                â”‚
â”‚ TTL restant    : 3600 - (now - timestamp)           â”‚
â”‚                                                     â”‚
â”‚ MÃ©tadonnÃ©es :                                       â”‚
â”‚ â”œâ”€ Serveur source : ns1.example.com                 â”‚
â”‚ â”œâ”€ Authoritative : Oui                              â”‚
â”‚ â””â”€ DNSSEC validÃ© : Oui                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Algorithme de recherche dans le cache

```python
# Pseudocode de recherche dans un cache DNS

def lookup_cache(qname, qtype):
    """
    Recherche dans le cache DNS
    """
    # 1. Calculer la clÃ©
    cache_key = (qname, qtype)

    # 2. VÃ©rifier si l'entrÃ©e existe
    if cache_key not in dns_cache:
        return None  # Cache miss

    # 3. RÃ©cupÃ©rer l'entrÃ©e
    entry = dns_cache[cache_key]

    # 4. Calculer le TTL restant
    elapsed = now() - entry.timestamp
    ttl_remaining = entry.ttl_initial - elapsed

    # 5. VÃ©rifier si l'entrÃ©e est toujours valide
    if ttl_remaining <= 0:
        # EntrÃ©e expirÃ©e, supprimer du cache
        del dns_cache[cache_key]
        return None  # Cache miss

    # 6. Retourner la rÃ©ponse avec le TTL mis Ã  jour
    entry.ttl_current = ttl_remaining
    return entry  # Cache hit !
```

### Exemple de cache hit vs miss

**Cache hit (trouvÃ©) :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RequÃªte : www.example.com A                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ 1. Calculer clÃ© : ("www.example.com", A)             â”‚
â”‚ 2. Chercher dans cache : TROUVÃ‰ âœ“                    â”‚
â”‚ 3. VÃ©rifier TTL : 1800s restant > 0 âœ“                â”‚
â”‚ 4. Retourner : 93.184.216.34                         â”‚
â”‚                                                      â”‚
â”‚ Temps : 0-5ms                                        â”‚
â”‚ RequÃªtes rÃ©seau : 0                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Cache miss (pas trouvÃ©) :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RequÃªte : api.newsite.com A                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ 1. Calculer clÃ© : ("api.newsite.com", A)             â”‚
â”‚ 2. Chercher dans cache : PAS TROUVÃ‰ âœ—                â”‚
â”‚ 3. Lancer rÃ©solution complÃ¨te                        â”‚
â”‚    â””â”€ Racine â†’ TLD â†’ Autoritaire                     â”‚
â”‚ 4. RÃ©ponse : 198.51.100.42                           â”‚
â”‚ 5. Mettre en cache (TTL: 3600s)                      â”‚
â”‚                                                      â”‚
â”‚ Temps : 100-200ms                                    â”‚
â”‚ RequÃªtes rÃ©seau : 3-4                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cache expiration (expulsion)

**Expiration passive :**
```
Le cache ne fait rien jusqu'Ã  ce que l'entrÃ©e soit demandÃ©e

Ã€ la demande :
â”œâ”€ TTL > 0 ? â†’ Utiliser l'entrÃ©e
â””â”€ TTL â‰¤ 0 ? â†’ Supprimer et rÃ©soudre Ã  nouveau
```

**Expiration active (garbage collection) :**
```
Processus pÃ©riodique qui nettoie le cache

Toutes les N minutes :
â”œâ”€ Parcourir toutes les entrÃ©es
â”œâ”€ Supprimer les entrÃ©es expirÃ©es
â””â”€ LibÃ©rer la mÃ©moire

Avantage : MÃ©moire contrÃ´lÃ©e
InconvÃ©nient : Consommation CPU
```

## Choix du TTL : StratÃ©gies et compromis

### Valeurs typiques de TTL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Type d'enregistrement    TTL typique    Raison       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ SOA, NS records         86400 (24h)    Rarement      â”‚
â”‚                                        modifiÃ©       â”‚
â”‚                                                      â”‚
â”‚ A, AAAA (stable)        3600 (1h)      Compromis     â”‚
â”‚                                        standard      â”‚
â”‚                                                      â”‚
â”‚ A, AAAA (cloud)         300 (5min)     FlexibilitÃ©   â”‚
â”‚                                        scaling       â”‚
â”‚                                                      â”‚
â”‚ Load balancing          60-300         Changements   â”‚
â”‚                         (1-5min)       frÃ©quents     â”‚
â”‚                                                      â”‚
â”‚ MX                      3600 (1h)      Stable        â”‚
â”‚                                                      â”‚
â”‚ TXT (SPF, DKIM)         3600 (1h)      Rarement      â”‚
â”‚                                        modifiÃ©       â”‚
â”‚                                                      â”‚
â”‚ CNAME                   3600 (1h)      Suit la       â”‚
â”‚                                        cible         â”‚
â”‚                                                      â”‚
â”‚ Services critiques      300-600        DisponibilitÃ© â”‚
â”‚ (failover)              (5-10min)      vs cache      â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### TTL court vs TTL long

#### TTL court (60-300 secondes)

**Avantages :**
```
âœ“ Changements propagÃ©s rapidement
  Exemple : Changement d'IP visible en 5-10 minutes

âœ“ FlexibilitÃ© pour scaling
  Exemple : Ajout/retrait de serveurs rapide

âœ“ Failover rapide
  Exemple : Serveur tombe, switch en quelques minutes

âœ“ Tests et migrations plus faciles
  Exemple : Rollback rapide si problÃ¨me
```

**InconvÃ©nients :**
```
âœ— Plus de requÃªtes DNS
  Impact : Charge sur serveurs DNS

âœ— Latence accrue
  Impact : RÃ©solution plus frÃ©quente (10-50ms ajoutÃ©s)

âœ— Plus de bande passante
  Impact : Trafic DNS multipliÃ© par 10-20Ã—

âœ— CoÃ»ts potentiellement plus Ã©levÃ©s
  Impact : Certains DNS facturent par requÃªte
```

**Exemple de calcul :**
```
Site avec 1 million de visiteurs/jour
TTL = 3600s (1h) :
â””â”€ ~42 000 requÃªtes vers serveurs autoritaires/jour

TTL = 300s (5min) :
â””â”€ ~500 000 requÃªtes vers serveurs autoritaires/jour
â””â”€ 12Ã— plus de charge !
```

#### TTL long (3600-86400 secondes)

**Avantages :**
```
âœ“ TrÃ¨s peu de requÃªtes DNS
  Impact : Ã‰conomie de bande passante et coÃ»ts

âœ“ Latence minimale
  Impact : Cache quasi permanent, rÃ©solution rare

âœ“ Charge serveur minimale
  Impact : Serveurs DNS peu sollicitÃ©s

âœ“ RÃ©silience aux pannes DNS
  Impact : Site accessible mÃªme si DNS tombe
```

**InconvÃ©nients :**
```
âœ— Changements trÃ¨s lents Ã  se propager
  Impact : Migration peut prendre 24h+

âœ— Difficile de rÃ©agir rapidement
  Impact : ProblÃ¨me = attendre l'expiration

âœ— Failover lent
  Impact : Serveur en panne = clients bloquÃ©s longtemps

âœ— Tests compliquÃ©s
  Impact : Rollback difficile/impossible
```

**Exemple de migration :**
```
Changement d'IP avec TTL = 86400s (24h) :

T = 0h     : Changement effectuÃ©
T = 1h     : 4% des utilisateurs voient la nouvelle IP
T = 6h     : 25% des utilisateurs
T = 12h    : 50% des utilisateurs
T = 24h    : 95% des utilisateurs
T = 48h    : 99%+ des utilisateurs

âš ï¸ Pendant 24-48h, trafic sur DEUX IPs !
```

### StratÃ©gie de TTL adaptatif

**Configuration optimale selon le contexte :**

```
Phase normale (production stable) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TTL = 3600s (1 heure)              â”‚
â”‚ â€¢ Bon compromis                    â”‚
â”‚ â€¢ Performances optimales           â”‚
â”‚ â€¢ FlexibilitÃ© raisonnable          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phase de prÃ©paration de migration (J-7) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TTL = 300s (5 minutes)             â”‚
â”‚ â€¢ Permet changement rapide         â”‚
â”‚ â€¢ Cache se vide rapidement         â”‚
â”‚ â€¢ PrÃªt pour le changement          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Jour de migration (J) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TTL = 60-300s                      â”‚
â”‚ â€¢ Changement d'IP effectuÃ©         â”‚
â”‚ â€¢ Propagation en 5-15 minutes      â”‚
â”‚ â€¢ Rollback possible si problÃ¨me    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AprÃ¨s migration stable (J+1) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TTL = 3600s (retour Ã  la normale)  â”‚
â”‚ â€¢ Migration terminÃ©e               â”‚
â”‚ â€¢ Optimisation des performances    â”‚
â”‚ â€¢ RÃ©duction de la charge DNS       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Propagation des changements DNS

### Timeline de propagation

Quand vous changez un enregistrement DNS, la propagation n'est **pas instantanÃ©e** :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Changement DNS : www.example.com                         â”‚
â”‚ Ancienne IP : 93.184.216.34                              â”‚
â”‚ Nouvelle IP : 93.184.216.50                              â”‚
â”‚ TTL actuel : 3600s (1 heure)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T = -1 heure (prÃ©paration) :
â”œâ”€ RÃ©duire TTL Ã  300s (5 minutes)
â””â”€ Attendre que l'ancien TTL expire

T = 0 (changement) :
â”œâ”€ Modifier l'IP sur le serveur autoritaire
â””â”€ www.example.com â†’ 93.184.216.50

T = +1 minute :
â”œâ”€ Serveur autoritaire : nouvelle IP âœ“
â”œâ”€ RÃ©solveurs : ancienne IP (en cache)
â””â”€ Clients : ancienne IP (en cache)
â””â”€ ~0% voient la nouvelle IP

T = +5 minutes :
â”œâ”€ RÃ©solveurs : commencent Ã  demander Ã  nouveau
â”œâ”€ Nouveaux clients : nouvelle IP âœ“
â”œâ”€ Anciens clients : dÃ©pend de leur cache local
â””â”€ ~20-30% voient la nouvelle IP

T = +15 minutes :
â”œâ”€ MajoritÃ© des rÃ©solveurs Ã  jour
â”œâ”€ Caches navigateurs en cours d'expiration
â””â”€ ~70-80% voient la nouvelle IP

T = +30 minutes :
â”œâ”€ Quasi tous les rÃ©solveurs Ã  jour
â””â”€ ~95% voient la nouvelle IP

T = +1 heure :
â”œâ”€ Propagation complÃ¨te
â””â”€ ~99%+ voient la nouvelle IP

T = +1 jour :
â”œâ”€ Remonter TTL Ã  3600s (optimisation)
â””â”€ 100% Ã  jour
```

### Facteurs affectant la propagation

```
1. TTL du record
   â””â”€ Principal facteur : Plus court = propagation plus rapide

2. Caches Ã  diffÃ©rents niveaux
   â”œâ”€ Navigateur (peut ignorer TTL court)
   â”œâ”€ OS (respecte gÃ©nÃ©ralement TTL)
   â”œâ”€ Routeur/Box (variable)
   â””â”€ RÃ©solveur rÃ©cursif (respecte TTL)

3. Comportement des rÃ©solveurs
   â”œâ”€ Certains "rafraÃ®chissent" avant expiration
   â”œâ”€ D'autres attendent l'expiration complÃ¨te
   â””â”€ PrÃ©fetching peut accÃ©lÃ©rer

4. Traffic patterns
   â”œâ”€ Sites Ã  fort trafic : propagation rapide
   â””â”€ Sites Ã  faible trafic : propagation lente

5. GÃ©ographie
   â”œâ”€ RÃ©solveurs proches : rapide
   â””â”€ RÃ©solveurs Ã©loignÃ©s : plus lent
```

### Pire scÃ©nario de propagation

```
Configuration maximisant le temps de propagation :

1. TTL initial : 86400s (24h)
2. Changement immÃ©diat sans prÃ©paration
3. Certains clients ont mis en cache 1 seconde avant le changement

Timeline :
â”œâ”€ T = 0 : Changement effectuÃ©
â”œâ”€ Client A (cache frais) : Voit ancienne IP pendant 24h
â”œâ”€ Client B (cache expirÃ©) : Voit nouvelle IP immÃ©diatement
â””â”€ Divergence maximale : 24-48h

ConsÃ©quences :
âœ— Trafic sur deux IPs simultanÃ©ment (24h+)
âœ— ProblÃ¨mes de session/cookies
âœ— DonnÃ©es dÃ©synchronisÃ©es
âœ— ExpÃ©rience utilisateur incohÃ©rente
```

## Visualiser et manipuler le cache

### Voir le cache - Navigateur

**Chrome/Chromium :**
```
1. Ouvrir : chrome://net-internals/#dns

2. Affichage :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Host name              â”‚ Expiration    â”‚ TTL        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ www.google.com         â”‚ In 145s       â”‚ 300        â”‚
â”‚ www.example.com        â”‚ In 2845s      â”‚ 3600       â”‚
â”‚ api.github.com         â”‚ Expired       â”‚ -          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. Vider le cache :
   [Clear host cache]
```

**Firefox :**
```
1. Ouvrir : about:networking#dns

2. Affichage :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hostname          â”‚ Address         â”‚ Expiry        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ www.mozilla.org   â”‚ 34.117.59.81    â”‚ 127s          â”‚
â”‚ www.reddit.com    â”‚ 151.101.1.140   â”‚ 58s           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Voir le cache - SystÃ¨me d'exploitation

**Windows :**
```powershell
# Afficher le cache DNS
ipconfig /displaydns

# RÃ©sultat :
www.example.com
----------------------------------------
Record Name . . . . . : www.example.com
Record Type . . . . . : 1 (A)
Time To Live  . . . . : 2145
Data Length . . . . . : 4
Section . . . . . . . : Answer
A (Host) Record . . . : 93.184.216.34

# Vider le cache DNS
ipconfig /flushdns
```

**Linux (systemd-resolved) :**
```bash
# Afficher statistiques du cache
sudo systemd-resolve --statistics

# RÃ©sultat :
DNSSEC supported by current servers: no

Transactions
Current Transactions: 0
Total Transactions: 3847

Cache
Current Cache Size: 142
Cache Hits: 2891
Cache Misses: 956

# Vider le cache
sudo systemd-resolve --flush-caches
```

**macOS :**
```bash
# Vider le cache DNS
sudo dscacheutil -flushcache
sudo killall -HUP mDNSResponder

# Voir les logs DNS (en temps rÃ©el)
sudo log stream --predicate 'process == "mDNSResponder"' --info
```

### Voir le cache - RÃ©solveur rÃ©cursif

Pour les rÃ©solveurs que vous contrÃ´lez (BIND, Unbound) :

**BIND :**
```bash
# Dumper le cache dans un fichier
rndc dumpdb -cache

# Voir le fichier de cache
cat /var/cache/bind/named_dump.db

# RÃ©sultat (extrait) :
; Start view _default cache dump
www.example.com.        2847    IN A    93.184.216.34
www.google.com.         147     IN A    142.250.185.196
api.github.com.         3421    IN A    140.82.121.6
```

**Unbound :**
```bash
# Voir une entrÃ©e spÃ©cifique du cache
unbound-control lookup www.example.com

# Vider tout le cache
unbound-control flush_zone .

# Vider un domaine spÃ©cifique
unbound-control flush www.example.com
```

### Forcer l'ignorance du cache avec dig

```bash
# RequÃªte normale (peut utiliser le cache du rÃ©solveur)
dig www.example.com @8.8.8.8

# Contourner le cache : interroger directement l'autoritaire
dig www.example.com @ns1.example.com

# Forcer le bit RD=0 (pas de rÃ©cursion, donc pas de cache)
dig www.example.com @8.8.8.8 +norecurse
```

## Cache DNS et performance web

### Impact mesurable sur les temps de chargement

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chargement de page typique (www.example.com)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ AVEC CACHE (warm) :                                  â”‚
â”‚ 0-10ms    : RÃ©solution DNS (cache)                   â”‚
â”‚ 50ms      : Connexion TCP                            â”‚
â”‚ 80ms      : Handshake TLS                            â”‚
â”‚ 20ms      : RequÃªte/RÃ©ponse HTTP                     â”‚
â”‚ 500ms     : TÃ©lÃ©chargement contenu                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ Total : 660ms                                        â”‚
â”‚                                                      â”‚
â”‚ SANS CACHE (cold) :                                  â”‚
â”‚ 150ms     : RÃ©solution DNS (complÃ¨te)                â”‚
â”‚ 50ms      : Connexion TCP                            â”‚
â”‚ 80ms      : Handshake TLS                            â”‚
â”‚ 20ms      : RequÃªte/RÃ©ponse HTTP                     â”‚
â”‚ 500ms     : TÃ©lÃ©chargement contenu                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ Total : 800ms                                        â”‚
â”‚                                                      â”‚
â”‚ DiffÃ©rence : +140ms (+21% plus lent)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pages avec ressources multiples

Les pages modernes chargent des ressources depuis plusieurs domaines :

```
Page web typique :
â”œâ”€ HTML : www.example.com
â”œâ”€ CSS : cdn.example.com
â”œâ”€ JS : static.example.com
â”œâ”€ Images : images.example.com
â”œâ”€ Fonts : fonts.googleapis.com
â”œâ”€ Analytics : www.google-analytics.com
â”œâ”€ Ads : ads.doubleclick.net
â””â”€ API : api.example.com

Sans cache : 8 domaines Ã— 150ms = 1200ms de latence DNS
Avec cache : 8 domaines Ã— 10ms = 80ms de latence DNS

Ã‰conomie : 1120ms (93% plus rapide !)
```

### DNS Prefetching

Les navigateurs modernes peuvent prÃ©charger les rÃ©solutions DNS :

```html
<!-- DNS Prefetch dans le HTML -->
<link rel="dns-prefetch" href="//cdn.example.com">
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//www.google-analytics.com">

Effet :
â”œâ”€ Navigateur rÃ©sout ces DNS en arriÃ¨re-plan
â”œâ”€ Avant mÃªme que la ressource soit demandÃ©e
â””â”€ Gain : 50-150ms par domaine externe
```

**Exemple pratique :**
```
Sans DNS prefetch :
â”œâ”€ Page chargÃ©e (0ms)
â”œâ”€ DÃ©couvre <img src="//cdn.example.com/logo.png">
â”œâ”€ RÃ©solution DNS cdn.example.com (100ms)
â”œâ”€ TÃ©lÃ©chargement image (200ms)
â””â”€ Total : 300ms

Avec DNS prefetch :
â”œâ”€ Page en cours de chargement
â”œâ”€ Prefetch dÃ©marre rÃ©solution de cdn.example.com (parallÃ¨le)
â”œâ”€ DÃ©couvre <img src="//cdn.example.com/logo.png">
â”œâ”€ DNS dÃ©jÃ  rÃ©solu ! (0ms)
â”œâ”€ TÃ©lÃ©chargement image immÃ©diat (200ms)
â””â”€ Total : 200ms (33% plus rapide)
```

## SÃ©curitÃ© et cache DNS

### Cache Poisoning (Empoisonnement du cache)

Le **cache poisoning** est une attaque oÃ¹ l'attaquant insÃ¨re de fausses informations dans le cache DNS.

**Principe de l'attaque :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Attaque par empoisonnement de cache                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Client demande : www.bank.com
   â””â”€ RÃ©solveur envoie requÃªte au serveur autoritaire

2. Attaquant intercepte et envoie fausse rÃ©ponse AVANT la vraie
   â””â”€ www.bank.com â†’ 192.0.2.66 (serveur malveillant)
   â””â”€ Transaction ID devinÃ© ou bruteforcÃ©

3. RÃ©solveur reÃ§oit la fausse rÃ©ponse en premier
   â””â”€ Met en cache : www.bank.com â†’ 192.0.2.66 âœ—

4. Vraie rÃ©ponse arrive aprÃ¨s
   â””â”€ IgnorÃ©e (dÃ©jÃ  rÃ©pondu)

5. Pendant tout le TTL, les clients sont redirigÃ©s vers le serveur malveillant
   â””â”€ Phishing, vol de donnÃ©es, malware...

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RÃ©sultat : Cache "empoisonnÃ©"                        â”‚
â”‚ Impact : Tous les utilisateurs du rÃ©solveur affectÃ©s â”‚
â”‚ DurÃ©e : Jusqu'Ã  expiration du TTL                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Protections contre le cache poisoning

**1. Randomisation du port source**
```
Anciennes implÃ©mentations :
â””â”€ Port source fixe : 53
â””â”€ Facile Ã  deviner

ImplÃ©mentations modernes :
â””â”€ Port source alÃ©atoire : 32768-65535
â””â”€ Attaquant doit deviner port ET transaction ID
â””â”€ ComplexitÃ© : 65536 ports Ã— 65536 IDs = 4 milliards de combinaisons
```

**2. Randomisation du Transaction ID**
```
Transaction ID :
â”œâ”€ 16 bits (0-65535)
â”œâ”€ Doit Ãªtre unique et alÃ©atoire
â””â”€ Change Ã  chaque requÃªte

Ancien bug (Kaminsky Attack, 2008) :
â””â”€ IDs prÃ©visibles â†’ Attaque facilitÃ©e
```

**3. DNSSEC (DNS Security Extensions)**
```
DNSSEC ajoute :
â”œâ”€ Signatures cryptographiques
â”œâ”€ ChaÃ®ne de confiance (racine â†’ TLD â†’ domaine)
â””â”€ Validation de l'authenticitÃ©

Avec DNSSEC :
â”œâ”€ Fausse rÃ©ponse rejetÃ©e (signature invalide)
â”œâ”€ Seules les rÃ©ponses signÃ©es sont acceptÃ©es
â””â”€ Cache poisoning quasiment impossible
```

**4. DNS over TLS (DoT) et DNS over HTTPS (DoH)**
```
Chiffrement complet :
â”œâ”€ RequÃªtes et rÃ©ponses chiffrÃ©es
â”œâ”€ Impossible d'intercepter et modifier
â””â”€ Protection contre l'espionnage et la manipulation
```

### Negative Caching (cache nÃ©gatif)

Le cache ne stocke pas que les rÃ©ponses positives, mais aussi les **nÃ©gatives** (domaine n'existe pas) :

```
RequÃªte : nonexistent.example.com

RÃ©ponse :
â”œâ”€ Status : NXDOMAIN (domaine inexistant)
â”œâ”€ SOA record avec Minimum TTL : 3600s
â””â”€ "Ce domaine n'existe pas pendant 1 heure"

Cache nÃ©gatif :
â”œâ”€ nonexistent.example.com â†’ NXDOMAIN
â”œâ”€ TTL : 3600s
â””â”€ Ã‰vite de redemander pendant 1 heure

Avantages :
âœ“ RÃ©duit le trafic pour typos/erreurs
âœ“ ProtÃ¨ge contre les attaques par requÃªtes alÃ©atoires

InconvÃ©nients :
âœ— Si domaine crÃ©Ã© aprÃ¨s, invisible pendant TTL
```

**Exemple pratique :**
```
T = 0 : Client demande typo.example.com
        RÃ©ponse : NXDOMAIN, mis en cache (TTL: 1h)

T = 10min : Administrateur crÃ©e typo.example.com
            Enregistrement A : 93.184.216.34

T = 15min : Client redemande typo.example.com
            RÃ©ponse : NXDOMAIN (depuis le cache !)
            âœ— Nouveau domaine invisible

T = 1h : Cache nÃ©gatif expire
         Prochaine requÃªte voit le nouveau domaine âœ“
```

## Bonnes pratiques

### Configuration des TTL

```
âœ“ DO :
â”€â”€â”€â”€â”€
â€¢ TTL court (300s) avant une migration planifiÃ©e
â€¢ TTL standard (3600s) en production normale
â€¢ TTL long (86400s) pour records trÃ¨s stables (NS, SOA)
â€¢ RÃ©duire le TTL quelques jours AVANT un changement
â€¢ Documenter les raisons des TTL non standards

âœ— DON'T :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ TTL < 60s en production (charge excessive)
â€¢ TTL > 86400s (rigiditÃ© excessive)
â€¢ Changer le TTL au moment du changement d'IP
â€¢ TTL diffÃ©rents entre A et AAAA du mÃªme nom
â€¢ Oublier de remonter le TTL aprÃ¨s migration
```

### Planification d'un changement DNS

**Checklist pour une migration d'IP :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ J-7 : PrÃ©paration                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¡ Identifier tous les records concernÃ©s              â”‚
â”‚ â–¡ Noter les TTL actuels                              â”‚
â”‚ â–¡ RÃ©duire les TTL Ã  300s (5 minutes)                 â”‚
â”‚ â–¡ Documenter l'ancienne et nouvelle configuration    â”‚
â”‚ â–¡ PrÃ©parer plan de rollback                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ J-1 : VÃ©rification                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¡ Confirmer que le nouveau serveur fonctionne        â”‚
â”‚ â–¡ VÃ©rifier que TTL court est propagÃ©                 â”‚
â”‚ â–¡ Tester la nouvelle configuration (hosts file)      â”‚
â”‚ â–¡ PrÃ©parer monitoring accru                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ J : Migration                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¡ Changer les enregistrements DNS                    â”‚
â”‚ â–¡ VÃ©rifier sur serveur autoritaire (dig @ns1...)     â”‚
â”‚ â–¡ VÃ©rifier propagation (dig @8.8.8.8, @1.1.1.1)      â”‚
â”‚ â–¡ Monitorer trafic sur ANCIENNE et NOUVELLE IP       â”‚
â”‚ â–¡ Garder ancien serveur en ligne                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ J+1 : Stabilisation                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¡ VÃ©rifier que >95% du trafic est sur nouvelle IP    â”‚
â”‚ â–¡ VÃ©rifier absence d'erreurs                         â”‚
â”‚ â–¡ Si OK : Remonter TTL Ã  3600s                       â”‚
â”‚ â–¡ Si problÃ¨me : Rollback (retour ancienne IP)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ J+7 : Nettoyage                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¡ Ancien serveur peut Ãªtre Ã©teint                    â”‚
â”‚ â–¡ Documenter la migration                            â”‚
â”‚ â–¡ Retour d'expÃ©rience                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Monitoring du cache

```
MÃ©triques Ã  surveiller :

1. Cache Hit Rate
   â””â”€ % de requÃªtes rÃ©pondues depuis le cache
   â””â”€ Objectif : >85%

2. Cache Size
   â””â”€ Nombre d'entrÃ©es en cache
   â””â”€ Surveiller la croissance

3. Expiration Rate
   â””â”€ Nombre d'expirations par minute
   â””â”€ Pic = TTL courts ou fort trafic

4. Miss Rate
   â””â”€ % de requÃªtes nÃ©cessitant rÃ©solution complÃ¨te
   â””â”€ Pic = problÃ¨me ou nouveau trafic
```

### Gestion des caches multiples

Quand vous contrÃ´lez un rÃ©solveur rÃ©cursif :

```
Configuration optimale :

1. Taille du cache adaptÃ©e au trafic
   â””â”€ Formule approximative : 100 entrÃ©es par utilisateur actif

2. Prefetching intelligent
   â””â”€ RafraÃ®chir les entrÃ©es populaires avant expiration

3. Negative caching activÃ©
   â””â”€ Ã‰viter les requÃªtes rÃ©pÃ©tÃ©es pour domaines inexistants

4. Serve stale en cas de problÃ¨me
   â””â”€ Servir cache expirÃ© plutÃ´t que SERVFAIL
```

## Points clÃ©s Ã  retenir

ğŸ”‘ **Le cache DNS est essentiel pour les performances d'Internet**

ğŸ”‘ **Le TTL contrÃ´le combien de temps une rÃ©ponse peut Ãªtre mise en cache**

ğŸ”‘ **Cache existe Ã  plusieurs niveaux : application, OS, routeur, rÃ©solveur**

ğŸ”‘ **TTL court (300s) = flexibilitÃ©, TTL long (3600s+) = performance**

ğŸ”‘ **Les changements DNS ne sont jamais instantanÃ©s Ã  cause du cache**

ğŸ”‘ **RÃ©duire le TTL AVANT un changement, pas pendant**

ğŸ”‘ **Cache hit = 0-10ms, cache miss = 100-200ms (10-20Ã— plus lent)**

ğŸ”‘ **Negative caching empÃªche les requÃªtes rÃ©pÃ©tÃ©es pour domaines inexistants**

ğŸ”‘ **Cache poisoning est une menace sÃ©rieuse (protections : DNSSEC, DoT, DoH)**

ğŸ”‘ **Planifier les migrations DNS plusieurs jours Ã  l'avance**

---

## Ce que nous avons appris

Dans cette section, nous avons explorÃ© en dÃ©tail :

- âœ… Le fonctionnement du cache DNS Ã  plusieurs niveaux
- âœ… Le rÃ´le et le fonctionnement du TTL (Time To Live)
- âœ… Les stratÃ©gies de choix du TTL selon le contexte
- âœ… La propagation des changements DNS et ses dÃ©lais
- âœ… L'impact du cache sur les performances web
- âœ… Les outils pour visualiser et manipuler le cache
- âœ… Les aspects de sÃ©curitÃ© (cache poisoning, DNSSEC)
- âœ… Le negative caching et son utilitÃ©
- âœ… Les bonnes pratiques pour gÃ©rer le cache et les migrations
- âœ… Comment planifier correctement un changement DNS

## Conclusion du module DNS

Nous avons maintenant couvert l'ensemble du systÃ¨me DNS :
- Son architecture hiÃ©rarchique distribuÃ©e
- Les diffÃ©rents types d'enregistrements et leurs usages
- Les mÃ©canismes de rÃ©solution rÃ©cursive et itÃ©rative
- Le cache et le TTL qui rendent le tout performant

DNS est un systÃ¨me remarquablement Ã©lÃ©gant qui combine simplicitÃ© conceptuelle et efficacitÃ© pratique. Bien que conÃ§u dans les annÃ©es 1980, il continue de servir des milliards d'utilisateurs quotidiennement grÃ¢ce Ã  sa conception distribuÃ©e et son systÃ¨me de cache intelligent.

---

**Prochaine section : DHCP (Dynamic Host Configuration Protocol)** ğŸ‘‰

â­ï¸ [DHCP (Dynamic Host Configuration Protocol)](/05-couche-application/03-dhcp.md)
