ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 4.5.2 Format du segment TCP

## Introduction

Le segment TCP est l'unitÃ© de donnÃ©es de la couche Transport. Il est composÃ© d'un **en-tÃªte obligatoire** de 20 octets minimum, d'**options** facultatives (jusqu'Ã  40 octets), et des **donnÃ©es applicatives** (payload).

Comprendre la structure d'un segment TCP est essentiel pour :
- ğŸ” Analyser le trafic rÃ©seau (Wireshark, tcpdump)
- ğŸ› Diagnostiquer des problÃ¨mes de connexion
- âš¡ Optimiser les performances
- ğŸ›¡ï¸ DÃ©tecter des anomalies ou des attaques

Dans cette section, nous allons dissÃ©quer chaque champ de l'en-tÃªte TCP et comprendre son rÃ´le prÃ©cis.

## Vue d'ensemble du segment TCP

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         EN-TÃŠTE TCP (20-60 octets)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  En-tÃªte fixe (20 octets)             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Options (0-40 octets)                â”‚  â”‚
â”‚  â”‚  Facultatif                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         DONNÃ‰ES (0-65495 octets)            â”‚
â”‚         Payload applicatif                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Contraintes importantes** :
- Taille minimale d'un segment TCP : **20 octets** (en-tÃªte seul, sans donnÃ©es)
- Taille maximale thÃ©orique : **65 535 octets** (limitÃ©e par le champ Length d'IP)
- Taille maximale pratique : **~1460 octets de donnÃ©es** (MTU Ethernet - en-tÃªtes IP/TCP)

## Structure de l'en-tÃªte TCP (20 octets fixes)

Voici la structure complÃ¨te de l'en-tÃªte TCP sur 20 octets :

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Port Source          |       Port Destination        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        NumÃ©ro de SÃ©quence                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    NumÃ©ro d'Acquittement                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Offset|RÃ©s.|N|C|E|U|A|P|R|S|F|            FenÃªtre             |
|       |    |S|W|C|R|C|S|S|Y|I|                                |
|       |    | |R|E|G|K|H|T|N|N|                                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |       Pointeur Urgent         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options (0-40 octets)                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             DonnÃ©es                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

DÃ©coupons maintenant chaque champ en dÃ©tail.

## Champs de l'en-tÃªte TCP

### 1. Port Source (16 bits)

**Position** : Octets 0-1
**Taille** : 16 bits (2 octets)
**Valeur** : 0 Ã  65535

Le numÃ©ro de port de l'application **Ã©mettrice**.

```
Exemple : Navigateur web
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Port Source : 54321        â”‚  â† Port Ã©phÃ©mÃ¨re du navigateur
â”‚ Port Destination : 443     â”‚  â† HTTPS
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Exemple concret** :

```
Connexion de votre PC vers www.exemple.com :
- Votre PC choisit un port Ã©phÃ©mÃ¨re : 52847
- Le serveur web Ã©coute sur : 443 (HTTPS)

Segment envoyÃ© par votre PC :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Port Source      : 52847     â”‚
â”‚ Port Destination : 443       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Segment de rÃ©ponse du serveur :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Port Source      : 443       â”‚  â† InversÃ©
â”‚ Port Destination : 52847     â”‚  â† InversÃ©
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Port Destination (16 bits)

**Position** : Octets 2-3
**Taille** : 16 bits (2 octets)
**Valeur** : 0 Ã  65535

Le numÃ©ro de port de l'application **rÃ©ceptrice**.

```
Ports bien connus :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Port   â”‚    Service      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    20    â”‚  FTP (donnÃ©es)  â”‚
â”‚    21    â”‚  FTP (contrÃ´le) â”‚
â”‚    22    â”‚  SSH            â”‚
â”‚    23    â”‚  Telnet         â”‚
â”‚    25    â”‚  SMTP           â”‚
â”‚    80    â”‚  HTTP           â”‚
â”‚   443    â”‚  HTTPS          â”‚
â”‚  3306    â”‚  MySQL          â”‚
â”‚  5432    â”‚  PostgreSQL     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Identification d'une connexion** :

Une connexion TCP est identifiÃ©e de maniÃ¨re unique par un **quintuplet** :
```
(IP Source, Port Source, IP Destination, Port Destination, Protocole)

Exemple :
(192.168.1.10, 52847, 93.184.216.34, 443, TCP)
```

### 3. NumÃ©ro de SÃ©quence (32 bits)

**Position** : Octets 4-7
**Taille** : 32 bits (4 octets)
**Valeur** : 0 Ã  4 294 967 295 (2Â³Â² - 1)

Indique le **numÃ©ro du premier octet** de donnÃ©es dans ce segment.

```
Exemple : Envoi de "HELLO WORLD" (11 octets)

Segment 1 :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NumÃ©ro de SÃ©quence : 1000        â”‚
â”‚ DonnÃ©es : "HELLO " (6 octets)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Octets numÃ©rotÃ©s : 1000-1005

Segment 2 :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NumÃ©ro de SÃ©quence : 1006        â”‚
â”‚ DonnÃ©es : "WORLD" (5 octets)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Octets numÃ©rotÃ©s : 1006-1010
```

**Initialisation** : Le numÃ©ro de sÃ©quence initial (ISN - Initial Sequence Number) est choisi **alÃ©atoirement** lors du 3-way handshake pour des raisons de sÃ©curitÃ©.

```
Connexion Ã©tablie :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client envoie SYN : SEQ = 1234567890 (alÃ©atoire)
Serveur rÃ©pond : SEQ = 987654321 (diffÃ©rent, alÃ©atoire)

Pourquoi alÃ©atoire ?
â†’ Ã‰viter les attaques de prÃ©diction de sÃ©quence
â†’ EmpÃªcher la confusion avec d'anciennes connexions
```

**Cas particulier** : Pour un segment sans donnÃ©es (ACK pur, SYN, FIN), le numÃ©ro de sÃ©quence pointe sur le prochain octet Ã  envoyer.

### 4. NumÃ©ro d'Acquittement (32 bits)

**Position** : Octets 8-11
**Taille** : 32 bits (4 octets)
**Valeur** : 0 Ã  4 294 967 295

Indique le **prochain numÃ©ro de sÃ©quence attendu** (acquittement cumulatif).

```
Communication bidirectionnelle :

Client â†’ Serveur :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SEQ : 1000                         â”‚
â”‚ ACK : 5000 (j'attends l'octet 5000)â”‚
â”‚ DonnÃ©es : 100 octets               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Serveur â†’ Client :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SEQ : 5000                         â”‚
â”‚ ACK : 1100 (j'attends l'octet 1100)â”‚
â”‚ DonnÃ©es : 50 octets                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Important** :
- ACK = X signifie "J'ai bien reÃ§u tous les octets jusqu'Ã  X-1"
- Le champ ACK n'est valide que si le **flag ACK est activÃ©**

**Exemple dÃ©taillÃ©** :

```
Transfert de fichier :

Ã‰tape 1 : Serveur envoie octets 0-999
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SEQ : 0                 â”‚
â”‚ DonnÃ©es : 1000 octets   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰tape 2 : Client acquitte
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ACK : 1000              â”‚  â† "J'ai reÃ§u 0-999, j'attends 1000"
â”‚ Flag ACK : 1            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰tape 3 : Serveur envoie octets 1000-1999
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SEQ : 1000              â”‚
â”‚ DonnÃ©es : 1000 octets   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰tape 4 : Client acquitte
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ACK : 2000              â”‚  â† "J'ai reÃ§u 1000-1999, j'attends 2000"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. Data Offset (4 bits)

**Position** : Premier demi-octet de l'octet 12
**Taille** : 4 bits
**Valeur** : 5 Ã  15 (en mots de 32 bits)

Indique oÃ¹ commencent les donnÃ©es dans le segment, c'est-Ã -dire la **longueur de l'en-tÃªte TCP** en mots de 32 bits (4 octets).

```
Calcul de la taille de l'en-tÃªte :
Taille en octets = Data Offset Ã— 4

Valeurs possibles :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Data Offsetâ”‚ Taille en octetsâ”‚  Commentaire   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      5     â”‚      20         â”‚  Minimum       â”‚
â”‚      6     â”‚      24         â”‚  +4 options    â”‚
â”‚      7     â”‚      28         â”‚  +8 options    â”‚
â”‚     ...    â”‚     ...         â”‚                â”‚
â”‚     15     â”‚      60         â”‚  Maximum       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Exemple** :

```
Segment avec options MSS :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Data Offset : 6              â”‚  â† 6 Ã— 4 = 24 octets d'en-tÃªte
â”‚ En-tÃªte fixe : 20 octets     â”‚
â”‚ Options : 4 octets (MSS)     â”‚
â”‚ DonnÃ©es : commence Ã  l'octet 24
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Segment sans options :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Data Offset : 5              â”‚  â† 5 Ã— 4 = 20 octets
â”‚ En-tÃªte fixe : 20 octets     â”‚
â”‚ Options : 0 octets           â”‚
â”‚ DonnÃ©es : commence Ã  l'octet 20
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6. RÃ©servÃ© (3 bits)

**Position** : Bits suivants de l'octet 12
**Taille** : 3 bits
**Valeur** : Doivent Ãªtre Ã  0

RÃ©servÃ©s pour un usage futur. Toujours mis Ã  0 dans les implÃ©mentations actuelles.

### 7. Flags TCP (9 bits)

**Position** : Fin de l'octet 12 et octet 13
**Taille** : 9 bits (9 flags d'1 bit chacun)

Les flags contrÃ´lent le comportement du segment et l'Ã©tat de la connexion.

```
Flags (de gauche Ã  droite) :
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚ NS â”‚ CWRâ”‚ ECEâ”‚ URGâ”‚ ACKâ”‚ PSHâ”‚ RSTâ”‚ SYNâ”‚ FINâ”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
  9    8    7    6    5    4    3    2    1
```

#### 7.1 FIN (Finish) - Bit 1

Indique la **fin de transmission** de donnÃ©es par l'Ã©metteur.

```
Fermeture de connexion :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FIN : 1                  â”‚  "Je n'ai plus de donnÃ©es Ã  envoyer"
â”‚ ACK : 1                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.2 SYN (Synchronize) - Bit 2

UtilisÃ© pour **Ã©tablir une connexion** (synchronisation des numÃ©ros de sÃ©quence).

```
Premier segment d'une connexion (3-way handshake) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYN : 1                  â”‚  "Je veux Ã©tablir une connexion"
â”‚ SEQ : 1234567890         â”‚  "Mon numÃ©ro de sÃ©quence initial"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.3 RST (Reset) - Bit 3

RÃ©initialise brutalement la connexion (connexion **abandonnÃ©e**).

```
Situations typiques de RST :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Port fermÃ© (service non disponible)   â”‚
â”‚ â€¢ Erreur de protocole                   â”‚
â”‚ â€¢ Timeout de connexion                  â”‚
â”‚ â€¢ RÃ©initialisation par firewall         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Exemple :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RST : 1                  â”‚  "Connexion terminÃ©e anormalement"
â”‚ ACK : 1                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.4 PSH (Push) - Bit 4

Demande au rÃ©cepteur de **transmettre immÃ©diatement** les donnÃ©es Ã  l'application (sans attendre de remplir le buffer).

```
Exemple : Commande interactive (SSH, Telnet)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PSH : 1                  â”‚  "DÃ©livre ces donnÃ©es immÃ©diatement"
â”‚ ACK : 1                  â”‚
â”‚ DonnÃ©es : "ls -la"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.5 ACK (Acknowledgment) - Bit 5

Indique que le champ **NumÃ©ro d'Acquittement est valide**.

```
Presque tous les segments aprÃ¨s le SYN initial ont ACK=1

Segment typique :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ACK : 1                  â”‚  â† Le champ ACK number est valide
â”‚ NumÃ©ro ACK : 5000        â”‚  â† Ce champ a du sens
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.6 URG (Urgent) - Bit 6

Indique que le champ **Pointeur Urgent est valide** (donnÃ©es urgentes).

```
Rarement utilisÃ© aujourd'hui :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ URG : 1                  â”‚
â”‚ Pointeur Urgent : 10     â”‚  "Les 10 premiers octets sont urgents"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Usage historique : Interruption de processus (Ctrl+C)
```

#### 7.7 ECE (ECN-Echo) - Bit 7

Notification de **congestion explicite** (ECN - Explicit Congestion Notification).

```
Le routeur marque le paquet pour indiquer une congestion :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ECE : 1                  â”‚  "J'ai reÃ§u une notification de congestion"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.8 CWR (Congestion Window Reduced) - Bit 8

Confirmation que la **fenÃªtre de congestion a Ã©tÃ© rÃ©duite**.

```
RÃ©ponse Ã  ECE :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CWR : 1                  â”‚  "J'ai rÃ©duit ma fenÃªtre de congestion"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 7.9 NS (Nonce Sum) - Bit 9

Protection contre la dissimulation accidentelle ou malveillante de paquets marquÃ©s ECN.

**Combinaisons de flags courantes** :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Flags            â”‚          Signification          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SYN                â”‚ Demande de connexion            â”‚
â”‚ SYN + ACK          â”‚ Acceptation de connexion        â”‚
â”‚ ACK                â”‚ Acquittement (segment normal)   â”‚
â”‚ FIN + ACK          â”‚ Fermeture gracieuse             â”‚
â”‚ RST                â”‚ Fermeture brutale               â”‚
â”‚ RST + ACK          â”‚ Rejet de connexion              â”‚
â”‚ PSH + ACK          â”‚ DonnÃ©es Ã  transmettre vite      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8. FenÃªtre (Window) - 16 bits

**Position** : Octets 14-15
**Taille** : 16 bits (2 octets)
**Valeur** : 0 Ã  65 535 octets

Indique la **taille du buffer de rÃ©ception** disponible (contrÃ´le de flux).

```
Annonce de capacitÃ© :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Window : 65535           â”‚  "Je peux recevoir 64 Ko"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FenÃªtre rÃ©duite :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Window : 8192            â”‚  "Je ne peux recevoir que 8 Ko"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FenÃªtre nulle :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Window : 0               â”‚  "Stop ! Mon buffer est plein"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Limitation** : 65 535 octets maximum â†’ insuffisant pour les connexions Ã  haut dÃ©bit.

**Solution** : Option **Window Scale** (facteur multiplicateur jusqu'Ã  2Â³â° octets).

```
Sans Window Scale :
FenÃªtre max = 65 535 octets â‰ˆ 64 Ko

Avec Window Scale (facteur 8) :
FenÃªtre effective = 65 535 Ã— 2â¸ = 16 776 960 octets â‰ˆ 16 Mo
```

### 9. Checksum (16 bits)

**Position** : Octets 16-17
**Taille** : 16 bits (2 octets)

Somme de contrÃ´le pour **dÃ©tecter les erreurs** dans l'en-tÃªte et les donnÃ©es.

**Calcul** : Le checksum est calculÃ© sur :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Pseudo-en-tÃªte IP         â”‚
â”‚    - IP Source (4 octets)    â”‚
â”‚    - IP Dest (4 octets)      â”‚
â”‚    - Protocole (1 octet)     â”‚
â”‚    - Longueur TCP (2 octets) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. En-tÃªte TCP complet       â”‚
â”‚    (checksum = 0 au dÃ©part)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. DonnÃ©es                   â”‚
â”‚    (avec padding si impair)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  ComplÃ©ment Ã  1 de la somme
       â”‚
       â–¼
   Checksum 16 bits
```

**Exemple simplifiÃ©** :

```
Pseudo-en-tÃªte :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IP Src    : 192.168.1.10           â”‚
â”‚ IP Dst    : 93.184.216.34          â”‚
â”‚ Protocole : 6 (TCP)                â”‚
â”‚ Longueur  : 40 (20 en-tÃªte + 20 donnÃ©es)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

En-tÃªte TCP :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Port src  : 52847                  â”‚
â”‚ Port dst  : 443                    â”‚
â”‚ SEQ       : 1000                   â”‚
â”‚ ACK       : 5000                   â”‚
â”‚ ...                                â”‚
â”‚ Checksum  : 0x0000 (temporaire)    â”‚
â”‚ ...                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DonnÃ©es : "Hello" (20 octets avec padding)

â†’ Calcul de la somme
â†’ ComplÃ©ment Ã  1
â†’ Checksum = 0xA5C3 (exemple)
```

**VÃ©rification** :

```
RÃ©cepteur :
1. Recalcule le checksum
2. Compare avec le checksum reÃ§u
3. Si identique : âœ“ Segment valide
4. Si diffÃ©rent : âœ— Segment corrompu â†’ ignorÃ© (pas d'ACK)
```

### 10. Pointeur Urgent (16 bits)

**Position** : Octets 18-19
**Taille** : 16 bits (2 octets)
**Valeur** : Offset des donnÃ©es urgentes

UtilisÃ© uniquement si le **flag URG est activÃ©**. Indique oÃ¹ se terminent les donnÃ©es urgentes.

```
Segment avec donnÃ©es urgentes :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ URG : 1                            â”‚
â”‚ Pointeur Urgent : 5                â”‚
â”‚ DonnÃ©es : [URGENT][NORMAL...]      â”‚
â”‚            â†‘___5 octets urgents    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Note** : Rarement utilisÃ© dans les applications modernes.

## Options TCP (0-40 octets)

Les options permettent d'Ã©tendre les fonctionnalitÃ©s de TCP.

### Structure gÃ©nÃ©rale

```
Option :
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kind â”‚  Length  â”‚  Option Data    â”‚
â”‚(1 o.)â”‚ (1 o.)   â”‚  (variable)     â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Options principales

#### Option 0 : End of Option List (EOL)

Marque la **fin de la liste d'options**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚  0   â”‚  1 octet
â””â”€â”€â”€â”€â”€â”€â”˜
```

#### Option 1 : No Operation (NOP)

UtilisÃ©e pour l'**alignement** (padding) des options.

```
â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚  1   â”‚  1 octet
â””â”€â”€â”€â”€â”€â”€â”˜
```

#### Option 2 : Maximum Segment Size (MSS)

Indique la **taille maximale** des donnÃ©es que le rÃ©cepteur peut accepter dans un segment.

```
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2   â”‚  4   â”‚   MSS Value    â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Kind  Length  2 octets

Exemple :
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2   â”‚  4   â”‚     1460       â”‚  â† MSS = 1460 octets
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Calcul de MSS** :

```
MTU Ethernet standard = 1500 octets
- En-tÃªte IP (20 octets)
- En-tÃªte TCP (20 octets)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
= MSS de 1460 octets
```

**Exemple d'utilisation** :

```
3-way handshake avec nÃ©gociation MSS :

Client â†’ Serveur (SYN) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYN : 1                  â”‚
â”‚ Options : MSS = 1460     â”‚  "Je peux recevoir 1460 octets max"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Serveur â†’ Client (SYN-ACK) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYN : 1, ACK : 1         â”‚
â”‚ Options : MSS = 1460     â”‚  "Moi aussi"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RÃ©sultat : Les deux utilisent MSS = 1460
```

#### Option 3 : Window Scale

Multiplie la taille de fenÃªtre par un **facteur d'Ã©chelle** (2^scale).

```
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3   â”‚  3   â”‚   Shift    â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Kind  Length  1 octet

Exemple :
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3   â”‚  3   â”‚     7      â”‚  â† Facteur = 2^7 = 128
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Calcul de la fenÃªtre effective :
Window field = 65535
Window scale = 7
FenÃªtre effective = 65535 Ã— 2^7 = 8 388 480 octets â‰ˆ 8 Mo
```

#### Option 4 : SACK Permitted

Indique que l'hÃ´te supporte les **acquittements sÃ©lectifs** (Selective Acknowledgment).

```
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚  4   â”‚  2   â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
  Kind  Length
```

#### Option 5 : SACK (Selective Acknowledgment)

Permet d'acquitter des **blocs discontinus** de donnÃ©es.

```
Format :
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚  5   â”‚  N   â”‚ Left Edge  â”‚ Right Edge â”‚ ... â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
  Kind  Length  4 octets     4 octets

Exemple avec 2 blocs :
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5   â”‚  18  â”‚  1000  â”‚  1500  â”‚  2000  â”‚  2500  â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Signification :
"J'ai reÃ§u les octets 1000-1499 ET 2000-2499"
(mais il manque 1500-1999)
```

**UtilitÃ© de SACK** :

```
Sans SACK (acquittement cumulatif) :
ReÃ§u : [0-999] [MANQUE] [1500-1999] [2000-2499]
ACK = 1000
â†’ Doit retransmettre 1000-2499 (mÃªme ce qui est dÃ©jÃ  arrivÃ©)

Avec SACK :
ReÃ§u : [0-999] [MANQUE] [1500-1999] [2000-2499]
ACK = 1000, SACK = 1500-2000, 2000-2500
â†’ Retransmet seulement 1000-1499 âœ“
```

#### Option 8 : Timestamps

Permet de mesurer le **RTT** (Round-Trip Time) et protÃ¨ge contre les anciens segments.

```
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8   â”‚  10  â”‚  TS Value    â”‚  TS Echo     â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Kind  Length  4 octets       4 octets

Exemple :
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8   â”‚  10  â”‚  123456789   â”‚   987654321  â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Fonctionnement** :

```
Ã‰metteur (t=0) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TS Value : 1000          â”‚  â† Horloge locale
â”‚ TS Echo : 0              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RÃ©cepteur (t=50ms) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TS Value : 2000          â”‚  â† Sa propre horloge
â”‚ TS Echo : 1000           â”‚  â† Renvoie la valeur reÃ§ue
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰metteur (t=100ms) :
Calcul RTT = 100ms (temps Ã©coulÃ© depuis envoi de TS=1000)
```

### Exemple d'options multiples

```
Segment SYN avec plusieurs options :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Data Offset : 8 (32 octets d'en-tÃªte)    â”‚
â”‚                                          â”‚
â”‚ Options (12 octets) :                    â”‚
â”‚  [MSS] [NOP] [NOP] [SACK Permitted]      â”‚
â”‚  [Timestamps]                            â”‚
â”‚                                          â”‚
â”‚  DÃ©tail :                                â”‚
â”‚  02 04 05 B4  â† MSS = 1460 (0x05B4)      â”‚
â”‚  01           â† NOP (padding)            â”‚
â”‚  01           â† NOP (padding)            â”‚
â”‚  04 02        â† SACK Permitted           â”‚
â”‚  08 0A ...    â† Timestamps (10 octets)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Exemple complet de segment TCP

Analysons un segment TCP rÃ©el capturÃ© avec Wireshark :

```
Segment HTTP GET :

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ EN-TÃŠTE TCP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                   â”‚
â”‚ Port Source        : 54328 (0xD428)               â”‚
â”‚ Port Destination   : 80 (0x0050)                  â”‚
â”‚ NumÃ©ro de SÃ©quence : 2948572145 (0xAFB0DE71)      â”‚
â”‚ NumÃ©ro d'ACK       : 3827491847 (0xE3F0A287)      â”‚
â”‚ Data Offset        : 5 (20 octets)                â”‚
â”‚ Flags              : 0x018 (PSH, ACK)             â”‚
â”‚   â”‚ NS  : 0                                       â”‚
â”‚   â”‚ CWR : 0                                       â”‚
â”‚   â”‚ ECE : 0                                       â”‚
â”‚   â”‚ URG : 0                                       â”‚
â”‚   â”‚ ACK : 1  âœ“                                    â”‚
â”‚   â”‚ PSH : 1  âœ“                                    â”‚
â”‚   â”‚ RST : 0                                       â”‚
â”‚   â”‚ SYN : 0                                       â”‚
â”‚   â”‚ FIN : 0                                       â”‚
â”‚ Window Size        : 65535 (0xFFFF)               â”‚
â”‚ Checksum           : 0x8A3C [correct]             â”‚
â”‚ Urgent Pointer     : 0                            â”‚
â”‚                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DONNÃ‰ES (78 octets) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                   â”‚
â”‚ GET / HTTP/1.1\r\n                                â”‚
â”‚ Host: www.exemple.com\r\n                         â”‚
â”‚ User-Agent: Mozilla/5.0\r\n                       â”‚
â”‚ Accept: */*\r\n                                   â”‚
â”‚ \r\n                                              â”‚
â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Taille totale : 98 octets (20 en-tÃªte + 78 donnÃ©es)
```

**Analyse** :

```
1. Ports :
   - Source 54328 : Port Ã©phÃ©mÃ¨re du client
   - Destination 80 : HTTP standard

2. NumÃ©ros :
   - SEQ = 2948572145 : Position dans le flux clientâ†’serveur
   - ACK = 3827491847 : Prochain octet attendu du serveur

3. Flags :
   - ACK activÃ© : Acquittement valide
   - PSH activÃ© : "DÃ©livre immÃ©diatement cette requÃªte HTTP"

4. Window :
   - 65535 octets : Client peut recevoir 64 Ko

5. Checksum :
   - 0x8A3C : ValidÃ© par Wireshark [correct]
```

## Encapsulation complÃ¨te

Voici comment un segment TCP s'insÃ¨re dans un paquet IP, lui-mÃªme dans une trame Ethernet :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TRAME ETHERNET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                           â”‚
â”‚  En-tÃªte Ethernet (14 octets)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ MAC Dest | MAC Src | Type (0x0800 = IPv4)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PAQUET IP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â”‚  En-tÃªte IP (20 octets)                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ IP Src | IP Dst | Protocole (6=TCP) ...    â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SEGMENT TCP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚                                          â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  En-tÃªte TCP (20-60 octets)              â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Ports | SEQ | ACK | Flags ...     â”‚   â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚      â”‚   â”‚
â”‚  â”‚  â”‚                                          â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  DonnÃ©es applicatives (0-65495 octets)   â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ GET / HTTP/1.1 ...                â”‚   â”‚      â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚      â”‚   â”‚
â”‚  â”‚  â”‚                                          â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â”‚                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  Trailer Ethernet (4 octets FCS)                          â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Overhead total :
- Ethernet : 14 + 4 = 18 octets
- IP : 20 octets
- TCP : 20 octets minimum
= 58 octets minimum d'overhead pour 1 octet de donnÃ©e !
```

## Taille optimale des segments

### MTU et MSS

```
MTU (Maximum Transmission Unit) :
â””â”€ Taille maximale d'une trame sur le rÃ©seau
   â””â”€ Ethernet : 1500 octets (standard)

Calcul de MSS :
MTU        : 1500 octets
- IP       :   20 octets
- TCP      :   20 octets
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MSS        : 1460 octets â† Taille optimale des donnÃ©es TCP
```

### Path MTU Discovery

TCP peut dÃ©couvrir le **MTU le plus petit** sur le chemin rÃ©seau :

```
Processus :
1. Envoie des segments de 1500 octets avec Don't Fragment
2. Si trop gros â†’ Routeur renvoie ICMP "Fragmentation Needed"
3. RÃ©duit la taille et rÃ©essaie
4. Trouve le MTU optimal

Exemple :
Client â”€â”€1500â”€â”€> Routeur A â”€â”€1500â”€â”€> Routeur B â”€â”€1400â”€â”€> Serveur
                                        â”‚
                                    MTU=1400 !
                                        â”‚
Client <â”€ICMPâ”€â”€ Routeur B (Frag Needed, MTU=1400)
                                        â”‚
Client â”€â”€1400â”€â”€> â”€â”€ â”€â”€ â”€â”€ â”€â”€ â”€â”€> â”€â”€ â”€â”€> Serveur âœ“
```

## Analyse avec Wireshark

Dans Wireshark, voici comment se prÃ©sente l'analyse d'un segment TCP :

```
Frame 42: 98 bytes on wire, 98 bytes captured
Ethernet II
    Destination: 00:1a:2b:3c:4d:5e
    Source: aa:bb:cc:dd:ee:ff
    Type: IPv4 (0x0800)
Internet Protocol Version 4
    Source: 192.168.1.10
    Destination: 93.184.216.34
    Protocol: TCP (6)
Transmission Control Protocol
    Source Port: 54328
    Destination Port: 80
    Sequence number: 2948572145
    Acknowledgment number: 3827491847
    Header Length: 20 bytes (5)
    Flags: 0x018 (PSH, ACK)
        â”‚ 000. .... = Reserved: Not set
        â”‚ ...0 .... = Nonce: Not set
        â”‚ .... 0... = CWR: Not set
        â”‚ .... .0.. = ECN-Echo: Not set
        â”‚ .... ..0. = Urgent: Not set
        â”‚ .... ...1 = Acknowledgment: Set âœ“
        â”‚ .... 1... = Push: Set âœ“
        â”‚ ...0 .... = Reset: Not set
        â”‚ ..0. .... = Syn: Not set
        â”‚ .0.. .... = Fin: Not set
    Window size value: 65535
    Checksum: 0x8a3c [validation disabled]
    Urgent pointer: 0
[Timestamps]
    [Time since first frame: 1.234 seconds]
    [Time since previous frame: 0.005 seconds]

Data (78 bytes)
```

## Conclusion

Le format du segment TCP est Ã  la fois Ã©lÃ©gant et complexe. Chaque champ a un rÃ´le prÃ©cis dans la mise en Å“uvre des garanties de TCP :

**RÃ©capitulatif des champs essentiels** :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Champ          â”‚         Fonction               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ports               â”‚ Identification des applicationsâ”‚
â”‚ SEQ/ACK             â”‚ FiabilitÃ© et ordre             â”‚
â”‚ Data Offset         â”‚ Taille de l'en-tÃªte            â”‚
â”‚ Flags               â”‚ ContrÃ´le de l'Ã©tat             â”‚
â”‚ Window              â”‚ ContrÃ´le de flux               â”‚
â”‚ Checksum            â”‚ IntÃ©gritÃ© des donnÃ©es          â”‚
â”‚ Options             â”‚ FonctionnalitÃ©s Ã©tendues       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Points clÃ©s Ã  retenir** :

1. **En-tÃªte fixe** : 20 octets minimum avec tous les champs essentiels
2. **Options** : Jusqu'Ã  40 octets pour des fonctionnalitÃ©s avancÃ©es (MSS, Window Scale, SACK, Timestamps)
3. **Flags** : ContrÃ´lent le comportement (SYN, ACK, FIN, RST, PSH)
4. **NumÃ©rotation** : Chaque octet est numÃ©rotÃ© pour garantir fiabilitÃ© et ordre
5. **ContrÃ´le de flux** : FenÃªtre annoncÃ©e dynamiquement
6. **Checksum** : Protection contre les erreurs de transmission

Comprendre ce format est essentiel pour :
- ğŸ” Analyser des captures rÃ©seau
- ğŸ› Diagnostiquer des problÃ¨mes de connexion
- âš¡ Optimiser les performances TCP
- ğŸ›¡ï¸ DÃ©tecter des anomalies rÃ©seau

Dans la section suivante, nous verrons comment ces champs sont utilisÃ©s lors de l'**Ã©tablissement d'une connexion TCP** avec le fameux 3-way handshake.

---

**Prochaine section** : 4.5.3 Ã‰tablissement de connexion : le 3-way handshake

â­ï¸ [Ã‰tablissement de connexion : le 3-way handshake](/04-couche-transport/05.3-tcp-3way-handshake.md)
