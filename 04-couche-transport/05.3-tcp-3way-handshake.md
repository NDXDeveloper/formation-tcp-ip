ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 4.5.3 Ã‰tablissement de connexion : le 3-way handshake

## Introduction

Le **3-way handshake** (poignÃ©e de main Ã  trois voies) est le mÃ©canisme par lequel TCP Ã©tablit une connexion entre deux hÃ´tes. C'est l'une des procÃ©dures les plus emblÃ©matiques des rÃ©seaux informatiques et un Ã©lÃ©ment fondamental du fonctionnement de TCP.

Avant de pouvoir Ã©changer des donnÃ©es, TCP doit :
- âœ… VÃ©rifier que le destinataire est joignable et prÃªt Ã  communiquer
- âœ… Synchroniser les numÃ©ros de sÃ©quence initiaux des deux cÃ´tÃ©s
- âœ… NÃ©gocier les paramÃ¨tres de la connexion (MSS, Window Scale, SACK, etc.)
- âœ… Ã‰tablir un canal de communication bidirectionnel

Ce processus se dÃ©roule en **trois Ã©tapes**, d'oÃ¹ son nom.

## Pourquoi une phase d'Ã©tablissement ?

### Le problÃ¨me d'UDP

UDP envoie des datagrammes sans prÃ©paration :

```
Client UDP                          Serveur UDP
   |                                    |
   | Datagramme 1                       |
   |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  |
   |                                    |
   | Datagramme 2                       |
   |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  |

Aucune garantie :
- Le serveur existe-t-il ?
- Ã‰coute-t-il sur ce port ?
- Peut-il traiter les donnÃ©es ?
- Comment numÃ©roter les donnÃ©es ?
```

### La solution TCP

TCP Ã©tablit d'abord un "contrat" entre les deux parties :

```
Client TCP                          Serveur TCP
   |                                    |
   | "Bonjour, je veux communiquer"     |
   |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  |
   |                                    |
   | "OK, je suis prÃªt, parlons"        |
   |<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  |
   |                                    |
   | "Parfait, commenÃ§ons !"            |
   |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  |
   |                                    |
   | âœ“ Connexion Ã©tablie                |
   | Ã‰change de donnÃ©es...              |
```

## Les trois Ã©tapes du 3-way handshake

### Vue d'ensemble

```
Client                                      Serveur
  â”‚                                            â”‚
  â”‚  â‘  SYN                                    â”‚
  â”‚  SEQ=x                                     â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚
  â”‚                                            â”‚
  â”‚                        â‘¡ SYN-ACK          â”‚
  â”‚                        SEQ=y, ACK=x+1      â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
  â”‚                                            â”‚
  â”‚  â‘¢ ACK                                    â”‚
  â”‚  SEQ=x+1, ACK=y+1                          â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚
  â”‚                                            â”‚
  â”‚        ğŸ‰ CONNEXION Ã‰TABLIE ğŸ‰             â”‚
  â”‚                                            â”‚
  â”‚  DonnÃ©es                                   â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚
```

### Ã‰tape 1 : SYN (Client â†’ Serveur)

Le client envoie un segment avec le flag **SYN** activÃ© pour initier la connexion.

```
Segment SYN :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Port Source      : 54321 (Ã©phÃ©mÃ¨re)      â”‚
â”‚ Port Destination : 443 (HTTPS)           â”‚
â”‚ NumÃ©ro SEQ       : 1234567890 (alÃ©atoire)â”‚
â”‚ NumÃ©ro ACK       : 0 (non utilisÃ©)       â”‚
â”‚ Flags            : SYN = 1               â”‚
â”‚ Window Size      : 65535                 â”‚
â”‚ Options :                                â”‚
â”‚   - MSS = 1460                           â”‚
â”‚   - Window Scale = 7                     â”‚
â”‚   - SACK Permitted                       â”‚
â”‚   - Timestamps                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Signification** :
- "Je veux Ã©tablir une connexion"
- "Mon numÃ©ro de sÃ©quence initial est 1234567890"
- "Je peux recevoir des segments de 1460 octets maximum"
- "Je supporte SACK et Window Scale"

**Ã‰tat du client** : `SYN-SENT` (attente de rÃ©ponse)

### Ã‰tape 2 : SYN-ACK (Serveur â†’ Client)

Le serveur rÃ©pond avec les flags **SYN** et **ACK** activÃ©s.

```
Segment SYN-ACK :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Port Source      : 443 (HTTPS)           â”‚
â”‚ Port Destination : 54321                 â”‚
â”‚ NumÃ©ro SEQ       : 987654321 (alÃ©atoire) â”‚
â”‚ NumÃ©ro ACK       : 1234567891            â”‚  â† x+1
â”‚ Flags            : SYN = 1, ACK = 1      â”‚
â”‚ Window Size      : 65535                 â”‚
â”‚ Options :                                â”‚
â”‚   - MSS = 1460                           â”‚
â”‚   - Window Scale = 7                     â”‚
â”‚   - SACK Permitted                       â”‚
â”‚   - Timestamps                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Signification** :
- "J'accepte ta connexion" (SYN)
- "J'ai bien reÃ§u ton SYN, j'attends ton octet 1234567891" (ACK)
- "Mon numÃ©ro de sÃ©quence initial est 987654321"
- "Je supporte aussi MSS=1460, Window Scale et SACK"

**Ã‰tat du serveur** : `SYN-RECEIVED` (attente de confirmation finale)

### Ã‰tape 3 : ACK (Client â†’ Serveur)

Le client envoie un dernier ACK pour confirmer l'Ã©tablissement.

```
Segment ACK :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Port Source      : 54321                 â”‚
â”‚ Port Destination : 443                   â”‚
â”‚ NumÃ©ro SEQ       : 1234567891            â”‚  â† x+1
â”‚ NumÃ©ro ACK       : 987654322             â”‚  â† y+1
â”‚ Flags            : ACK = 1               â”‚
â”‚ Window Size      : 65535                 â”‚
â”‚ DonnÃ©es          : Peut contenir des     â”‚
â”‚                    donnÃ©es (optionnel)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Signification** :
- "J'ai bien reÃ§u ton SYN-ACK"
- "J'attends ton octet 987654322"
- "La connexion est Ã©tablie de mon cÃ´tÃ©"

**Ã‰tat final** :
- Client : `ESTABLISHED`
- Serveur : `ESTABLISHED` (dÃ¨s rÃ©ception de ce ACK)

## Diagramme temporel dÃ©taillÃ©

```
Temps    Client (192.168.1.10:54321)         Serveur (93.184.216.34:443)
  â”‚
  0      Ã‰tat: CLOSED                       Ã‰tat: LISTEN (Ã©coute sur port 443)
  â”‚         â”‚                                    â”‚
  â”‚         â”‚ â‘ â”€â”€â”€â”€â”€â”€â”€ SYN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚
  â”‚         â”‚ SEQ=1000                           â”‚
 10ms       â”‚ Flags: SYN                         â”‚
  â”‚         â”‚ Options: MSS=1460, WS=7            â”‚
  â”‚         â”‚                                    â”‚
  â”‚      Ã‰tat: SYN-SENT                      Ã‰tat: SYN-RECEIVED
  â”‚         â”‚                                    â”‚
  â”‚         â”‚ <â”€â”€â”€â”€â”€â”€ SYN-ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚ â‘¡
  â”‚         â”‚           SEQ=5000, ACK=1001       â”‚
 60ms       â”‚           Flags: SYN, ACK          â”‚
  â”‚         â”‚           Options: MSS=1460, WS=7  â”‚
  â”‚         â”‚                                    â”‚
  â”‚         â”‚ â‘¢â”€â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
  â”‚         â”‚ SEQ=1001, ACK=5001                 â”‚
 70ms       â”‚ Flags: ACK                         â”‚
  â”‚         â”‚                                    â”‚
  â”‚      Ã‰tat: ESTABLISHED                   Ã‰tat: ESTABLISHED
  â”‚         â”‚                                    â”‚
  â”‚         â”‚ âœ“ Connexion prÃªte !                â”‚
  â”‚         â”‚                                    â”‚
  â”‚         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€ DonnÃ©es â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚
 80ms       â”‚ SEQ=1001, ACK=5001                 â”‚
  â”‚         â”‚ "GET / HTTP/1.1..."                â”‚
```

**Observations importantes** :
- Total : **1 RTT** (Round-Trip Time) avant de pouvoir envoyer des donnÃ©es
- RTT dans cet exemple : 50 ms (10ms â†’ 60ms pour SYN-ACK)
- Les donnÃ©es peuvent Ãªtre envoyÃ©es immÃ©diatement aprÃ¨s le 3Ã¨me segment

## NumÃ©ros de sÃ©quence initiaux (ISN)

### Pourquoi des numÃ©ros alÃ©atoires ?

Les ISN ne commencent **pas Ã  0** mais sont choisis alÃ©atoirement pour des raisons de sÃ©curitÃ©.

```
Mauvaise approche (prÃ©visible) :
Connexion 1 : ISN = 0
Connexion 2 : ISN = 100
Connexion 3 : ISN = 200
â†’ Facile Ã  prÃ©dire ! ğŸš¨ VulnÃ©rabilitÃ©

Bonne approche (RFC 6528) :
Connexion 1 : ISN = 1234567890
Connexion 2 : ISN = 2847593012
Connexion 3 : ISN = 4829103847
â†’ ImprÃ©visible âœ“
```

### GÃ©nÃ©ration de l'ISN

MÃ©thode recommandÃ©e (RFC 6528) :

```
ISN = M + F(src_ip, src_port, dst_ip, dst_port, secret_key)

OÃ¹ :
- M : compteur qui augmente toutes les 4 Âµs
- F : fonction de hachage (MD5, SHA-256)
- secret_key : clÃ© secrÃ¨te de l'hÃ´te

RÃ©sultat : ISN imprÃ©visible et unique
```

### Pourquoi incrÃ©menter les numÃ©ros ?

```
Client envoie SYN avec SEQ=1000
                              â†“
Serveur rÃ©pond avec ACK=1001 (1000+1)
                              â†“
Pourquoi +1 ?
â†’ Le flag SYN "consomme" un numÃ©ro de sÃ©quence
â†’ MÃªme s'il ne contient pas de donnÃ©es applicatives
```

**RÃ¨gle** :
- **SYN consomme 1 numÃ©ro de sÃ©quence**
- **FIN consomme 1 numÃ©ro de sÃ©quence**
- **DonnÃ©es consomment N numÃ©ros** (N = nombre d'octets)
- **ACK pur ne consomme rien**

## NÃ©gociation des options

Le 3-way handshake est le moment idÃ©al pour nÃ©gocier les paramÃ¨tres de connexion.

### Option MSS (Maximum Segment Size)

```
Client annonce MSS=1460 :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "Je peux recevoir jusqu'Ã   â”‚
â”‚  1460 octets de donnÃ©es    â”‚
â”‚  par segment"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
Serveur annonce MSS=1460 :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "Moi aussi, 1460 octets    â”‚
â”‚  maximum"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
RÃ©sultat : Les deux utilisent MSS=1460
```

**Si les valeurs diffÃ¨rent** :

```
Client : MSS=1460
Serveur : MSS=1200
         â”‚
         â–¼
Client â†’ Serveur : segments de 1200 octets max
Serveur â†’ Client : segments de 1460 octets max

Chacun respecte la limite annoncÃ©e par l'autre
```

### Option Window Scale

Permet des fenÃªtres de rÃ©ception supÃ©rieures Ã  64 Ko.

```
Client propose Window Scale=7 :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Window field = 65535               â”‚
â”‚ Scale = 7                          â”‚
â”‚ FenÃªtre rÃ©elle = 65535 Ã— 2^7       â”‚
â”‚                = 8 388 480 octets  â”‚
â”‚                â‰ˆ 8 Mo              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Serveur accepte Window Scale=7 :
â†’ Les deux peuvent utiliser des fenÃªtres de plusieurs Mo
```

**Important** : Window Scale **ne peut Ãªtre nÃ©gociÃ© que pendant le handshake**. Impossible de l'activer plus tard.

### Option SACK Permitted

```
Client : "SACK Permitted"
Serveur : "SACK Permitted"
         â”‚
         â–¼
SACK activÃ© pour la connexion
â†’ Retransmissions plus efficaces
```

### Option Timestamps

```
Client envoie :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TS Value : 123456          â”‚
â”‚ TS Echo : 0                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Serveur rÃ©pond :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TS Value : 789012          â”‚
â”‚ TS Echo : 123456           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

BÃ©nÃ©fices :
- Mesure prÃ©cise du RTT
- Protection contre les anciens segments (PAWS)
```

## Exemple concret : Connexion HTTPS

Connexion d'un navigateur Ã  `https://www.exemple.com` :

```
Phase 1 : RÃ©solution DNS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
www.exemple.com â†’ 93.184.216.34

Phase 2 : 3-way handshake TCP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T=0ms    Client                           Serveur
         192.168.1.10:52847               93.184.216.34:443
         â”‚                                â”‚
         â”‚ â‘  SYN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚ SEQ=2847593012                 â”‚
         â”‚ MSS=1460, WS=7, SACK OK        â”‚
         â”‚                                â”‚
T=25ms   â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SYN-ACK â”€â”€â”€â”€ â”‚ â‘¡
         â”‚        SEQ=1928374650, ACK=2847593013
         â”‚        MSS=1460, WS=7, SACK OK â”‚
         â”‚                                â”‚
T=26ms   â”‚ â‘¢ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚ SEQ=2847593013, ACK=1928374651 â”‚
         â”‚                                â”‚
         â”‚ âœ“ Connexion TCP Ã©tablie        â”‚
         â”‚   Latence : 26ms (1 RTT)       â”‚

Phase 3 : TLS Handshake (sur connexion TCP)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T=26ms   â”‚ ClientHello â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
T=51ms   â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€ ServerHello, Cert â”€â”€ â”‚
T=52ms   â”‚ ClientKeyExchange â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚ ...                            â”‚
T=78ms   â”‚ âœ“ Connexion TLS Ã©tablie        â”‚
         â”‚   Latence additionnelle : 52ms â”‚

Phase 4 : RequÃªte HTTP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T=78ms   â”‚ GET / HTTP/1.1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
T=103ms  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€ HTTP/1.1 200 OK â”€â”€â”€â”€ â”‚
         â”‚                                â”‚
         Total : 103ms pour la premiÃ¨re page
```

**DÃ©composition de la latence** :
- DNS : ~10ms (non montrÃ©)
- TCP handshake : 26ms (1 RTT)
- TLS handshake : 52ms (2 RTT)
- RequÃªte HTTP : 25ms (1 RTT)
- **Total : ~103ms avant de voir la page**

## Capture Wireshark

Voici Ã  quoi ressemble un 3-way handshake dans Wireshark :

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Frame 1: Client â†’ Serveur [SYN]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Time: 0.000000
Source: 192.168.1.10
Destination: 93.184.216.34
Protocol: TCP
Info: 54321 â†’ 443 [SYN] Seq=0 Win=65535 Len=0 MSS=1460 SACK_PERM

Transmission Control Protocol
    Source Port: 54321
    Destination Port: 443
    Sequence number: 0 (relative)
    Sequence number (raw): 2847593012
    Acknowledgment number: 0
    Header Length: 32 bytes (8)
    Flags: 0x002 (SYN)
        .... .... .... ...0 = FIN: Not set
        .... .... .... ..1. = SYN: Set âœ“
        .... .... .... .0.. = RST: Not set
        .... .... .... 0... = PSH: Not set
        .... .... ...0 .... = ACK: Not set
        .... .... ..0. .... = URG: Not set
    Window size value: 65535
    Checksum: 0xb8c3 [correct]
    Options (12 bytes)
        Maximum segment size: 1460 bytes
        SACK permitted
        Timestamps: TSval=123456, TSecr=0
        No-Operation (NOP)
        Window scale: 7 (multiply by 128)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Frame 2: Serveur â†’ Client [SYN, ACK]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Time: 0.025314
Source: 93.184.216.34
Destination: 192.168.1.10
Protocol: TCP
Info: 443 â†’ 54321 [SYN, ACK] Seq=0 Ack=1 Win=65535 Len=0 MSS=1460

Transmission Control Protocol
    Source Port: 443
    Destination Port: 54321
    Sequence number: 0 (relative)
    Sequence number (raw): 1928374650
    Acknowledgment number: 1 (relative)
    Acknowledgment number (raw): 2847593013
    Header Length: 32 bytes (8)
    Flags: 0x012 (SYN, ACK)
        .... .... .... ...0 = FIN: Not set
        .... .... .... ..1. = SYN: Set âœ“
        .... .... .... .0.. = RST: Not set
        .... .... .... 0... = PSH: Not set
        .... .... ...1 .... = ACK: Set âœ“
        .... .... ..0. .... = URG: Not set
    Window size value: 65535
    Checksum: 0xd2a1 [correct]
    Options (12 bytes)
        Maximum segment size: 1460 bytes
        SACK permitted
        Timestamps: TSval=789012, TSecr=123456
        No-Operation (NOP)
        Window scale: 7 (multiply by 128)

[SEQ/ACK analysis]
    This is an ACK to the segment in frame: 1
    The RTT to ACK the segment was: 0.025314 seconds

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Frame 3: Client â†’ Serveur [ACK]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Time: 0.026102
Source: 192.168.1.10
Destination: 93.184.216.34
Protocol: TCP
Info: 54321 â†’ 443 [ACK] Seq=1 Ack=1 Win=524160 Len=0

Transmission Control Protocol
    Source Port: 54321
    Destination Port: 443
    Sequence number: 1 (relative)
    Sequence number (raw): 2847593013
    Acknowledgment number: 1 (relative)
    Acknowledgment number (raw): 1928374651
    Header Length: 20 bytes (5)
    Flags: 0x010 (ACK)
        .... .... .... ...0 = FIN: Not set
        .... .... .... ..0. = SYN: Not set
        .... .... .... .0.. = RST: Not set
        .... .... .... 0... = PSH: Not set
        .... .... ...1 .... = ACK: Set âœ“
        .... .... ..0. .... = URG: Not set
    Window size value: 4095
    Window size scaling factor: 128
    Calculated window size: 524160
    Checksum: 0x7c92 [correct]

[SEQ/ACK analysis]
    This is an ACK to the segment in frame: 2
    The RTT to ACK the segment was: 0.000788 seconds

[TCP Analysis Flags]
    âœ“ This is a TCP 3-Way Handshake completion (ACK)
    âœ“ Connection established in frame: 3
```

## Cas particuliers et variations

### 1. Simultaneous Open

Rare mais possible : les deux hÃ´tes envoient un SYN simultanÃ©ment.

```
Client A                          Client B
   â”‚                                  â”‚
   â”‚ SYN (SEQ=100) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SYN (SEQ=200) â”‚
   â”‚                                  â”‚
   â”‚ SYN-ACK (SEQ=100, ACK=201) â”€â”€â”€â”€> â”‚
   â”‚<â”€â”€â”€â”€ SYN-ACK (SEQ=200, ACK=101)  â”‚
   â”‚                                  â”‚
   â”‚          4-way handshake         â”‚
   â”‚     (au lieu de 3-way normal)    â”‚
```

**RÃ©sultat** : Une seule connexion est Ã©tablie, pas deux. Les deux hÃ´tes finissent en Ã©tat `ESTABLISHED`.

### 2. SYN avec donnÃ©es (TCP Fast Open)

RFC 7413 permet d'envoyer des donnÃ©es dÃ¨s le SYN.

```
Handshake traditionnel (3 segments avant donnÃ©es) :
SYN â†’ SYN-ACK â†’ ACK â†’ DonnÃ©es
Latence : 1.5 RTT avant les donnÃ©es

TCP Fast Open (donnÃ©es avec SYN) :
SYN+DonnÃ©es â†’ SYN-ACK+DonnÃ©es â†’ ACK
Latence : 0.5 RTT avant les donnÃ©es

Gain : 1 RTT Ã©conomisÃ© ! âš¡
```

**Activation** :

```
Client (premier handshake) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYN                          â”‚
â”‚ Option: Fast Open Cookie Req â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
Serveur rÃ©pond :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYN-ACK                      â”‚
â”‚ Option: Fast Open Cookie     â”‚
â”‚         = 0xABCDEF123456     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
Client (connexions suivantes) :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYN                          â”‚
â”‚ Option: Cookie=0xABCDEF123456â”‚
â”‚ DonnÃ©es: "GET / HTTP/1.1..." â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Port fermÃ© (connexion refusÃ©e)

Si le serveur n'Ã©coute pas sur le port demandÃ© :

```
Client                          Serveur
   â”‚                               â”‚
   â”‚ SYN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
   â”‚                               â”‚ Port 8080 fermÃ©
   â”‚                               â”‚
   â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RST, ACK â”€â”€â”€â”€  â”‚
   â”‚                               â”‚
   â”‚ Connexion refusÃ©e             â”‚
```

**Segment RST** :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RST : 1                      â”‚
â”‚ ACK : 1                      â”‚
â”‚ ACK number = SEQ+1 du client â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Message d'erreur applicatif :
"Connection refused" (errno 111 sous Linux)
```

### 4. Firewall qui drop les paquets

Si un firewall bloque le SYN :

```
Client                    Firewall              Serveur
   â”‚                         â”‚                     â”‚
   â”‚ SYN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ ğŸš«                  â”‚
   â”‚                         â”‚ DROP                â”‚
   â”‚                         â”‚                     â”‚
   â”‚ [Attente...]            â”‚                     â”‚
   â”‚ Timeout (3s)            â”‚                     â”‚
   â”‚                         â”‚                     â”‚
   â”‚ Retransmission SYN â”€â”€â”€â”€>â”‚ ğŸš«                  â”‚
   â”‚                         â”‚ DROP                â”‚
   â”‚                         â”‚                     â”‚
   â”‚ [Attente...]            â”‚                     â”‚
   â”‚ Timeout (6s)            â”‚                     â”‚
   â”‚                         â”‚                     â”‚
   â”‚ Retransmission SYN â”€â”€â”€â”€>â”‚ ğŸš«                  â”‚
   â”‚                         â”‚ DROP                â”‚
   â”‚                         â”‚                     â”‚
   â”‚ Abandon aprÃ¨s ~75s      â”‚                     â”‚

Message d'erreur :
"Connection timed out" (errno 110)
```

## Timeouts et retransmissions

### Timer SYN

Le client attend la rÃ©ponse SYN-ACK avec un timer.

```
Configuration typique (Linux) :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1re tentative : t=0s    (timeout 1s)
2e tentative  : t=1s    (timeout 2s)
3e tentative  : t=3s    (timeout 4s)
4e tentative  : t=7s    (timeout 8s)
5e tentative  : t=15s   (timeout 16s)
6e tentative  : t=31s   (timeout 32s)

Abandon total : aprÃ¨s 63s
```

**Configuration Linux** :

```bash
# Nombre de retransmissions SYN
cat /proc/sys/net/ipv4/tcp_syn_retries
5

# Timeout total â‰ˆ 63 secondes avec 5 retries
```

### Timer SYN-ACK (cÃ´tÃ© serveur)

```
Configuration typique :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1re tentative : t=0s    (timeout 1s)
2e tentative  : t=1s    (timeout 2s)
3e tentative  : t=3s    (timeout 4s)
4e tentative  : t=7s    (timeout 8s)
5e tentative  : t=15s   (timeout 16s)

Abandon : aprÃ¨s 31s
```

**Configuration Linux** :

```bash
# Nombre de retransmissions SYN-ACK
cat /proc/sys/net/ipv4/tcp_synack_retries
5
```

## Backlog et file d'attente

Le serveur maintient deux files d'attente pour les connexions :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SERVEUR TCP                         â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  SYN Queue (Semi-open connections)     â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”             â”‚      â”‚
â”‚  â”‚  â”‚ SYN â”‚  â”‚ SYN â”‚  â”‚ SYN â”‚  ...        â”‚      â”‚
â”‚  â”‚  â”‚RCVD â”‚  â”‚RCVD â”‚  â”‚RCVD â”‚             â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜             â”‚      â”‚
â”‚  â”‚  Taille: tcp_max_syn_backlog           â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚              â†“ (aprÃ¨s ACK final)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Accept Queue (Established)            â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”          â”‚      â”‚
â”‚  â”‚  â”‚ESTABLâ”‚  â”‚ESTABLâ”‚  â”‚ESTABLâ”‚  ...     â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜          â”‚      â”‚
â”‚  â”‚  Taille: listen(backlog)               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚              â†“ accept()                          â”‚
â”‚         Application                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DÃ©bordement de la SYN queue** :

```
ScÃ©nario : Attaque SYN flood ou trafic lÃ©gitime intense

Si SYN queue pleine :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Nouveau SYN arrive         â”‚
â”‚        â†“                   â”‚
â”‚ SYN queue pleine           â”‚
â”‚        â†“                   â”‚
â”‚ Options :                  â”‚
â”‚ 1. DROP le SYN (dÃ©faut)    â”‚
â”‚ 2. SYN Cookies             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## SYN Cookies (protection contre SYN flood)

MÃ©canisme pour Ã©viter l'Ã©puisement de la SYN queue.

### Principe

```
Sans SYN Cookies (vulnÃ©rable) :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. SYN reÃ§u â†’ Stocker l'Ã©tat dans SYN queue
2. SYN-ACK envoyÃ©
3. ACK reÃ§u â†’ TransfÃ©rer vers Accept queue

ProblÃ¨me : SYN queue peut saturer (attaque)


Avec SYN Cookies (rÃ©silient) :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. SYN reÃ§u â†’ Ne PAS stocker l'Ã©tat
2. Calculer SEQ spÃ©cial = f(IP src, ports, timestamp)
3. SYN-ACK avec ce SEQ
4. ACK reÃ§u â†’ Recalculer et valider le SEQ
5. Si valide â†’ Reconstruire l'Ã©tat

Avantage : Pas de stockage, pas de limite !
```

### Calcul du SYN Cookie

```
SYN Cookie = hash(
    IP source,
    Port source,
    IP destination,
    Port destination,
    Timestamp,
    Secret key
) + MSS encoding

Exemple de SEQ gÃ©nÃ©rÃ© : 3847592847

Lors de l'ACK :
- Recalcul du cookie avec les mÃªmes paramÃ¨tres
- Comparaison avec ACK-1 reÃ§u
- Si match â†’ Connexion valide
```

**Activation sous Linux** :

```bash
# Activer SYN Cookies
sysctl -w net.ipv4.tcp_syncookies=1

# VÃ©rifier l'Ã©tat
cat /proc/sys/net/ipv4/tcp_syncookies
1
```

**Limitations** :
- âŒ Perte des options TCP (sauf MSS)
- âŒ Pas de Window Scale
- âŒ Pas de SACK
- âœ… Mais connexion possible mÃªme sous attaque

## Attaque SYN Flood

### Principe de l'attaque

```
Attaquant                           Serveur victime
    â”‚                                     â”‚
    â”‚ SYN (IP spoofÃ©e: 1.2.3.4)     â”Œâ”€â”€â”€â”€â”â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚Ã‰tatâ”‚â”‚ â† StockÃ©
    â”‚                               â””â”€â”€â”€â”€â”˜â”‚
    â”‚ SYN (IP spoofÃ©e: 5.6.7.8)     â”Œâ”€â”€â”€â”€â”â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚Ã‰tatâ”‚â”‚
    â”‚                               â””â”€â”€â”€â”€â”˜â”‚
    â”‚ SYN (IP spoofÃ©e: 9.10.11.12)  â”Œâ”€â”€â”€â”€â”â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚Ã‰tatâ”‚â”‚
    â”‚                               â””â”€â”€â”€â”€â”˜â”‚
    â”‚         ... (milliers) ...          â”‚
    â”‚                                     â”‚
    â”‚                          SYN queue  â”‚
    â”‚                          â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ â”‚ PLEINE
    â”‚                                     â”‚
Utilisateur lÃ©gitime                      â”‚
    â”‚ SYN                                 â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€X    â”‚
                                     â”‚
                            Connection refused
```

### SymptÃ´mes

```
Sur le serveur :
- CPU Ã©levÃ©
- MÃ©moire consommÃ©e par Ã©tats semi-ouverts
- Nouvelles connexions refusÃ©es
- Logs : "possible SYN flooding"

Commande de diagnostic :
netstat -an | grep SYN_RECV | wc -l
â†’ Nombre Ã©levÃ© (> 1000) = suspect

ss -tan state syn-recv | wc -l
â†’ Nombre de connexions en SYN-RECEIVED
```

### Contre-mesures

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DÃ‰FENSES CONTRE SYN FLOOD                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚ 1. SYN Cookies                                 â”‚
â”‚    â†’ Pas de stockage d'Ã©tat                    â”‚
â”‚                                                â”‚
â”‚ 2. Augmenter les backlogs                      â”‚
â”‚    â†’ Plus de capacitÃ© (temporaire)             â”‚
â”‚                                                â”‚
â”‚ 3. RÃ©duire timeout SYN-ACK                     â”‚
â”‚    â†’ LibÃ©rer les ressources plus vite          â”‚
â”‚                                                â”‚
â”‚ 4. Rate limiting                               â”‚
â”‚    â†’ Limiter SYN/sec par IP                    â”‚
â”‚                                                â”‚
â”‚ 5. Firewall / IDS                              â”‚
â”‚    â†’ Bloquer les IP suspectes                  â”‚
â”‚                                                â”‚
â”‚ 6. SYN Proxy (reverse proxy)                   â”‚
â”‚    â†’ Valider connexions avant backend          â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Performance et optimisation

### Impact du RTT

Le 3-way handshake introduit une latence incompressible de **1 RTT** avant de pouvoir transmettre des donnÃ©es.

```
RTT = 10 ms :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
t=0    : SYN â†’
t=5    : â† SYN-ACK
t=10   : ACK â†’
t=10   : DonnÃ©es possibles
Latence : 10 ms


RTT = 200 ms (intercontinental) :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
t=0    : SYN â†’
t=100  : â† SYN-ACK
t=200  : ACK â†’
t=200  : DonnÃ©es possibles
Latence : 200 ms âš ï¸
```

**Pour un site web** :

```
DNS : 1 RTT
TCP handshake : 1 RTT
TLS handshake : 2 RTT (TLS 1.2) ou 1 RTT (TLS 1.3)
HTTP request : 1 RTT

Total : 5 RTT (TLS 1.2) ou 4 RTT (TLS 1.3)

Avec RTT=200ms :
TLS 1.2 : 1000ms avant la page
TLS 1.3 : 800ms avant la page
```

### Optimisations modernes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TECHNIQUES D'OPTIMISATION                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚ â€¢ TCP Fast Open (TFO)                          â”‚
â”‚   â†’ DonnÃ©es avec SYN (Ã©conomie 1 RTT)          â”‚
â”‚                                                â”‚
â”‚ â€¢ TLS 1.3                                      â”‚
â”‚   â†’ 1-RTT handshake au lieu de 2-RTT           â”‚
â”‚                                                â”‚
â”‚ â€¢ HTTP/3 + QUIC                                â”‚
â”‚   â†’ 0-RTT possible (donnÃ©es avec 1er paquet)   â”‚
â”‚                                                â”‚
â”‚ â€¢ Connection pooling                           â”‚
â”‚   â†’ RÃ©utiliser connexions existantes           â”‚
â”‚                                                â”‚
â”‚ â€¢ CDN gÃ©ographiquement proche                  â”‚
â”‚   â†’ RÃ©duire le RTT physique                    â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Ã‰tats du client et du serveur

### Diagramme des transitions d'Ã©tats

```
Client :
â”€â”€â”€â”€â”€â”€â”€
CLOSED â†’ (envoie SYN) â†’ SYN-SENT â†’ (reÃ§oit SYN-ACK) â†’ ESTABLISHED


Serveur :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
CLOSED â†’ (listen) â†’ LISTEN â†’ (reÃ§oit SYN) â†’ SYN-RECEIVED
                                            â†’ (reÃ§oit ACK)
                                            â†’ ESTABLISHED
```

### Vue complÃ¨te du cycle

```
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ CLOSED  â”‚
                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                             â”‚
        listen()                      connect()
            â”‚                             â”‚
            â–¼                             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  LISTEN  â”‚                 â”‚  SYN-SENT  â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚                              â”‚
    reÃ§oit SYN                     reÃ§oit SYN-ACK
    envoie SYN-ACK                  envoie ACK
           â”‚                              â”‚
           â–¼                              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
    â”‚ SYN-RECEIVED â”‚                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
           â”‚                              â”‚
      reÃ§oit ACK                          â”‚
           â”‚                              â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  ESTABLISHED  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                 (donnÃ©es)
```

## Exemple de code (pseudo-code)

### CÃ´tÃ© serveur

```python
# Pseudo-code simplifiÃ©

# 1. CrÃ©er le socket
socket_fd = socket(AF_INET, SOCK_STREAM, 0)

# 2. Lier Ã  une adresse et un port
bind(socket_fd, address="0.0.0.0", port=443)

# 3. Passer en mode Ã©coute
listen(socket_fd, backlog=128)
# Ã‰tat: LISTEN

print("Serveur en Ã©coute sur port 443...")

while True:
    # 4. Accepter une connexion (bloquant)
    # Attend le 3-way handshake complet
    client_fd, client_addr = accept(socket_fd)
    # Ã‰tat: ESTABLISHED

    print(f"Connexion Ã©tablie avec {client_addr}")

    # 5. Communication
    data = recv(client_fd, 1024)
    send(client_fd, response_data)

    # 6. Fermeture
    close(client_fd)
```

### CÃ´tÃ© client

```python
# Pseudo-code simplifiÃ©

# 1. CrÃ©er le socket
socket_fd = socket(AF_INET, SOCK_STREAM, 0)

# 2. Initier connexion (3-way handshake automatique)
connect(socket_fd, address="93.184.216.34", port=443)
# Ã‰tat: SYN-SENT â†’ ESTABLISHED

print("Connexion Ã©tablie !")

# 3. Communication
send(socket_fd, request_data)
response = recv(socket_fd, 1024)

# 4. Fermeture
close(socket_fd)
```

**Note** : Le 3-way handshake est gÃ©rÃ© automatiquement par le kernel. L'appel Ã  `connect()` ne retourne que lorsque la connexion est en Ã©tat `ESTABLISHED`.

## DÃ©bogage et diagnostic

### Avec tcpdump

```bash
# Capturer uniquement les segments SYN
tcpdump -i eth0 'tcp[tcpflags] & tcp-syn != 0'

# Capturer le handshake complet vers un serveur
tcpdump -i eth0 -nn 'host 93.184.216.34 and tcp[tcpflags] & (tcp-syn|tcp-ack) != 0'

# Sortie :
# 10:30:45.123456 IP 192.168.1.10.54321 > 93.184.216.34.443: Flags [S], seq 1000
# 10:30:45.148770 IP 93.184.216.34.443 > 192.168.1.10.54321: Flags [S.], seq 5000, ack 1001
# 10:30:45.149558 IP 192.168.1.10.54321 > 93.184.216.34.443: Flags [.], ack 5001
```

### Avec ss (Socket Statistics)

```bash
# Voir les connexions en cours d'Ã©tablissement
ss -tan state syn-sent
ss -tan state syn-recv

# Statistiques globales
ss -s
Total: 1234
TCP:   890 (estab 456, closed 123, orphaned 0, timewait 45)
```

### Avec netstat

```bash
# Connexions TCP en SYN-SENT
netstat -an | grep SYN_SENT

# Connexions TCP en SYN-RECEIVED (serveur)
netstat -an | grep SYN_RECV

# Si beaucoup de SYN_RECV : possible SYN flood
```

## Conclusion

Le 3-way handshake TCP est un mÃ©canisme Ã©lÃ©gant qui :

**Garantit** :
- âœ… Les deux parties sont prÃªtes Ã  communiquer
- âœ… Les numÃ©ros de sÃ©quence sont synchronisÃ©s
- âœ… Les paramÃ¨tres de connexion sont nÃ©gociÃ©s
- âœ… La connexion est bidirectionnelle

**Au prix de** :
- â±ï¸ 1 RTT de latence avant la transmission de donnÃ©es
- ğŸ“¦ 3 segments rÃ©seau
- ğŸ’¾ Ressources maintenues en attente (vulnÃ©rable aux SYN flood)

**Points clÃ©s Ã  retenir** :

1. **Trois Ã©tapes** : SYN â†’ SYN-ACK â†’ ACK
2. **ISN alÃ©atoires** : SÃ©curitÃ© contre les attaques de prÃ©diction
3. **NÃ©gociation** : MSS, Window Scale, SACK s'Ã©changent pendant le handshake
4. **1 RTT de coÃ»t** : Incompressible, mais optimisable (TCP Fast Open)
5. **VulnÃ©rabilitÃ©s** : SYN flood â†’ SYN cookies en dÃ©fense
6. **Transparence** : GÃ©rÃ© automatiquement par le kernel

Le 3-way handshake est la fondation sur laquelle repose toute communication TCP fiable. Sa comprÃ©hension est essentielle pour diagnostiquer les problÃ¨mes de connexion, optimiser les performances et sÃ©curiser les infrastructures rÃ©seau.

Dans la prochaine section, nous verrons le processus inverse : la **fermeture de connexion** avec le 4-way handshake.

---

**Prochaine section** : 4.5.4 Fermeture de connexion : 4-way handshake

â­ï¸ [Fermeture de connexion : 4-way handshake](/04-couche-transport/05.4-tcp-4way-handshake.md)
