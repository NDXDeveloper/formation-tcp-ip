ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 4.5.10 Ã‰tats d'une connexion TCP (diagramme d'Ã©tats)

## Introduction

Une connexion TCP traverse plusieurs **Ã©tats** durant son cycle de vie, de l'Ã©tablissement Ã  la fermeture. Comprendre ces Ã©tats et leurs transitions est essentiel pour :

- ğŸ” Diagnostiquer les problÃ¨mes de connexion
- ğŸ› DÃ©boguer les applications rÃ©seau
- ğŸ“Š Monitorer l'Ã©tat du systÃ¨me
- ğŸ›¡ï¸ DÃ©tecter les anomalies et attaques
- âš¡ Optimiser les performances

```
Cycle de vie d'une connexion TCP :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CLOSED â†’ Ã‰tablissement â†’ ESTABLISHED â†’ Fermeture â†’ CLOSED
         (3-way)         (donnÃ©es)      (4-way)

Ã‰tats traversÃ©s :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client typique :
  CLOSED â†’ SYN-SENT â†’ ESTABLISHED â†’
  FIN-WAIT-1 â†’ FIN-WAIT-2 â†’ TIME-WAIT â†’ CLOSED

Serveur typique :
  CLOSED â†’ LISTEN â†’ SYN-RECEIVED â†’ ESTABLISHED â†’
  CLOSE-WAIT â†’ LAST-ACK â†’ CLOSED
```

## Vue d'ensemble des 11 Ã©tats

TCP dÃ©finit **11 Ã©tats** possibles pour une connexion :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ã‰TATS TCP (RFC 9293)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Ã‰tat               Phase        Qui        Description     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  1. CLOSED          Initial      Les deux   Aucune cnx      â”‚
â”‚  2. LISTEN          Serveur      Serveur    Ã‰coute          â”‚
â”‚  3. SYN-SENT        Ã‰tabl.       Client     SYN envoyÃ©      â”‚
â”‚  4. SYN-RECEIVED    Ã‰tabl.       Serveur    SYN reÃ§u        â”‚
â”‚  5. ESTABLISHED     DonnÃ©es      Les deux   Connexion OK    â”‚
â”‚  6. FIN-WAIT-1      Fermeture    Actif      FIN envoyÃ©      â”‚
â”‚  7. FIN-WAIT-2      Fermeture    Actif      ACK reÃ§u        â”‚
â”‚  8. CLOSE-WAIT      Fermeture    Passif     FIN reÃ§u        â”‚
â”‚  9. CLOSING         Fermeture    Les deux   FIN simultanÃ©s  â”‚
â”‚  10. LAST-ACK       Fermeture    Passif     FIN envoyÃ©      â”‚
â”‚  11. TIME-WAIT      Fermeture    Actif      Attente 2Ã—MSL   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Description dÃ©taillÃ©e des Ã©tats

### 1. CLOSED

**Ã‰tat initial et final** : Aucune connexion n'existe.

```
CaractÃ©ristiques :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Point de dÃ©part de toute connexion
â€¢ Point d'arrivÃ©e aprÃ¨s fermeture complÃ¨te
â€¢ Aucune ressource allouÃ©e
â€¢ Socket peut Ãªtre crÃ©Ã© mais non connectÃ©

Transitions depuis CLOSED :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â†’ LISTEN     : Application serveur appelle listen()
â†’ SYN-SENT   : Application client appelle connect()

Exemple :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Application vient de dÃ©marrer :
  socket() appelÃ© â†’ Socket crÃ©Ã©
  Ã‰tat : CLOSED (pas encore de connexion)
```

### 2. LISTEN

**Ã‰tat d'Ã©coute** : Le serveur attend des connexions entrantes.

```
CaractÃ©ristiques :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Passif (serveur seulement)
â€¢ Socket liÃ© Ã  un port spÃ©cifique
â€¢ Accepte les SYN entrants
â€¢ Peut gÃ©rer plusieurs connexions simultanÃ©es

EntrÃ©e :
â”€â”€â”€â”€â”€â”€â”€â”€
Application serveur :
  socket() â†’ bind() â†’ listen()

Transitions depuis LISTEN :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â†’ SYN-RECEIVED : SYN reÃ§u d'un client
â†’ CLOSED        : Application ferme le socket d'Ã©coute

Exemple :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Serveur web sur port 80 :

  fd = socket(AF_INET, SOCK_STREAM, 0);
  bind(fd, &addr, sizeof(addr));
  listen(fd, 128);  â† Ã‰tat: LISTEN

  // Serveur prÃªt Ã  accepter connexions
  while (1) {
    client = accept(fd, ...);  // Bloquant
  }
```

### 3. SYN-SENT

**Synchronisation envoyÃ©e** : Le client a envoyÃ© un SYN et attend la rÃ©ponse.

```
CaractÃ©ristiques :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Actif (client typiquement)
â€¢ Premier Ã©tat aprÃ¨s connect()
â€¢ Attente du SYN-ACK
â€¢ Timeout possible (plusieurs secondes)

EntrÃ©e :
â”€â”€â”€â”€â”€â”€â”€â”€
Application client :
  connect() â†’ Envoi SYN â†’ Ã‰tat: SYN-SENT

Transitions depuis SYN-SENT :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â†’ ESTABLISHED    : SYN-ACK reÃ§u, ACK envoyÃ©
â†’ SYN-RECEIVED   : SYN reÃ§u (simultaneous open)
â†’ CLOSED         : RST reÃ§u ou timeout

DurÃ©e typique :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1 RTT (~quelques ms Ã  quelques centaines de ms)
Si pas de rÃ©ponse : retries puis timeout (~75s)

Exemple :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client se connectant Ã  un serveur :

T=0ms   : connect() appelÃ©
          Ã‰tat: SYN-SENT
          SYN envoyÃ©

T=25ms  : SYN-ACK reÃ§u
          Ã‰tat: ESTABLISHED

DurÃ©e en SYN-SENT : 25ms âœ“
```

### 4. SYN-RECEIVED

**Synchronisation reÃ§ue** : Le serveur a reÃ§u un SYN et envoyÃ© un SYN-ACK.

```
CaractÃ©ristiques :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Passif (serveur typiquement)
â€¢ Ã‰tat intermÃ©diaire bref
â€¢ VulnÃ©rable aux attaques SYN flood
â€¢ Attente du ACK final

EntrÃ©e :
â”€â”€â”€â”€â”€â”€â”€â”€
Serveur en LISTEN reÃ§oit SYN :
  â†’ Envoi SYN-ACK
  â†’ Ã‰tat: SYN-RECEIVED

Transitions depuis SYN-RECEIVED :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â†’ ESTABLISHED : ACK reÃ§u (3-way handshake complet)
â†’ FIN-WAIT-1  : Application ferme prÃ©maturÃ©ment
â†’ LISTEN      : Timeout ou RST

DurÃ©e typique :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0.5 RTT (~quelques ms)

Exemple :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Serveur recevant une connexion :

T=0ms   : Ã‰tat: LISTEN
T=10ms  : SYN reÃ§u du client
          Ã‰tat: SYN-RECEIVED
          SYN-ACK envoyÃ©

T=35ms  : ACK reÃ§u
          Ã‰tat: ESTABLISHED

DurÃ©e en SYN-RECEIVED : 25ms âœ“
```

### 5. ESTABLISHED

**Connexion Ã©tablie** : Ã‰tat normal pour l'Ã©change de donnÃ©es.

```
CaractÃ©ristiques :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Ã‰tat productif (transmission de donnÃ©es)
â€¢ Les deux cÃ´tÃ©s peuvent envoyer et recevoir
â€¢ Peut durer de millisecondes Ã  des jours
â€¢ Ã‰tat le plus commun en production

EntrÃ©e :
â”€â”€â”€â”€â”€â”€â”€â”€
AprÃ¨s 3-way handshake complet

Transitions depuis ESTABLISHED :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â†’ FIN-WAIT-1   : Application locale appelle close()
â†’ CLOSE-WAIT   : FIN reÃ§u du distant
â†’ CLOSED       : RST reÃ§u (connexion brutale)

Exemple :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Transfert HTTP :

T=0ms    : Ã‰tat: ESTABLISHED
           (aprÃ¨s 3-way handshake)

T=1ms    : Client envoie GET /
T=25ms   : Serveur envoie rÃ©ponse HTTP
T=50ms   : DonnÃ©es transfÃ©rÃ©es
T=100ms  : Client appelle close()
           Ã‰tat: FIN-WAIT-1

DurÃ©e en ESTABLISHED : 100ms
(+ tout le temps de transfert)
```

### 6. FIN-WAIT-1

**Attente ACK du FIN** : L'application locale a fermÃ©, FIN envoyÃ©, attente de l'ACK.

```
CaractÃ©ristiques :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ CÃ´tÃ© actif (qui ferme en premier)
â€¢ FIN envoyÃ©, pas encore acquittÃ©
â€¢ Peut encore recevoir des donnÃ©es
â€¢ Ã‰tat transitoire normalement bref

EntrÃ©e :
â”€â”€â”€â”€â”€â”€â”€â”€
Application appelle close() depuis ESTABLISHED :
  â†’ Envoi FIN
  â†’ Ã‰tat: FIN-WAIT-1

Transitions depuis FIN-WAIT-1 :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â†’ FIN-WAIT-2 : ACK du FIN reÃ§u
â†’ CLOSING    : FIN reÃ§u (simultaneous close)
â†’ TIME-WAIT  : FIN+ACK reÃ§u simultanÃ©ment

DurÃ©e typique :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0.5 RTT (~quelques ms)

Exemple :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client ferme la connexion :

T=0ms   : close() appelÃ©
          Ã‰tat: FIN-WAIT-1
          FIN envoyÃ©

T=25ms  : ACK du FIN reÃ§u
          Ã‰tat: FIN-WAIT-2

DurÃ©e en FIN-WAIT-1 : 25ms âœ“
```

### 7. FIN-WAIT-2

**Attente FIN distant** : Le FIN local est acquittÃ©, attente du FIN du distant.

```
CaractÃ©ristiques :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ CÃ´tÃ© actif
â€¢ Direction locale â†’ distant fermÃ©e
â€¢ Direction distant â†’ local encore ouverte
â€¢ Peut recevoir des donnÃ©es
â€¢ Timeout aprÃ¨s tcp_fin_timeout (60s par dÃ©faut)

EntrÃ©e :
â”€â”€â”€â”€â”€â”€â”€â”€
Depuis FIN-WAIT-1 quand ACK du FIN reÃ§u

Transitions depuis FIN-WAIT-2 :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â†’ TIME-WAIT : FIN reÃ§u du distant
â†’ CLOSED    : Timeout (aprÃ¨s tcp_fin_timeout)

DurÃ©e typique :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Variable (dÃ©pend de l'application distante)
Quelques ms Ã  plusieurs secondes

ProblÃ¨me potentiel :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Si le distant ne ferme jamais :
â†’ Reste en FIN-WAIT-2 jusqu'au timeout
â†’ "Half-open" connection

Exemple :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client attend que le serveur ferme :

T=0ms   : Ã‰tat: FIN-WAIT-2
          (ACK du FIN reÃ§u)

T=0-50ms: Serveur envoie derniÃ¨res donnÃ©es
          Client les reÃ§oit encore âœ“

T=50ms  : Serveur envoie FIN

T=75ms  : FIN reÃ§u
          Ã‰tat: TIME-WAIT

DurÃ©e en FIN-WAIT-2 : 75ms
```

### 8. CLOSE-WAIT

**Attente que l'application ferme** : Le FIN distant est reÃ§u, l'application doit fermer.

```
CaractÃ©ristiques :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ CÃ´tÃ© passif (qui reÃ§oit FIN en premier)
â€¢ Direction distant â†’ local fermÃ©e
â€¢ Direction local â†’ distant encore ouverte
â€¢ Peut encore envoyer des donnÃ©es
â€¢ L'APPLICATION doit appeler close()

EntrÃ©e :
â”€â”€â”€â”€â”€â”€â”€â”€
FIN reÃ§u depuis ESTABLISHED :
  â†’ ACK du FIN envoyÃ©
  â†’ Ã‰tat: CLOSE-WAIT

Transitions depuis CLOSE-WAIT :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â†’ LAST-ACK : Application appelle close()

DurÃ©e typique :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Variable (dÃ©pend de l'application)
Devrait Ãªtre court (millisecondes)

ProblÃ¨me MAJEUR :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Si l'application ne ferme JAMAIS :
â†’ Connexion reste en CLOSE-WAIT indÃ©finiment
â†’ Fuite de ressources ! ğŸ’€
â†’ Bug applicatif

Exemple correct :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Serveur reÃ§oit FIN du client :

T=0ms   : FIN reÃ§u
          Ã‰tat: CLOSE-WAIT
          ACK envoyÃ©

          recv() retourne 0 (EOF)

T=1ms   : Application dÃ©tecte EOF
          Traite les derniÃ¨res donnÃ©es

T=5ms   : Application appelle close()
          Ã‰tat: LAST-ACK
          FIN envoyÃ©

DurÃ©e en CLOSE-WAIT : 5ms âœ“


Exemple buguÃ© :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T=0ms   : FIN reÃ§u
          Ã‰tat: CLOSE-WAIT

          recv() retourne 0

          âš ï¸ Application IGNORE l'EOF
          âš ï¸ Ne ferme JAMAIS le socket

T=âˆ     : Ã‰tat: CLOSE-WAIT (bloquÃ©)

Fuite de socket ! ğŸ’€
```

### 9. CLOSING

**Fermeture simultanÃ©e** : Les deux cÃ´tÃ©s envoient FIN en mÃªme temps (rare).

```
CaractÃ©ristiques :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Cas rare (< 1% des connexions)
â€¢ Fermeture simultanÃ©e des deux cÃ´tÃ©s
â€¢ Attente du ACK du FIN local
â€¢ Ã‰tat transitoire trÃ¨s bref

EntrÃ©e :
â”€â”€â”€â”€â”€â”€â”€â”€
Depuis FIN-WAIT-1 :
  â†’ FIN reÃ§u avant ACK du FIN local

Transitions depuis CLOSING :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â†’ TIME-WAIT : ACK du FIN local reÃ§u

DurÃ©e typique :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0.5 RTT (~quelques ms)

Exemple :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Fermeture simultanÃ©e :

Client                    Serveur
   â”‚                         â”‚
T=0â”‚ close()                 â”‚ close()
   â”‚ Ã‰tat: FIN-WAIT-1        â”‚ Ã‰tat: FIN-WAIT-1
   â”‚                         â”‚
   â”‚ â”€â”€â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FIN â”€â”€â”€â”‚
   â”‚                         â”‚
   â”‚ FIN reÃ§u avant ACK !    â”‚ FIN reÃ§u avant ACK !
   â”‚ Ã‰tat: CLOSING           â”‚ Ã‰tat: CLOSING
   â”‚                         â”‚
   â”‚ â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”‚
   â”‚                         â”‚
   â”‚ Ã‰tat: TIME-WAIT         â”‚ Ã‰tat: TIME-WAIT
```

### 10. LAST-ACK

**Dernier acquittement** : Le FIN local est envoyÃ©, attente de son ACK.

```
CaractÃ©ristiques :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ CÃ´tÃ© passif
â€¢ Dernier Ã©tat avant fermeture complÃ¨te
â€¢ Attente du ACK final
â€¢ Ã‰tat transitoire bref

EntrÃ©e :
â”€â”€â”€â”€â”€â”€â”€â”€
Depuis CLOSE-WAIT :
  â†’ Application appelle close()
  â†’ FIN envoyÃ©
  â†’ Ã‰tat: LAST-ACK

Transitions depuis LAST-ACK :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â†’ CLOSED : ACK du FIN reÃ§u

DurÃ©e typique :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0.5 RTT (~quelques ms)

Exemple :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Serveur ferme aprÃ¨s avoir reÃ§u FIN :

T=0ms   : Ã‰tat: CLOSE-WAIT
T=5ms   : Application appelle close()
          Ã‰tat: LAST-ACK
          FIN envoyÃ©

T=30ms  : ACK du FIN reÃ§u
          Ã‰tat: CLOSED âœ“

DurÃ©e en LAST-ACK : 25ms
```

### 11. TIME-WAIT

**Attente de sÃ©curitÃ©** : Attente de 2Ã—MSL avant fermeture dÃ©finitive.

```
CaractÃ©ristiques :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ CÃ´tÃ© actif (qui ferme en premier)
â€¢ DurÃ©e fixe : 2 Ã— MSL (60-120s)
â€¢ Permet retransmission du dernier ACK
â€¢ Ã‰vite confusion avec anciennes connexions
â€¢ Consomme des ressources (problÃ©matique)

EntrÃ©e :
â”€â”€â”€â”€â”€â”€â”€â”€
Depuis FIN-WAIT-2 :
  â†’ FIN reÃ§u
  â†’ ACK envoyÃ©
  â†’ Ã‰tat: TIME-WAIT

Ou depuis CLOSING :
  â†’ ACK du FIN reÃ§u
  â†’ Ã‰tat: TIME-WAIT

Transitions depuis TIME-WAIT :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â†’ CLOSED : AprÃ¨s 2Ã—MSL (timeout)

DurÃ©e :
â”€â”€â”€â”€â”€â”€â”€
2 Ã— MSL = 60-120 secondes (configurable)
Linux : 60 secondes par dÃ©faut

Pourquoi 2Ã—MSL ?
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MSL 1 : Temps pour que le ACK final arrive
MSL 2 : Temps pour que le FIN retransmis arrive

ProblÃ¨me en production :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Serveur haute charge :
  10 000 req/s Ã— 60s = 600 000 connexions TIME-WAIT !
  â†’ Ã‰puisement des ports
  â†’ Ã‰puisement mÃ©moire

Exemple :
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Client ferme la connexion :

T=0ms   : FIN reÃ§u du serveur
          ACK envoyÃ©
          Ã‰tat: TIME-WAIT
          DÃ©marre timer 60s

T=0-60s : Attente...
          Socket consomme ressources
          Port non rÃ©utilisable

T=60s   : Timer expire
          Ã‰tat: CLOSED âœ“
          Ressources libÃ©rÃ©es
```

## Diagramme d'Ã©tats complet

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ CLOSED  â”‚ â† Ã‰tat initial/final
                         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                                â”‚
           listen()                        connect()
              â”‚                             envoie SYN
              â–¼                                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â–¼
        â”‚  LISTEN  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                    â”‚  SYN-SENT  â”‚
             â”‚                          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        reÃ§oit SYN                            â”‚
        envoie SYN-ACK                  reÃ§oit SYN-ACK
             â”‚                          envoie ACK
             â–¼                                â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
      â”‚ SYN-RECEIVED â”‚                        â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
             â”‚                                â”‚
        reÃ§oit ACK                            â”‚
             â”‚                                â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  ESTABLISHED  â”‚ â† Ã‰tat de donnÃ©es
                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                  â”‚
      close()                           reÃ§oit FIN
      envoie FIN                        envoie ACK
          â”‚                                  â”‚
          â–¼                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ FIN-WAIT-1 â”‚                    â”‚ CLOSE-WAIT â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚                                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       close()
    â”‚            â”‚              â”‚       envoie FIN
reÃ§oit ACK  reÃ§oit FIN  reÃ§oit FIN+ACK      â”‚
    â”‚            â”‚              â”‚           â–¼
    â–¼            â–¼              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚     â”‚ LAST-ACK  â”‚
â”‚ FIN-WAIT-2 â”‚ â”‚ CLOSING â”‚      â”‚     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â”‚           â”‚
      â”‚             â”‚           â”‚      reÃ§oit ACK
 reÃ§oit FIN    reÃ§oit ACK       â”‚           â”‚
      â”‚             â”‚           â”‚           â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
             â–¼                              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
       â”‚ TIME-WAIT  â”‚                       â”‚
       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚
             â”‚                              â”‚
        Timeout 2Ã—MSL                       â”‚
             â”‚                              â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ CLOSED  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Parcours d'Ã©tats typiques

### ScÃ©nario 1 : Client-Serveur normal

```
CLIENT                              SERVEUR
â”€â”€â”€â”€â”€â”€                              â”€â”€â”€â”€â”€â”€â”€

CLOSED                              CLOSED
                                       â†“
                                   listen()
                                       â†“
                                    LISTEN
   â†“                                   â”‚
connect()                              â”‚
   â†“                                   â”‚
envoie SYN                             â”‚
   â†“                                   â”‚
SYN-SENT â”€â”€â”€â”€â”€â”€â”€ SYN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> LISTEN
   â”‚                                   â†“
   â”‚                              reÃ§oit SYN
   â”‚                              envoie SYN-ACK
   â”‚                                   â†“
   â”‚                             SYN-RECEIVED
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€ SYN-ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
   â”‚                                   â”‚
reÃ§oit SYN-ACK                         â”‚
envoie ACK                             â”‚
   â”‚                                   â”‚
   â†“                                   â”‚
ESTABLISHED â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> SYN-RECEIVED
   â”‚                                   â†“
   â”‚                              reÃ§oit ACK
   â”‚                                   â†“
   â”‚                             ESTABLISHED
   â”‚<â•â•â•â•â•â•â• DonnÃ©es â•â•â•â•â•â•â•â•â•â•â•â•â•â•>   â”‚
   â”‚                                   â”‚
close()                                â”‚
envoie FIN                             â”‚
   â”‚                                   â”‚
   â†“                                   â”‚
FIN-WAIT-1 â”€â”€â”€â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> ESTABLISHED
   â”‚                                   â†“
   â”‚                              reÃ§oit FIN
   â”‚                              envoie ACK
   â”‚                                   â†“
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CLOSE-WAIT
   â”‚                                   â”‚
   â†“                              (app traite)
FIN-WAIT-2                             â”‚
   â”‚                              (app close)
   â”‚                              envoie FIN
   â”‚                                   â†“
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LAST-ACK
   â”‚                                   â”‚
reÃ§oit FIN                             â”‚
envoie ACK                             â”‚
   â”‚                                   â”‚
   â†“                                   â”‚
TIME-WAIT â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> LAST-ACK
   â”‚                                   â†“
   â”‚                              reÃ§oit ACK
   â”‚                                   â†“
(attend 60s)                        CLOSED âœ“
   â”‚
   â†“
CLOSED âœ“

DurÃ©e totale client : ~60 secondes (TIME-WAIT)
DurÃ©e totale serveur : ~100 ms (sans TIME-WAIT)
```

### ScÃ©nario 2 : Simultaneous Open (rare)

```
CLIENT A                            CLIENT B
â”€â”€â”€â”€â”€â”€â”€â”€                            â”€â”€â”€â”€â”€â”€â”€â”€

CLOSED                              CLOSED
   â†“                                   â†“
connect()                          connect()
envoie SYN                         envoie SYN
   â†“                                   â†“
SYN-SENT â”€â”€â”€â”€â”€â”€â”€ SYN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> SYN-SENT
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€ SYN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
   â”‚                                â”‚
reÃ§oit SYN                     reÃ§oit SYN
envoie SYN-ACK                 envoie SYN-ACK
   â”‚                                â”‚
   â†“                                â†“
SYN-RECEIVED                   SYN-RECEIVED
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€ SYN-ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€ SYN-ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
   â”‚                                â”‚
reÃ§oit SYN-ACK                reÃ§oit SYN-ACK
   â”‚                                â”‚
   â†“                                â†“
ESTABLISHED                    ESTABLISHED

RÃ©sultat : UNE seule connexion Ã©tablie âœ“
(pas deux connexions distinctes)
```

### ScÃ©nario 3 : Simultaneous Close (rare)

```
CLIENT                              SERVEUR
â”€â”€â”€â”€â”€â”€                              â”€â”€â”€â”€â”€â”€â”€

ESTABLISHED                         ESTABLISHED
   â”‚                                   â”‚
close()                            close()
envoie FIN                         envoie FIN
   â”‚                                   â”‚
   â†“                                   â†“
FIN-WAIT-1 â”€â”€â”€â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> FIN-WAIT-1
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
   â”‚                                â”‚
reÃ§oit FIN                     reÃ§oit FIN
envoie ACK                     envoie ACK
   â”‚                                â”‚
   â†“                                â†“
CLOSING â”€â”€â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> CLOSING
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
   â”‚                                â”‚
reÃ§oit ACK                     reÃ§oit ACK
   â”‚                                â”‚
   â†“                                â†“
TIME-WAIT                       TIME-WAIT
   â”‚                                â”‚
(attend 60s)                   (attend 60s)
   â”‚                                â”‚
   â†“                                â†“
CLOSED                          CLOSED

Les DEUX passent en TIME-WAIT !
```

### ScÃ©nario 4 : RST (fermeture brutale)

```
CLIENT                              SERVEUR
â”€â”€â”€â”€â”€â”€                              â”€â”€â”€â”€â”€â”€â”€

ESTABLISHED                         ESTABLISHED
   â”‚                                   â”‚
   â”‚ SO_LINGER = 0                     â”‚
   â”‚ close()                           â”‚
   â”‚ â†’ envoie RST (pas FIN)            â”‚
   â”‚                                   â”‚
   â†“                                   â”‚
CLOSED â”€â”€â”€â”€â”€â”€â”€ RST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> ESTABLISHED
(immÃ©diat)                             â†“
                                  reÃ§oit RST
                                       â†“
                                    CLOSED
                                  (immÃ©diat)

Pas de TIME-WAIT ! âœ“
Mais donnÃ©es peuvent Ãªtre perdues âŒ
```

## Diagnostic des Ã©tats

### Commandes systÃ¨me

```bash
# Voir tous les Ã©tats TCP
ss -tan

# Sortie exemple :
State      Recv-Q Send-Q Local Address:Port  Peer Address:Port
LISTEN     0      128    0.0.0.0:80          0.0.0.0:*
LISTEN     0      128    0.0.0.0:443         0.0.0.0:*
ESTAB      0      0      192.168.1.10:54321  93.184.216.34:443
TIME-WAIT  0      0      192.168.1.10:54322  93.184.216.34:443
CLOSE-WAIT 0      0      192.168.1.10:54323  93.184.216.34:443


# Filtrer par Ã©tat
ss -tan state established
ss -tan state time-wait
ss -tan state close-wait
ss -tan state fin-wait-1
ss -tan state fin-wait-2


# Compter les connexions par Ã©tat
ss -tan | awk '{print $1}' | sort | uniq -c

# Sortie exemple :
#    2 CLOSE-WAIT
#   10 ESTAB
#    5 FIN-WAIT-2
#  100 LISTEN
#   50 TIME-WAIT


# Statistiques globales
ss -s

# Sortie exemple :
# Total: 1234
# TCP:   890 (estab 456, closed 123, orphaned 0,
#             timewait 45, ports 0)
#
# Transport Total     IP        IPv6
# TCP       767       567       200
# ...


# Netstat (ancien mais encore utile)
netstat -tan

# MÃªme format que ss mais plus lent
```

### Filtres avancÃ©s

```bash
# Connexions Ã©tablies sur port 443
ss -tan state established '( dport = :443 or sport = :443 )'

# Connexions TIME-WAIT vers IP spÃ©cifique
ss -tan state time-wait dst 93.184.216.34

# Connexions CLOSE-WAIT (souvent problÃ©matiques)
ss -tan state close-wait

# Connexions en cours d'Ã©tablissement
ss -tan state syn-sent
ss -tan state syn-recv

# Connexions en cours de fermeture
ss -tan state fin-wait-1
ss -tan state fin-wait-2
ss -tan state closing
ss -tan state last-ack
```

### Monitoring continu

```bash
# Surveillance en temps rÃ©el
watch -n 1 'ss -tan | head -20'

# Alerter si trop de CLOSE-WAIT
while true; do
  count=$(ss -tan state close-wait | wc -l)
  if [ $count -gt 100 ]; then
    echo "ALERTE: $count connexions CLOSE-WAIT !" | mail admin
  fi
  sleep 60
done

# Script de monitoring complet
#!/bin/bash
echo "=== Ã‰tat TCP $(date) ==="
echo "LISTEN:      $(ss -tan state listen | wc -l)"
echo "SYN-SENT:    $(ss -tan state syn-sent | wc -l)"
echo "SYN-RECV:    $(ss -tan state syn-recv | wc -l)"
echo "ESTABLISHED: $(ss -tan state established | wc -l)"
echo "FIN-WAIT-1:  $(ss -tan state fin-wait-1 | wc -l)"
echo "FIN-WAIT-2:  $(ss -tan state fin-wait-2 | wc -l)"
echo "CLOSE-WAIT:  $(ss -tan state close-wait | wc -l)"
echo "CLOSING:     $(ss -tan state closing | wc -l)"
echo "LAST-ACK:    $(ss -tan state last-ack | wc -l)"
echo "TIME-WAIT:   $(ss -tan state time-wait | wc -l)"
```

## ProblÃ¨mes courants liÃ©s aux Ã©tats

### ProblÃ¨me 1 : Trop de CLOSE-WAIT

```
SymptÃ´me :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ss -tan state close-wait | wc -l
5000  â† Beaucoup trop !

Cause :
â”€â”€â”€â”€â”€â”€â”€
Bug applicatif : L'application ne ferme pas les sockets
aprÃ¨s avoir reÃ§u FIN (EOF)

Code buguÃ© :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
while (1) {
    n = recv(sock, buf, sizeof(buf), 0);
    if (n == 0) {
        // EOF reÃ§u â†’ connexion en CLOSE-WAIT
        printf("Connexion fermÃ©e\n");
        // âš ï¸ Mais ne ferme PAS le socket !
        // BUG : devrait faire close(sock) ici
        continue;  // Continue la boucle !
    }
    process(buf, n);
}
// â†’ Socket reste en CLOSE-WAIT indÃ©finiment

Diagnostic :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Identifier le processus responsable
ss -tanp state close-wait

# Sortie :
# CLOSE-WAIT  users:(("myapp",pid=1234,fd=10))

# Tuer le processus (temporaire)
kill 1234

# Solution permanente : Corriger le code
if (n == 0) {
    close(sock);  // â† AJOUTER CECI
    break;
}

Impact :
â”€â”€â”€â”€â”€â”€â”€â”€
âŒ Fuite de descripteurs de fichiers
âŒ Ã‰puisement des ressources
âŒ Processus peut crasher (too many open files)
âŒ Performance dÃ©gradÃ©e
```

### ProblÃ¨me 2 : Trop de TIME-WAIT

```
SymptÃ´me :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ss -tan state time-wait | wc -l
50000  â† Ã‰norme !

Cause :
â”€â”€â”€â”€â”€â”€â”€
Serveur Ã  forte charge avec connexions courtes
(ex: HTTP/1.0 sans keep-alive)

Calcul :
â”€â”€â”€â”€â”€â”€â”€â”€
10 000 req/s Ã— 60s TIME-WAIT = 600 000 connexions !

Impact :
â”€â”€â”€â”€â”€â”€â”€â”€
âŒ Ã‰puisement des ports (max ~64k)
âŒ MÃ©moire consommÃ©e (~4 Ko par socket)
âŒ CPU pour gÃ©rer les connexions
âŒ Nouvelles connexions refusÃ©es

Solutions :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. tcp_tw_reuse (cÃ´tÃ© client) :
   sysctl -w net.ipv4.tcp_tw_reuse=1
   # Permet rÃ©utilisation pour nouvelles connexions

2. Augmenter plage de ports :
   echo "10000 65000" > /proc/sys/net/ipv4/ip_local_port_range
   # 55 000 ports au lieu de 28 000

3. HTTP Keep-Alive :
   # RÃ©utiliser les connexions
   Connection: keep-alive

4. SO_REUSEADDR :
   setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, ...)
   # Pour serveurs qui bind() le mÃªme port

5. Load balancing :
   # Distribuer sur plusieurs IPs
   # Chaque IP a sa propre plage de ports
```

### ProblÃ¨me 3 : Accumulation FIN-WAIT-2

```
SymptÃ´me :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ss -tan state fin-wait-2 | wc -l
1000

Cause :
â”€â”€â”€â”€â”€â”€â”€
Application distante ne ferme jamais sa connexion
(bug ou crash)

Impact :
â”€â”€â”€â”€â”€â”€â”€â”€
âŒ Connexions "zombies"
âŒ Ressources bloquÃ©es pendant 60s
âŒ Peut s'accumuler

Solution :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# RÃ©duire timeout FIN-WAIT-2
sysctl -w net.ipv4.tcp_fin_timeout=30
# 30s au lieu de 60s

# VÃ©rifier
ss -tan state fin-wait-2 -o
# Option -o montre les timers

# Sortie :
# FIN-WAIT-2  timer:(timewait,25sec,0)
#                    â–²         â–²
#                    â”‚         â””â”€ Temps restant
#                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Type de timer
```

### ProblÃ¨me 4 : Trop de SYN-RECV

```
SymptÃ´me :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ss -tan state syn-recv | wc -l
5000  â† Attaque SYN flood probable !

Cause :
â”€â”€â”€â”€â”€â”€â”€
Attaque SYN flood : envoi massif de SYN
sans ACK final

Impact :
â”€â”€â”€â”€â”€â”€â”€â”€
âŒ SYN queue pleine
âŒ Nouvelles connexions lÃ©gitimes refusÃ©es
âŒ DÃ©ni de service

Diagnostic :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
netstat -s | grep -i syn
# TCP: 50000 SYN cookies sent
# TCP: 10000 SYNs to LISTEN sockets dropped

Solutions :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. SYN Cookies :
   sysctl -w net.ipv4.tcp_syncookies=1
   # ActivÃ© par dÃ©faut

2. Augmenter backlog :
   sysctl -w net.ipv4.tcp_max_syn_backlog=4096

3. RÃ©duire timeout SYN-ACK :
   sysctl -w net.ipv4.tcp_synack_retries=2
   # 3 tentatives au lieu de 5

4. Rate limiting (firewall) :
   iptables -A INPUT -p tcp --syn -m limit \
     --limit 100/s -j ACCEPT

5. Monitoring et blacklist :
   # Identifier IPs sources
   ss -tan state syn-recv | awk '{print $5}' | sort | uniq -c
   # Bloquer les IPs malveillantes
```

### ProblÃ¨me 5 : Connexions orphelines

```
SymptÃ´me :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ss -s
# TCP: orphaned 1000

Cause :
â”€â”€â”€â”€â”€â”€â”€
Processus propriÃ©taire terminÃ© sans fermer
proprement les sockets

Impact :
â”€â”€â”€â”€â”€â”€â”€â”€
âŒ Ressources kernel bloquÃ©es
âŒ MÃ©moire non libÃ©rÃ©e
âŒ Peut atteindre limite systÃ¨me

Solution :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Limite d'orphelins
sysctl net.ipv4.tcp_max_orphans
262144  (dÃ©faut)

# RÃ©duire si problÃ¨me :
sysctl -w net.ipv4.tcp_max_orphans=65536

# Les orphelins au-delÃ  sont forcÃ©s Ã  fermer
```

## Ã‰tats et sÃ©curitÃ©

### Attaques basÃ©es sur les Ã©tats

```
1. SYN Flood
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Objectif : Saturer SYN-RECV
MÃ©thode : Envoyer beaucoup de SYN, pas d'ACK
DÃ©fense : SYN cookies, rate limiting

2. Slowloris
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Objectif : Maintenir connexions ESTABLISHED
MÃ©thode : Envoyer donnÃ©es trÃ¨s lentement
DÃ©fense : Timeout applicatif, limites

3. FIN-WAIT-2 Exhaustion
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Objectif : Accumuler FIN-WAIT-2
MÃ©thode : Recevoir FIN, ne jamais fermer
DÃ©fense : tcp_fin_timeout court

4. TIME-WAIT Assassination
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Objectif : Terminer connexions TIME-WAIT
MÃ©thode : Envoyer RST avec bons numÃ©ros
DÃ©fense : Validation stricte des RST
```

### Hardening

```bash
# Protection SYN flood
sysctl -w net.ipv4.tcp_syncookies=1
sysctl -w net.ipv4.tcp_max_syn_backlog=4096
sysctl -w net.ipv4.tcp_synack_retries=2

# Limites ressources
sysctl -w net.ipv4.tcp_max_orphans=65536
sysctl -w net.ipv4.tcp_max_tw_buckets=180000

# Timeouts agressifs
sysctl -w net.ipv4.tcp_fin_timeout=30
sysctl -w net.ipv4.tcp_keepalive_time=600
sysctl -w net.ipv4.tcp_keepalive_probes=3
sysctl -w net.ipv4.tcp_keepalive_intvl=15

# RFC 5961 (protection RST)
sysctl -w net.ipv4.tcp_rfc1337=1
```

## RÃ©sumÃ© des Ã©tats

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RÃ‰CAPITULATIF DES Ã‰TATS                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Phase          Ã‰tats           DurÃ©e typ.   ProblÃ¨mes       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                              â”‚
â”‚  Initial        CLOSED          -            -               â”‚
â”‚                 LISTEN          Permanent    SYN flood       â”‚
â”‚                                                              â”‚
â”‚  Ã‰tablissement  SYN-SENT        1 RTT        Timeout         â”‚
â”‚                 SYN-RECEIVED    0.5 RTT      SYN flood       â”‚
â”‚                                                              â”‚
â”‚  DonnÃ©es        ESTABLISHED     Variable     -               â”‚
â”‚                                                              â”‚
â”‚  Fermeture      FIN-WAIT-1      0.5 RTT      -               â”‚
â”‚  (actif)        FIN-WAIT-2      Variable     Timeout         â”‚
â”‚                 CLOSING         0.5 RTT      Rare            â”‚
â”‚                 TIME-WAIT       60s !        Accumulation    â”‚
â”‚                                                              â”‚
â”‚  Fermeture      CLOSE-WAIT      Variable     Bug app         â”‚
â”‚  (passif)       LAST-ACK        0.5 RTT      -               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Conclusion

La machine Ã  Ã©tats TCP est au cÅ“ur du protocole. Chaque Ã©tat a un rÃ´le prÃ©cis et des transitions bien dÃ©finies.

**Points clÃ©s** :

1. **11 Ã©tats** : De CLOSED Ã  CLOSED via diffÃ©rents chemins
2. **Ã‰tats critiques** :
   - ESTABLISHED : Ã‰tat de travail
   - TIME-WAIT : ProblÃ©matique en production
   - CLOSE-WAIT : RÃ©vÃ©lateur de bugs
3. **Transitions** : DÃ©clenchÃ©es par Ã©vÃ©nements (appels systÃ¨me, rÃ©ception segments)
4. **Diagnostic** : ss/netstat essentiels pour monitoring
5. **ProblÃ¨mes courants** : CLOSE-WAIT et TIME-WAIT accumulation

**Commandes essentielles** :

```bash
# Voir tous les Ã©tats
ss -tan

# Compter par Ã©tat
ss -tan | awk '{print $1}' | sort | uniq -c

# Surveiller Ã©tat spÃ©cifique
watch -n 1 'ss -tan state close-wait | wc -l'

# Identifier processus
ss -tanp state close-wait
```

**Checklist de santÃ©** :

```
Ã‰tat sain d'un systÃ¨me :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ LISTEN : Nombre attendu de services
âœ“ ESTABLISHED : Proportionnel au trafic
âœ“ TIME-WAIT : < 10 000 (sauf haute charge)
âœ“ CLOSE-WAIT : < 10 (idÃ©alement 0)
âœ“ FIN-WAIT-2 : < 100
âœ“ SYN-RECV : < 100 (sauf attaque)

Ã‰tat problÃ©matique :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŒ CLOSE-WAIT : > 1000 (bug applicatif)
âŒ TIME-WAIT : > 50 000 (problÃ¨me design)
âŒ SYN-RECV : > 1000 (attaque probable)
âŒ FIN-WAIT-2 : > 1000 (applications distantes)
```

La comprÃ©hension des Ã©tats TCP est fondamentale pour :
- ğŸ› DÃ©boguer les applications rÃ©seau
- ğŸ“Š Monitorer la santÃ© du systÃ¨me
- âš¡ Optimiser les performances
- ğŸ›¡ï¸ DÃ©tecter et contrer les attaques
- ğŸ”§ Configurer correctement le systÃ¨me

Cette section conclut notre exploration approfondie de TCP. Vous avez maintenant une comprÃ©hension complÃ¨te du protocole, de ses mÃ©canismes internes, et de son comportement dans diffÃ©rentes situations.

---

**Section suivante** : 4.6 Comparaison TCP vs UDP : critÃ¨res de choix

â­ï¸ [Comparaison TCP vs UDP : critÃ¨res de choix](/04-couche-transport/06-tcp-vs-udp.md)
