ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 6.5.2 AH et ESP

## Introduction

AH (Authentication Header) et ESP (Encapsulating Security Payload) sont les **deux protocoles de protection** au cÅ“ur d'IPsec. Ils dÃ©finissent comment les donnÃ©es sont rÃ©ellement sÃ©curisÃ©es au niveau du paquet IP.

Ces deux protocoles ont des philosophies diffÃ©rentes :

```
AH (Authentication Header) :
- Philosophie : "IntÃ©gritÃ© de tout le paquet"
- Objectif : Garantir que le paquet n'a pas Ã©tÃ© modifiÃ©
- MÃ©thode : Signature cryptographique incluant IP header
- Chiffrement : AUCUN (donnÃ©es en clair)

ESP (Encapsulating Security Payload) :
- Philosophie : "ConfidentialitÃ© et intÃ©gritÃ© du payload"
- Objectif : ProtÃ©ger le contenu contre lecture et modification
- MÃ©thode : Chiffrement + MAC ou AEAD
- Chiffrement : OUI (donnÃ©es illisibles)

Analogie :
AH = Sceau de cire sur une enveloppe transparente
     â†’ On voit le contenu mais on dÃ©tecte toute ouverture

ESP = Coffre-fort blindÃ© avec code
      â†’ On ne voit rien et impossible d'ouvrir sans la clÃ©
```

**Ã‰tat actuel (2024)** :

```
ESP : Standard universel
âœ“ 99%+ des dÃ©ploiements IPsec
âœ“ Fait tout ce que AH fait + chiffrement
âœ“ Support universel
âœ“ RecommandÃ© par tous les standards

AH : Pratiquement obsolÃ¨te
âœ— <1% des dÃ©ploiements
âœ— ProblÃ¨mes NAT insurmontables
âœ— Pas de chiffrement (insuffisant aujourd'hui)
âœ— ComplexitÃ© sans bÃ©nÃ©fice
âœ— DÃ©prÃ©ciÃ© dans de nombreuses implÃ©mentations
```

Nous Ã©tudierons nÃ©anmoins AH en dÃ©tail pour :
- ComprÃ©hension historique d'IPsec
- Comprendre les choix de conception
- ApprÃ©cier les avantages d'ESP
- Culture technique (certifications, documentation legacy)

## AH (Authentication Header)

### Historique et motivation

**Pourquoi AH a Ã©tÃ© crÃ©Ã© ?**

```
AnnÃ©es 1990 : Contexte de crÃ©ation d'IPsec

ProblÃ¨mes Ã  rÃ©soudre :
1. Authentification de l'origine
   â†’ Qui a vraiment envoyÃ© ce paquet ?

2. IntÃ©gritÃ© des donnÃ©es
   â†’ Le paquet a-t-il Ã©tÃ© modifiÃ© en route ?

3. Protection contre replay
   â†’ Est-ce une retransmission malveillante ?

Design AH :
- Protection de TOUT le paquet (y compris IP header)
- Pas de chiffrement (restrictions export Ã  l'Ã©poque)
- Simple : juste un hash cryptographique

Avantage thÃ©orique :
âœ“ ICV (Integrity Check Value) couvre IP header
âœ“ Protection contre modification TTL, ToS, etc.
âœ“ Garantie origine du paquet IP complet

ProblÃ¨me dans la pratique :
âœ— NAT modifie IP header (adresse source/dest)
âœ— ICV devient invalide
âœ— AH cassÃ© par NAT
âœ— Incompatible avec Internet moderne (NAT omniprÃ©sent)
```

### Structure du protocole AH

**Position dans le paquet** :

```
Paquet IPv4 avec AH :

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IP Header                                      â”‚
â”‚ Protocol: 51 (AH) â† Indique qu'AH suit         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AH Header                                      â”‚
â”‚ (dÃ©tails ci-dessous)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TCP/UDP Header + Data                          â”‚
â”‚ (NON chiffrÃ©, en clair)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NumÃ©ro de protocole IP : 51
IANA assigned : Authentication Header
```

### Format dÃ©taillÃ© AH

```
AH Header Structure (RFC 4302) :

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Next Header   | Payload Len   |          Reserved             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 Security Parameters Index (SPI)               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Sequence Number Field                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                Integrity Check Value (ICV)                    |
|                    (variable length)                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Taille totale : Minimum 24 bytes (12 bytes ICV)
                Maximum variable selon algorithme ICV
```

#### Champs en dÃ©tail

**Next Header (1 byte)** :

```
Valeur : Protocole qui suit l'AH

Exemples :
- 6 : TCP
- 17 : UDP
- 1 : ICMP
- 4 : IPv4 (mode tunnel)
- 50 : ESP (AH + ESP combinÃ©, rare)

Exemple :
Next Header = 6 (TCP)
â†’ AprÃ¨s AH, on trouve un header TCP

UtilitÃ© :
Permet au rÃ©cepteur de savoir comment interprÃ©ter
le payload aprÃ¨s avoir vÃ©rifiÃ© AH
```

**Payload Length (1 byte)** :

```
Longueur du AH header en mots de 32 bits, moins 2

Formule : Payload Len = (AH_length / 4) - 2

Exemples :
AH total = 24 bytes (6 mots de 32 bits)
Payload Len = 6 - 2 = 4

AH total = 32 bytes (8 mots de 32 bits)
Payload Len = 8 - 2 = 6

Pourquoi -2 ?
- Historique : Next Header et Payload Len comptent pour 2 mots
- Calcul inverse : AH_length = (Payload Len + 2) Ã— 4
```

**Reserved (2 bytes)** :

```
Valeur : 0x0000

RÃ©servÃ© pour usage futur
Doit Ãªtre 0 Ã  l'envoi
IgnorÃ© Ã  la rÃ©ception

Note : Aucun usage dÃ©fini depuis crÃ©ation (1998)
```

**Security Parameters Index - SPI (4 bytes)** :

```
Identifiant unique de la Security Association (SA)

Valeur : 32 bits arbitraire (sauf 0-255 rÃ©servÃ©s)

Exemple :
SPI = 0x12345678

Utilisation :
1. RÃ©cepteur reÃ§oit paquet AH
2. Lit SPI = 0x12345678
3. Lookup dans SAD (Security Association Database)
4. Trouve SA correspondante :
   - Algorithme : HMAC-SHA256
   - ClÃ© : [clÃ© secrÃ¨te]
   - Mode : Transport
   - Replay window : 64
5. Utilise SA pour vÃ©rifier paquet

Valeurs rÃ©servÃ©es :
0x00000000 : Invalide
0x00000001-0x000000FF : RÃ©servÃ©es IANA
0x00000100+ : Utilisables
```

**Sequence Number (4 bytes)** :

```
Compteur anti-replay : 32 bits, incrÃ©mente Ã  chaque paquet

DÃ©marrage :
- Commence Ã  1 lors crÃ©ation SA
- IncrÃ©mente pour chaque paquet envoyÃ©
- JAMAIS rÃ©utilisÃ© (rollover = rekey)

Exemple sÃ©quence :
Paquet 1 : Seq = 0x00000001
Paquet 2 : Seq = 0x00000002
Paquet 3 : Seq = 0x00000003
...
Paquet 4294967295 : Seq = 0xFFFFFFFF
â†’ SA DOIT Ãªtre renÃ©gociÃ©e (rekey)

VÃ©rification anti-replay (rÃ©cepteur) :

Sliding Window (dÃ©faut 64 paquets) :

Window actuelle : [100 ... 163]
                   â†‘       â†‘
                   min    max (last received)

Paquet reÃ§u Seq=165 :
- 165 > 163 (max) â†’ OK, accepter
- Update window : [102 ... 165]

Paquet reÃ§u Seq=150 :
- 150 dans [102 ... 165] â†’ VÃ©rifier bitmap
- Si dÃ©jÃ  reÃ§u â†’ REJECT (replay)
- Sinon â†’ OK, marquer dans bitmap

Paquet reÃ§u Seq=95 :
- 95 < 102 (min) â†’ REJECT (trop vieux)

Protection :
âœ“ Impossible de rejouer vieux paquets
âœ“ DÃ©tection paquets dupliquÃ©s
âœ“ FenÃªtre glissante tolÃ¨re rÃ©ordonnancement
```

**Integrity Check Value - ICV (variable)** :

```
Hash cryptographique (MAC) du paquet complet

Longueur : DÃ©pend de l'algorithme
- HMAC-SHA1-96 : 12 bytes (96 bits tronquÃ©s)
- HMAC-SHA256-128 : 16 bytes (128 bits tronquÃ©s)
- HMAC-SHA384-192 : 24 bytes (192 bits tronquÃ©s)
- HMAC-SHA512-256 : 32 bytes (256 bits tronquÃ©s)

Calcul ICV :

ICV = HMAC-Algorithm(
    key = integrity_key,
    data = Immutable_IP_fields + AH_header_minus_ICV + Payload
)

Champs IP immuables (couverts par ICV) :
âœ“ Version
âœ“ IHL (Internet Header Length)
âœ“ Protocol
âœ“ Source Address
âœ“ Destination Address
âœ“ Options (si prÃ©sentes)

Champs IP mutables (EXCLUS de ICV, mis Ã  0) :
âœ— Type of Service / DSCP (peut changer en route)
âœ— Flags / Fragment Offset (fragmentation)
âœ— TTL (dÃ©crÃ©mente Ã  chaque hop)
âœ— Header Checksum (recalculÃ© Ã  chaque hop)

Raison exclusion champs mutables :
- Routeurs modifient ces champs lÃ©gitimement
- Si inclus dans ICV â†’ toujours invalide aprÃ¨s 1er hop
- RFC 4302 dÃ©finit prÃ©cisÃ©ment champs immuables

Exemple calcul (HMAC-SHA256-128) :

Data pour HMAC :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IP Header (champs immuables only)   â”‚
â”‚ Version, IHL, Protocol, Src, Dst    â”‚
â”‚ Champs mutables = 0x00              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AH Header (sans ICV)                â”‚
â”‚ Next Header, Payload Len, Reserved  â”‚
â”‚ SPI, Sequence Number                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Payload complet                     â”‚
â”‚ (TCP/UDP header + data)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    HMAC-SHA256(data, key)
         â†“
    256 bits output
         â†“
    Tronquer Ã  128 bits
         â†“
    ICV = 16 bytes
```

### Traitement AH (Ã©mission et rÃ©ception)

#### Ã‰mission d'un paquet AH

```
Processus d'envoi :

1. Application gÃ©nÃ¨re donnÃ©es
   â†“
2. Stack TCP/IP crÃ©e paquet
   IP: 192.168.1.10 â†’ 192.168.1.20
   TCP: 45678 â†’ 443
   Data: [payload]
   â†“
3. IPsec intercepte (policy check)
   Destination 192.168.1.20 matche SA
   SA requires AH protection
   â†“
4. Lookup SA dans SAD
   SPI: 0xABCDEF12
   Algorithm: HMAC-SHA256-128
   Key: [16 bytes secret]
   Sequence: 42
   â†“
5. Construction AH Header
   Next Header: 6 (TCP)
   Payload Len: 4 (pour 24 bytes total)
   Reserved: 0x0000
   SPI: 0xABCDEF12
   Sequence: 42 (puis incrÃ©mente SA Ã  43)
   ICV: [placeholder 16 bytes 0x00]
   â†“
6. PrÃ©paration donnÃ©es pour HMAC
   IP Header (immuables only):
     Version=4, IHL=5, ToS=0, Total Len=...,
     ID=..., Flags/Frag=0, TTL=0, Proto=51,
     Checksum=0, Src=192.168.1.10, Dst=192.168.1.20

   AH Header (sans ICV):
     [Next=6, PayloadLen=4, Reserved=0,
      SPI=0xABCDEF12, Seq=42]

   Payload:
     [TCP header + data complet]
   â†“
7. Calcul HMAC
   ICV = HMAC-SHA256(concatenation, key)[0:15]
   Result: 7B 2D 9A 1F 3C 8E 4B 6D 5A 7C 8D 9E AF C5 B3 D4
   â†“
8. Insertion ICV dans AH Header
   â†“
9. Modification IP Header
   Protocol: 6 (TCP) â†’ 51 (AH)
   Total Length: augmentÃ© de 24 bytes
   Header Checksum: recalculÃ©
   â†“
10. Paquet final AH prÃªt Ã  Ãªtre envoyÃ©
    â†“
11. Transmission rÃ©seau
```

#### RÃ©ception et vÃ©rification AH

```
Processus de rÃ©ception :

1. Paquet reÃ§u de l'interface rÃ©seau
   IP Protocol = 51 (AH)
   â†“
2. Extraction SPI
   SPI = 0xABCDEF12 (lu dans AH header)
   â†“
3. Lookup SA dans SAD
   Found SA:
     Algorithm: HMAC-SHA256-128
     Key: [16 bytes]
     Replay window: [1-64]
   If SA not found â†’ DROP paquet
   â†“
4. VÃ©rification Sequence Number
   Sequence reÃ§u: 42
   Window: [1-64]

   Check:
   - 42 in window ? YES
   - Already received ? Check bitmap
   - Bitmap[42] = 0 (pas encore reÃ§u) â†’ OK

   If replay detected â†’ DROP paquet
   â†“
5. Extraction ICV reÃ§u
   ICV_received = [16 bytes from packet]
   â†“
6. Recalcul ICV
   Prepare data (mÃªme mÃ©thode qu'Ã©mission):
   - IP header (immuables, mutables=0)
   - AH header (ICV field = 0x00)
   - Payload complet

   ICV_calculated = HMAC-SHA256(data, key)[0:15]
   â†“
7. Comparaison ICV
   If ICV_received != ICV_calculated:
      â†’ DROP paquet (integrity failure)
      â†’ Log security event
      â†’ Increment error counter

   If ICV_received == ICV_calculated:
      â†’ OK, paquet authentique
   â†“
8. Update replay window
   Marquer Sequence 42 comme reÃ§u
   Bitmap[42] = 1

   If Seq > window_max:
      Slide window
   â†“
9. Extraction payload
   Next Header = 6 (TCP)
   â†’ Retirer AH header
   â†’ Restaurer IP header original
   â†“
10. Remise Ã  couche supÃ©rieure
    TCP stack reÃ§oit paquet comme si pas d'AH
    â†“
11. Traitement normal TCP/Application
```

### ProblÃ¨mes avec AH

#### ProblÃ¨me 1 : IncompatibilitÃ© NAT

**Le problÃ¨me fondamental** :

```
AH calcule ICV sur IP header (src/dst addresses)
NAT modifie IP header
â†’ ICV invalide
â†’ Paquet rejetÃ©

Exemple concret :

Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ NAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Server
10.0.0.5          203.0.113.50      198.51.100.20

1. Client envoie paquet AH :
   IP: 10.0.0.5 â†’ 198.51.100.20
   AH: ICV calculÃ© sur IP complet
   ICV = HMAC([...10.0.0.5...198.51.100.20...], key)

2. NAT reÃ§oit :
   Lit IP src: 10.0.0.5
   Translate: 10.0.0.5 â†’ 203.0.113.50
   Modifie IP header:
     IP: 203.0.113.50 â†’ 198.51.100.20

3. NAT forward vers serveur

4. Serveur reÃ§oit :
   IP: 203.0.113.50 â†’ 198.51.100.20
   Recalcule ICV:
   ICV' = HMAC([...203.0.113.50...198.51.100.20...], key)

5. Comparaison :
   ICV (envoyÃ©) = HMAC([...10.0.0.5...])
   ICV' (calculÃ©) = HMAC([...203.0.113.50...])

   ICV != ICV' â†’ MISMATCH

6. Serveur :
   â†’ DROP paquet
   â†’ Log integrity failure
   â†’ Connexion Ã©choue

RÃ©sultat : AH INCOMPATIBLE avec NAT
           Aucune solution technique viable
```

**Tentatives de solutions (Ã©checs)** :

```
IdÃ©e 1 : NAT-aware AH
- NAT recalcule ICV
- ProblÃ¨me : NAT n'a pas la clÃ© IPsec !
- Statut : Impossible

IdÃ©e 2 : Exclure IP addresses de ICV
- ICV ne couvre pas src/dst
- ProblÃ¨me : Perd l'intÃ©rÃªt principal d'AH
- Statut : Rend AH inutile

IdÃ©e 3 : NAT-T pour AH
- Encapsuler AH dans UDP
- ProblÃ¨me : ICV couvre toujours IP
- Statut : Ne rÃ©sout rien

Conclusion :
AH et NAT sont fondamentalement incompatibles
â†’ AH inutilisable sur Internet moderne
â†’ ESP seule solution viable
```

#### ProblÃ¨me 2 : Pas de confidentialitÃ©

```
AH = Authentification SEULEMENT

Paquet AH observable :

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IP Header (VISIBLE)                â”‚
â”‚ Src: 192.168.1.10                  â”‚ â† Qui communique
â”‚ Dst: 192.168.1.20                  â”‚ â† Avec qui
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AH Header (VISIBLE)                â”‚
â”‚ Next Header: TCP (6)               â”‚ â† Type de trafic
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TCP Header (EN CLAIR)              â”‚
â”‚ Src Port: 45678                    â”‚ â† Application source
â”‚ Dst Port: 443                      â”‚ â† Application dest
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Application Data (EN CLAIR)        â”‚
â”‚ GET /secret/data HTTP/1.1          â”‚ â† DonnÃ©es lisibles !
â”‚ Authorization: Bearer eyJ0eXAi...  â”‚
â”‚ ...                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Attaquant observe :
âœ“ Qui communique (IPs)
âœ“ Quels ports (applications)
âœ“ Taille des messages
âœ“ FrÃ©quence communication
âœ“ CONTENU COMPLET des donnÃ©es

Protection AH :
âœ“ IntÃ©gritÃ© (dÃ©tecte modification)
âœ“ Authentification (vÃ©rifie origine)
âœ— AUCUNE confidentialitÃ©

ConsÃ©quence :
Insuffisant pour la plupart des cas d'usage
â†’ ESP prÃ©fÃ©rÃ© (chiffrement + intÃ©gritÃ©)
```

#### ProblÃ¨me 3 : Overhead sans bÃ©nÃ©fice

```
Overhead AH :
- Minimum : 24 bytes
- Avec SHA-256 : 32 bytes
- Avec SHA-512 : 48 bytes

Comparaison avec ESP :
AH seul : 24 bytes + pas de chiffrement
ESP : 30-50 bytes + chiffrement + intÃ©gritÃ©

ESP fait TOUT ce que AH fait, PLUS chiffrement
â†’ Pourquoi utiliser AH ?
â†’ Aucune raison valable en 2024
```

## ESP (Encapsulating Security Payload)

### Historique et design

**Pourquoi ESP a Ã©tÃ© crÃ©Ã© ?**

```
AnnÃ©es 1990 : Limitations d'AH identifiÃ©es

Besoin :
1. ConfidentialitÃ© (chiffrement)
2. IntÃ©gritÃ©
3. Authentification
4. Compatible NAT (Ã©ventuellement)

Design ESP :
- Chiffrement du payload
- MAC/AEAD pour intÃ©gritÃ©
- ICV ne couvre PAS IP header original
- â†’ Compatible NAT avec NAT-T

Ã‰volution :
ESP v1 (RFC 1827, 1995) : Encryption only
ESP v2 (RFC 2406, 1998) : Encryption + Authentication
ESP v3 (RFC 4303, 2005) : AEAD support, clarifications
ESP current (RFC 7634, 2015) : ChaCha20-Poly1305

Statut actuel :
âœ“ Standard de facto IPsec
âœ“ Support universel
âœ“ Constamment amÃ©liorÃ©
âœ“ Base de tous les VPN modernes
```

### Structure du protocole ESP

**Position dans le paquet** :

```
Paquet IPv4 avec ESP :

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IP Header                                      â”‚
â”‚ Protocol: 50 (ESP) â† Indique qu'ESP suit       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ESP Header (NON chiffrÃ©)                       â”‚
â”œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”¤
â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚ â•‘ Payload (CHIFFRÃ‰)                          â•‘ â”‚
â”‚ â•‘ - Original data                            â•‘ â”‚
â”‚ â•‘ - Padding                                  â•‘ â”‚
â”‚ â•‘ - ESP Trailer                              â•‘ â”‚
â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ESP Auth Data / ICV (NON chiffrÃ©)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NumÃ©ro de protocole IP : 50
IANA assigned : Encapsulating Security Payload
```

### Format dÃ©taillÃ© ESP

```
ESP Packet Structure (RFC 4303) :

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ ----
|               Security Parameters Index (SPI)                 | ^Int.
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |Cov-
|                      Sequence Number                          | |ered
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | ----
|                    Payload Data* (variable)                   | |   ^
~                                                               ~ |   |
|                                                               | |Conf.
+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |Cov-
|               |     Padding (0-255 bytes)                     | |ered
+-+-+-+-+-+-+-+-+               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ |   |
|                               |  Pad Length   | Next Header   | v   v
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ ------
|         Integrity Check Value-ICV   (variable)                |
~                                                               ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Sections :
- ESP Header : SPI + Sequence Number (8 bytes, clair)
- Encrypted Payload : DonnÃ©es + Padding + Trailer (chiffrÃ©)
- ESP Auth Data : ICV (clair, mais protÃ¨ge tout)
```

#### Champs ESP en dÃ©tail

**ESP Header (8 bytes - NON chiffrÃ©)**

```
Security Parameters Index - SPI (4 bytes) :

Identique Ã  AH :
- Identifie la SA (Security Association)
- Valeur arbitraire 32 bits
- RÃ©cepteur utilise pour lookup SA

Exemple :
SPI = 0x12345678
â†’ Lookup SAD
â†’ Trouve : AES-256-GCM, clÃ©s, mode tunnel, etc.

Sequence Number (4 bytes) :

Identique Ã  AH :
- Anti-replay counter
- DÃ©marre Ã  1, incrÃ©mente
- 32 bits : max 2^32 - 1 paquets
- Extended Sequence Number (ESN) : 64 bits disponible

Anti-replay window :
- MÃªme mÃ©canisme qu'AH
- Sliding window (dÃ©faut 64 paquets)
- DÃ©tecte duplications
```

**Payload Data (variable - CHIFFRÃ‰)**

```
Contenu du payload :

Mode Transport :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TCP/UDP Header                     â”‚
â”‚ Application Data                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Mode Tunnel :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Original IP Header                 â”‚
â”‚ Original TCP/UDP Header            â”‚
â”‚ Application Data                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tout est chiffrÃ© :
- Illisible sans la clÃ©
- Algorithmes : AES, ChaCha20, etc.
- Mode : GCM (AEAD), CBC+HMAC, etc.
```

**Padding (0-255 bytes - CHIFFRÃ‰)**

```
Raisons du padding :

1. Alignement bloc cipher :
   AES : blocs de 16 bytes
   Si payload = 25 bytes
   â†’ Padding = 7 bytes pour atteindre 32 bytes (2 blocs)

2. Masquer la longueur rÃ©elle :
   Payload = 10 bytes
   Padding = 50 bytes
   â†’ Attaquant ne connaÃ®t pas vraie longueur
   â†’ Protection traffic analysis

3. Alignement 4-bytes :
   Certains CPU prÃ©fÃ¨rent alignement 32 bits
   Padding jusqu'Ã  multiple de 4

Format padding :
SÃ©quence : 0x01, 0x02, 0x03, 0x04, 0x05...

Exemple :
Payload : 25 bytes
Besoin : 32 bytes (2 blocs AES)
Padding : 7 bytes
Content : 0x01 0x02 0x03 0x04 0x05 0x06 0x07

Maximum : 255 bytes (limite du champ Pad Length)
```

**ESP Trailer (2 bytes - CHIFFRÃ‰)**

```
Pad Length (1 byte) :
- Nombre de bytes de padding
- Valeur 0-255
- Permet au rÃ©cepteur de retirer padding

Next Header (1 byte) :
- Protocole aprÃ¨s dÃ©chiffrement
- Exemples :
  * 6 : TCP (mode transport)
  * 17 : UDP (mode transport)
  * 4 : IPv4 (mode tunnel)
  * 41 : IPv6 (mode tunnel)

Exemple :
Payload = 25 bytes
Padding = 7 bytes (0x01...0x07)
Pad Length = 0x07
Next Header = 0x06 (TCP)

ESP Trailer = 0x07 0x06
```

**Integrity Check Value - ICV (variable - NON chiffrÃ©)**

```
MAC ou AEAD Tag :

Avec AEAD (AES-GCM, ChaCha20-Poly1305) :
- Tag intÃ©grÃ© au chiffrement
- Authentifie ESP header + payload chiffrÃ©
- Longueur : 8, 12, ou 16 bytes (typique 16)

Avec Cipher + HMAC sÃ©parÃ© :
- HMAC calculÃ© sÃ©parÃ©ment
- Authentifie ESP header + payload chiffrÃ©
- Longueur : 12, 16, 24, 32 bytes selon algorithme

Couverture ICV :

ICV authentifie :
âœ“ SPI
âœ“ Sequence Number
âœ“ Payload chiffrÃ© (donnÃ©es + padding + trailer)

ICV N'authentifie PAS :
âœ— IP Header (peut changer : TTL, ToS, etc.)
âœ— â†’ C'est pourquoi ESP compatible NAT !

Calcul (mode AEAD, ex: AES-GCM) :

Tag = GCM_Encrypt(
    key = encryption_key,
    nonce = IV,
    plaintext = [Payload + Padding + Trailer],
    aad = [SPI + Sequence Number]
)

RÃ©sultat : Ciphertext + Authentication Tag
```

### Modes de chiffrement ESP

#### Mode AEAD (recommandÃ© 2024)

**AES-GCM (Galois/Counter Mode)** :

```
AEAD = Authenticated Encryption with Associated Data

Avantages :
âœ“ Chiffrement + authentification en un seul algorithme
âœ“ ParallÃ©lisable (performance)
âœ“ AccÃ©lÃ©ration hardware (AES-NI + PCLMULQDQ)
âœ“ SÃ©curisÃ© et prouvÃ©

Structure :

Input :
- Key : 128, 192, ou 256 bits
- IV/Nonce : 96 bits (8 bytes Salt + 8 bytes IV)
- Plaintext : [Payload + Padding + Trailer]
- AAD : [SPI + Sequence Number]

Process :
1. Counter Mode (CTR) pour chiffrement
   Ciphertext = Plaintext XOR Keystream

2. Galois multiplication pour authentification
   Tag = GHASH(AAD + Ciphertext, H)
   oÃ¹ H = AES(Key, 0)

Output :
- Ciphertext : mÃªme longueur que plaintext
- Tag : 128 bits (16 bytes)

Performance (avec AES-NI) :
- ~3-10 GB/s par core
- Latence minimale
- RecommandÃ© pour throughput Ã©levÃ©

Format ESP avec AES-GCM :

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SPI (4 bytes)                        â”‚
â”‚ Sequence Number (4 bytes)            â”‚ â† AAD
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ IV (8 bytes)                         â”‚ â† Nonce explicit
â”œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”¤
â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚ â•‘ Ciphertext                       â•‘ â”‚ â† ChiffrÃ©
â”‚ â•‘ (Payload + Padding + Trailer)    â•‘ â”‚
â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ICV/Tag (16 bytes)                   â”‚ â† Authentication Tag
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ChaCha20-Poly1305** :

```
Alternative moderne Ã  AES-GCM

Avantages :
âœ“ Excellente performance sur CPU sans AES-NI
âœ“ RÃ©sistant aux attaques timing
âœ“ Code simple et auditable
âœ“ IdÃ©al pour mobile/IoT

Structure similaire :
- ClÃ© : 256 bits
- Nonce : 96 bits
- ChaCha20 pour chiffrement (stream cipher)
- Poly1305 pour authentification (MAC)

Performance (sans AES-NI) :
- Souvent plus rapide qu'AES-GCM
- 1-3 GB/s par core (software)
- Excellent pour ARM, mobiles

Usage :
âœ“ VPN mobiles
âœ“ IoT devices
âœ“ SystÃ¨mes embarquÃ©s
âœ“ Alternative Ã  AES-GCM partout
```

#### Mode CBC + HMAC (legacy)

```
Approche traditionnelle (dÃ©conseillÃ©e 2024) :

Encryption : AES-CBC (Cipher Block Chaining)
Authentication : HMAC-SHA256/384/512 sÃ©parÃ©

ProblÃ¨mes :
âœ— Deux opÃ©rations sÃ©parÃ©es (plus lent)
âœ— VulnÃ©rable padding oracle attacks (si mal implÃ©mentÃ©)
âœ— Non parallÃ©lisable
âœ— Plus complexe

Structure :

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SPI + Sequence                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ IV (16 bytes pour AES)               â”‚
â”œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”¤
â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚ â•‘ AES-CBC Ciphertext               â•‘ â”‚
â”‚ â•‘ (Payload + Padding + Trailer)    â•‘ â”‚
â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HMAC (12-32 bytes)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Process :
1. Encrypt avec AES-CBC
2. Calculer HMAC sur (SPI + Seq + IV + Ciphertext)
3. Append HMAC

Statut :
âœ— DÃ©prÃ©ciÃ© pour nouveaux dÃ©ploiements
âœ“ Encore supportÃ© (legacy)
â†’ Migrer vers AEAD si possible
```

### Traitement ESP (Ã©mission et rÃ©ception)

#### Ã‰mission ESP avec AES-256-GCM

```
Processus complet d'envoi :

1. Application â†’ donnÃ©es
   Data : 60 bytes

2. IPsec policy match
   Destination matche SA
   SA requires ESP protection

3. Lookup SA
   SPI : 0x12345678
   Mode : Tunnel
   Algo : AES-256-GCM
   Keys :
     - Encryption Key : 32 bytes
     - Salt : 4 bytes
   Sequence : 1000

4. PrÃ©paration payload (mode tunnel)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Original IP Header (20 bytes)  â”‚
   â”‚ Original TCP Header (20 bytes) â”‚
   â”‚ Application Data (60 bytes)    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   Total : 100 bytes

5. Padding calculation
   Bloc size AES : 16 bytes
   Payload : 100 bytes
   Trailer : 2 bytes (Pad Len + Next Header)
   Total avant padding : 102 bytes
   Next multiple of 16 : 112 bytes
   Padding needed : 112 - 102 = 10 bytes

6. Construction plaintext
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Original packet (100 bytes)    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ Padding (10 bytes)             â”‚
   â”‚ 0x01 0x02 ... 0x0A             â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ Pad Length : 0x0A              â”‚
   â”‚ Next Header : 0x04 (IPv4)      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   Total plaintext : 112 bytes

7. Nonce/IV construction
   Salt (from SA) : 4 bytes
   IV explicit : 8 bytes (dÃ©rivÃ© de Sequence)
   Combined : 12 bytes nonce

8. AAD (Additional Authenticated Data)
   SPI : 0x12345678 (4 bytes)
   Sequence : 0x000003E8 (4 bytes, 1000 decimal)
   Total AAD : 8 bytes

9. AES-256-GCM Encryption
   Input :
     Key : 32 bytes (from SA)
     Nonce : 12 bytes
     Plaintext : 112 bytes
     AAD : 8 bytes

   Output :
     Ciphertext : 112 bytes
     Tag : 16 bytes

10. Construction ESP packet
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ New IP Header                  â”‚
    â”‚ Src: 203.0.113.10 (gateway)    â”‚
    â”‚ Dst: 198.51.100.20 (gateway)   â”‚
    â”‚ Protocol: 50 (ESP)             â”‚
    â”‚ Total Length: 20+8+8+112+16    â”‚
    â”‚             = 164 bytes        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ ESP Header                     â”‚
    â”‚ SPI: 0x12345678                â”‚
    â”‚ Sequence: 0x000003E8           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ IV (explicit): 8 bytes         â”‚
    â”œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”¤
    â”‚ Ciphertext: 112 bytes          â”‚
    â”‚ (encrypted payload)            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ ICV/Tag: 16 bytes              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

11. Update SA
    Sequence : 1000 â†’ 1001

12. Transmission
    Send packet via network interface
```

#### RÃ©ception et dÃ©chiffrement ESP

```
Processus de rÃ©ception :

1. Packet received
   IP Protocol : 50 (ESP)
   Total Length : 164 bytes

2. Extract SPI
   SPI : 0x12345678 (from ESP header)

3. SAD lookup
   Found SA :
     Algorithm : AES-256-GCM
     Keys : [32 bytes key + 4 bytes salt]
     Mode : Tunnel
     Replay window : current [950-1013]

4. Anti-replay check
   Received Sequence : 1000
   Window : [950-1013]

   Checks :
   âœ“ 1000 >= 950 (not too old)
   âœ“ 1000 <= 1013 (within window)
   âœ“ Bitmap[1000] = 0 (not received yet)

   â†’ OK, continue processing

5. Extract components
   ESP Header : SPI + Sequence (8 bytes)
   IV explicit : 8 bytes
   Ciphertext : 112 bytes
   ICV : 16 bytes

6. Nonce reconstruction
   Salt (from SA) : 4 bytes
   IV (from packet) : 8 bytes
   Nonce : 12 bytes combined

7. AAD reconstruction
   SPI : 0x12345678
   Sequence : 0x000003E8
   AAD : 8 bytes

8. AES-256-GCM Decryption + Verification
   Input :
     Key : 32 bytes (from SA)
     Nonce : 12 bytes
     Ciphertext : 112 bytes
     Tag : 16 bytes
     AAD : 8 bytes

   Process :
     a) Verify Tag (authentication)
        If Tag invalid :
           â†’ DROP packet
           â†’ Log security event
           â†’ Increment error counter
           â†’ STOP processing

     b) Decrypt
        Plaintext = AES_GCM_Decrypt(...)

   Output (if successful) :
     Plaintext : 112 bytes

9. Extract from plaintext
   Read last 2 bytes (ESP Trailer) :
   Pad Length : 0x0A (10 bytes)
   Next Header : 0x04 (IPv4)

10. Remove padding
    Total plaintext : 112 bytes
    Remove trailer : 2 bytes
    Remove padding : 10 bytes
    Original payload : 100 bytes

11. Extract original packet
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Original IP Header (20 bytes)  â”‚
    â”‚ Src: 10.1.0.5                  â”‚
    â”‚ Dst: 10.2.0.10                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ TCP Header (20 bytes)          â”‚
    â”‚ Src Port: 45678                â”‚
    â”‚ Dst Port: 443                  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Application Data (60 bytes)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

12. Update anti-replay
    Mark Sequence 1000 as received
    Bitmap[1000] = 1

13. Route internally
    Destination : 10.2.0.10
    Lookup routing table
    Forward to internal network

14. Delivery
    Packet delivered to 10.2.0.10
    Transparent for end host
```

### Comparaison AH vs ESP

#### Tableau comparatif dÃ©taillÃ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CaractÃ©ristique     â”‚       AH       â”‚        ESP         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Protocole IP #      â”‚       51       â”‚        50          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ConfidentialitÃ©     â”‚       NON      â”‚        OUI         â”‚
â”‚ (chiffrement)       â”‚                â”‚                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ IntÃ©gritÃ© payload   â”‚       OUI      â”‚        OUI         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ IntÃ©gritÃ© IP header â”‚       OUI      â”‚        NON         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Authentification    â”‚       OUI      â”‚        OUI         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Anti-replay         â”‚       OUI      â”‚        OUI         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Compatible NAT      â”‚       NON      â”‚   OUI (avec NAT-T) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Overhead minimum    â”‚    24 bytes    â”‚     30-50 bytes    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Padding             â”‚       NON      â”‚   OUI (0-255 bytes)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AEAD support        â”‚       NON      â”‚        OUI         â”‚
â”‚                     â”‚                â”‚  (GCM, ChaCha20)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Payload visible     â”‚       OUI      â”‚        NON         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Traffic analysis    â”‚   VulnÃ©rable   â”‚   RÃ©sistant        â”‚
â”‚ protection          â”‚                â”‚  (avec padding)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DÃ©ploiement 2024    â”‚      <1%       â”‚       >99%         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Recommandation      â”‚ NE PAS UTILISERâ”‚   UTILISER         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Pourquoi ESP a gagnÃ©

```
Raisons du succÃ¨s d'ESP :

1. Fait tout ce qu'AH fait :
   âœ“ IntÃ©gritÃ© du payload : OUI
   âœ“ Authentification : OUI
   âœ“ Anti-replay : OUI

   Bonus :
   âœ“ Chiffrement : OUI (AH : NON)
   âœ“ Compatible NAT : OUI (AH : NON)

2. RÃ©alitÃ©s d'Internet :
   - NAT omniprÃ©sent (routers, firewalls)
   - AH cassÃ© par NAT
   - ESP fonctionne (avec NAT-T)

3. Besoins de sÃ©curitÃ© :
   - ConfidentialitÃ© requise (2024)
   - IntÃ©gritÃ© IP header pas critique
   - TTL, ToS changent lÃ©gitimement

4. Performance :
   - Hardware acceleration pour AES
   - AEAD efficace (GCM)
   - Une seule opÃ©ration crypto

5. SimplicitÃ© :
   - Un protocole fait tout
   - Pas besoin de combiner AH + ESP
   - Configuration simplifiÃ©e

RÃ©sultat :
ESP = Standard universel IPsec
AH = ObsolÃ¨te, quasi inutilisÃ©
```

## Algorithmes cryptographiques

### Algorithmes de chiffrement

#### Recommandations 2024

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Algorithme     â”‚ ClÃ©     â”‚  Performance â”‚  SÃ©curitÃ©    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AES-128-GCM      â”‚ 128 bit â”‚ Excellente   â”‚ Haute        â”‚
â”‚                  â”‚         â”‚ (avec AES-NI)â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AES-256-GCM      â”‚ 256 bit â”‚ Excellente   â”‚ TrÃ¨s haute   â”‚
â”‚ (RECOMMANDÃ‰)     â”‚         â”‚ (avec AES-NI)â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ChaCha20-Poly1305â”‚ 256 bit â”‚ Excellente   â”‚ TrÃ¨s haute   â”‚
â”‚ (RECOMMANDÃ‰)     â”‚         â”‚ (sans AES-NI)â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AES-128-CBC      â”‚ 128 bit â”‚ Bonne        â”‚ Acceptable   â”‚
â”‚ + HMAC-SHA256    â”‚ + 256   â”‚              â”‚ (legacy)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AES-256-CBC      â”‚ 256 bit â”‚ Bonne        â”‚ Haute        â”‚
â”‚ + HMAC-SHA384    â”‚ + 384   â”‚              â”‚ (legacy)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DÃ‰PRÃ‰CIÃ‰ / NE PAS UTILISER :                             â”‚
â”‚ - 3DES (56-bit effective, lent)                          â”‚
â”‚ - DES (cassÃ©)                                            â”‚
â”‚ - RC4 (cassÃ©)                                            â”‚
â”‚ - NULL (pas de chiffrement)                              â”‚
â”‚ - AES-CBC seul sans authentication                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### DÃ©tails AES-GCM

```
Advanced Encryption Standard - Galois/Counter Mode

SpÃ©cifications :
- Standard : NIST FIPS 197 + SP 800-38D
- Bloc size : 128 bits (16 bytes)
- ClÃ© : 128, 192, ou 256 bits
- Nonce : 96 bits (recommandÃ©)
- Tag : 128 bits (16 bytes)

OpÃ©rations :
1. Counter Mode (CTR) :
   - Stream cipher mode
   - ParallÃ©lisable
   - Pas de propagation d'erreur

2. Galois Field multiplication :
   - Authentication
   - Efficace en hardware
   - RÃ©sistant aux attaques

Performance (Intel avec AES-NI + PCLMULQDQ) :
- Single core : 3-10 GB/s
- Multi-core : Scalable linÃ©airement
- Latency : ~50 cycles par bloc

SÃ©curitÃ© :
âœ“ ProuvÃ© sÃ©curisÃ© (mode AEAD)
âœ“ Aucune attaque pratique connue
âœ“ RecommandÃ© NIST, NSA, IETF
âœ— RÃ©utilisation nonce catastrophique
  â†’ TOUJOURS utiliser nonce unique par message

Usage IPsec :
Transform : ESP with AES-GCM
IKE notation : aes128gcm16, aes256gcm16
Overhead : +30 bytes (8 ESP + 8 IV + 16 Tag)
```

#### DÃ©tails ChaCha20-Poly1305

```
ChaCha20 Stream Cipher + Poly1305 MAC

SpÃ©cifications :
- ChaCha20 : Stream cipher (D. Bernstein)
- Poly1305 : MAC (D. Bernstein)
- ClÃ© : 256 bits
- Nonce : 96 bits
- Tag : 128 bits

Avantages :
âœ“ TrÃ¨s rapide en software (pas besoin AES-NI)
âœ“ RÃ©sistant attaques timing (constant-time)
âœ“ Code simple, auditable
âœ“ Excellent pour ARM, mobile, IoT

Performance (sans hardware acceleration) :
- Software : 1-3 GB/s per core
- ARM/mobile : Souvent plus rapide qu'AES
- Latency : TrÃ¨s faible

SÃ©curitÃ© :
âœ“ ProuvÃ© sÃ©curisÃ©
âœ“ RÃ©sistant attaques side-channel
âœ“ RecommandÃ© IETF (RFC 7539, 8439)

Usage IPsec :
Transform : ESP with ChaCha20-Poly1305
IKE notation : chacha20poly1305
Overhead : Similaire AES-GCM

Quand utiliser :
âœ“ SystÃ¨mes sans AES-NI
âœ“ Mobile devices
âœ“ IoT
âœ“ SystÃ¨mes embarquÃ©s
âœ“ Alternative Ã  AES (diversification)
```

### Algorithmes d'intÃ©gritÃ©/authentification

#### Pour AH ou ESP sans AEAD

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Algorithme     â”‚  Output  â”‚  Performance â”‚  SÃ©curitÃ©    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HMAC-SHA256-128  â”‚ 128 bit  â”‚ Excellente   â”‚ TrÃ¨s haute   â”‚
â”‚ (RECOMMANDÃ‰)     â”‚          â”‚              â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HMAC-SHA384-192  â”‚ 192 bit  â”‚ TrÃ¨s bonne   â”‚ TrÃ¨s haute   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HMAC-SHA512-256  â”‚ 256 bit  â”‚ TrÃ¨s bonne   â”‚ TrÃ¨s haute   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HMAC-SHA1-96     â”‚  96 bit  â”‚ Bonne        â”‚ Acceptable   â”‚
â”‚ (LEGACY)         â”‚          â”‚              â”‚ (affaibli)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DÃ‰PRÃ‰CIÃ‰ :                                                â”‚
â”‚ - HMAC-MD5 (MD5 cassÃ©)                                    â”‚
â”‚ - SHA-1 (affaibli, collisions trouvÃ©es)                   â”‚
â”‚ - NULL (pas d'authentification)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Note : Avec AEAD (GCM, ChaCha20-Poly1305),
       pas besoin d'algorithme sÃ©parÃ©
```

#### HMAC-SHA256

```
Hash-based Message Authentication Code avec SHA-256

Structure :
HMAC(K, m) = H((K' âŠ• opad) || H((K' âŠ• ipad) || m))

OÃ¹ :
- K = clÃ© secrÃ¨te
- m = message
- H = SHA-256
- opad = 0x5c rÃ©pÃ©tÃ©
- ipad = 0x36 rÃ©pÃ©tÃ©
- || = concatenation
- âŠ• = XOR

Tronquation :
- SHA-256 produit : 256 bits (32 bytes)
- IPsec utilise : 128 bits (16 bytes) tronquÃ©s
- Suffisant pour sÃ©curitÃ©

Performance :
- Software : 100-500 MB/s par core
- Hardware : Plusieurs GB/s

SÃ©curitÃ© :
âœ“ Aucune attaque pratique
âœ“ RÃ©sistant collisions
âœ“ Standard de facto

Usage :
- AH : HMAC sur tout le paquet
- ESP (sans AEAD) : HMAC sur ESP header + payload chiffrÃ©
```

### Algorithmes d'Ã©change de clÃ©s (IKE)

```
Diffie-Hellman Groups (pour IKE) :

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Group   â”‚   Description  â”‚ Key Sizeâ”‚  Recommandation  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Group 1  â”‚ 768-bit MODP   â”‚  96 bit â”‚ OBSOLÃˆTE         â”‚
â”‚ Group 2  â”‚ 1024-bit MODP  â”‚ 112 bit â”‚ FAIBLE           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Group 5  â”‚ 1536-bit MODP  â”‚ 128 bit â”‚ MINIMUM          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Group 14 â”‚ 2048-bit MODP  â”‚ 112 bit â”‚ RECOMMANDÃ‰       â”‚
â”‚          â”‚                â”‚         â”‚ (minimum actuel) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Group 15 â”‚ 3072-bit MODP  â”‚ 128 bit â”‚ HAUTE SÃ‰CURITÃ‰   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Group 16 â”‚ 4096-bit MODP  â”‚ 152 bit â”‚ TRÃˆS HAUTE       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Group 19 â”‚ 256-bit ECP    â”‚ 128 bit â”‚ RECOMMANDÃ‰       â”‚
â”‚          â”‚ (NIST P-256)   â”‚         â”‚ (elliptique)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Group 20 â”‚ 384-bit ECP    â”‚ 192 bit â”‚ HAUTE SÃ‰CURITÃ‰   â”‚
â”‚          â”‚ (NIST P-384)   â”‚         â”‚ (elliptique)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Group 21 â”‚ 521-bit ECP    â”‚ 256 bit â”‚ TRÃˆS HAUTE       â”‚
â”‚          â”‚ (NIST P-521)   â”‚         â”‚ (elliptique)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Group 31 â”‚ Curve25519     â”‚ 128 bit â”‚ MODERNE          â”‚
â”‚          â”‚                â”‚         â”‚ (recommandÃ©)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Recommandations 2024 :
1. Group 14 (2048-bit MODP) : Minimum acceptable
2. Group 19 (P-256) : Excellent choix gÃ©nÃ©ral
3. Group 31 (Curve25519) : Moderne, rapide
4. Group 20 (P-384) : Haute sÃ©curitÃ©
5. Group 15 (3072-bit MODP) : Alternative MODP

Performance :
- MODP : Plus lent (exponentiations)
- ECP : Plus rapide, clÃ©s plus petites
- Curve25519 : Le plus rapide

Ã‰viter :
âœ— Group 1, 2 (faibles, cassables)
âœ— Group 22, 23, 24 (ECP non-standard)
```

## ConsidÃ©rations de sÃ©curitÃ©

### Rekeying et Perfect Forward Secrecy

```
ProblÃ¨me : Compromission future d'une clÃ©

Sans rekeying :
ClÃ© compromise â†’ DÃ©chiffrer TOUT l'historique

Avec rekeying rÃ©gulier :
ClÃ© compromise â†’ Seulement pÃ©riode rÃ©cente

Perfect Forward Secrecy (PFS) :
- Nouvelles clÃ©s via DH pour chaque SA
- ClÃ©s prÃ©cÃ©dentes non dÃ©rivables
- Compromission une SA â‰  autres SA

IPsec implementation :

IKE Phase 2 rekeying :
- Lifetime : 3600 seconds (1 heure typique)
- OU Volume : 100 MB de donnÃ©es
- Trigger rekey AVANT expiration
- Nouvelle SA nÃ©gociÃ©e
- Switchover transparent

Configuration strongSwan :
conn tunnel
    lifetime=3600s          # Rekey toutes les heures
    margintime=540s         # Start rekey 9 min avant
    rekeyfuzz=10%           # AlÃ©atoire Â±10%
    keyingtries=%forever    # Retry infini

RÃ©sultat :
âœ“ FenÃªtre de compromission limitÃ©e
âœ“ ClÃ©s rÃ©guliÃ¨rement renouvelÃ©es
âœ“ Forward secrecy prÃ©servÃ©e
```

### Protection contre attaques

#### Replay Attack Protection

```
Anti-replay window :

MÃ©canisme :
- Sequence number dans chaque paquet
- Bitmap tracking derniers N paquets
- Rejet paquets dÃ©jÃ  vus

Window size : 32, 64, 128, 256 (dÃ©faut 64)

Example window [1000-1063] :

Bitmap (64 bits) :
Bit 0 : Seq 1000 (reÃ§u : 1)
Bit 1 : Seq 1001 (non reÃ§u : 0)
...
Bit 63 : Seq 1063 (reÃ§u : 1)

Paquet reÃ§u Seq=1050 :
â†’ Check bit 50 : dÃ©jÃ  1 â†’ REJECT (replay)

Paquet reÃ§u Seq=1065 :
â†’ > window max (1063)
â†’ Slide window : [1002-1065]
â†’ Accept & update bit 63 = 1

Paquet reÃ§u Seq=995 :
â†’ < window min (1002)
â†’ REJECT (trop vieux)

Configuration :
# strongSwan
conn tunnel
    replay_window=64        # Default

# Cisco
crypto ipsec security-association replay window-size 64

Attaque contournement (impossible) :
Attaquant rejoue paquet Seq=1050
â†’ DÃ©tectÃ© par bitmap
â†’ RejetÃ©
```

#### Traffic Analysis Resistance

```
ESP offre protection contre analyse de trafic

Techniques :

1. Padding alÃ©atoire :
   Payload : 50 bytes
   Padding : 0-200 bytes alÃ©atoire
   â†’ Taille rÃ©elle masquÃ©e

2. Dummy traffic :
   Envoyer paquets vides pÃ©riodiquement
   â†’ Masquer silences
   â†’ Pattern traffic uniforme

3. Constant packet rate :
   Envoyer toujours X paquets/seconde
   â†’ Vraies donnÃ©es + padding
   â†’ Indiscernable de l'extÃ©rieur

Limitations :
- Overhead bande passante
- ComplexitÃ© implÃ©mentation
- Rarement implÃ©mentÃ© en pratique

Usage :
âœ“ Environnements ultra-sensibles
âœ“ Communications gouvernementales
âœ“ SystÃ¨mes militaires
âœ— Pas pour VPN commerciaux standard
```

### ProblÃ¨mes cryptographiques connus

#### Nonce Reuse (GCM)

```
CATASTROPHIQUE pour AES-GCM :

AES-GCM requiert : Nonce UNIQUE pour chaque message avec mÃªme clÃ©

Si nonce rÃ©utilisÃ© :
Message 1 : Encrypt(Key, Nonce, M1) â†’ C1
Message 2 : Encrypt(Key, Nonce, M2) â†’ C2

Attaquant peut :
C1 âŠ• C2 = M1 âŠ• M2
â†’ RÃ©cupÃ¨re XOR des plaintexts
â†’ Attaques cryptanalytiques possibles
â†’ RÃ©cupÃ©ration partielle ou complÃ¨te

Prevention IPsec :
- Sequence number toujours croissant
- UtilisÃ© dans nonce generation
- JAMAIS rÃ©utilisÃ© (rekey avant wraparound)
- ImplÃ©mentations vÃ©rifient

ImplÃ©mentation correcte :
Nonce = Salt || Sequence_Number
- Salt : 4 bytes (from SA)
- Sequence : 8 bytes (incremental)
â†’ Chaque nonce unique pendant lifetime SA
â†’ SA rekeyed avant Sequence wraparound
```

#### Birthday Attack (64-bit block ciphers)

```
ProblÃ¨me : 3DES, autres ciphers 64-bit blocks

Birthday paradox :
- Collision probable aprÃ¨s 2^(n/2) blocs
- 64-bit blocks : collision aprÃ¨s 2^32 blocs
- 2^32 Ã— 8 bytes = 32 GB

Attaque :
AprÃ¨s ~32 GB chiffrÃ©s avec mÃªme clÃ© :
â†’ Probable collision deux blocs
â†’ Fuite information

Solution :
âœ“ Utiliser AES (128-bit blocks)
âœ“ Rekey rÃ©guliÃ¨rement
âœ— NE PLUS UTILISER 3DES

Statut 3DES :
- DÃ©prÃ©ciÃ© NIST (2017)
- Interdit aprÃ¨s 2023
- Remplacer par AES immÃ©diatement
```

## Captures et exemples rÃ©els

### Capture Wireshark ESP

```
Exemple paquet ESP capturÃ© (sans dÃ©cryptage) :

Frame 42: 162 bytes on wire
Ethernet II, Src: 00:0c:29:xx:xx:xx, Dst: 00:50:56:xx:xx:xx
Internet Protocol Version 4
    Version: 4
    Header Length: 20 bytes
    Total Length: 148
    Protocol: ESP (50)
    Source: 203.0.113.10
    Destination: 198.51.100.20

Encapsulating Security Payload
    SPI: 0x12345678
    Sequence: 1000

    [Encrypted Data: 120 bytes]
    8a 3f 9c 2e 7d 5b 4f 1a 6c 8d 9e 2a 3f 4c 5d ...
    ... (donnÃ©es illisibles)

    [ICV: 16 bytes]
    b2 e7 d3 f9 a8 c6 5b 4d 1e 0f 2a 3c 8d 9e 4f 6a

Analysis:
âœ“ ESP detected (Protocol 50)
âœ“ SPI identifies SA
âœ“ Sequence number visible
âœ— Payload completely opaque
âœ— Cannot see original protocol
âœ— Cannot see original addresses (mode tunnel)

Impossible de dÃ©terminer :
- TCP ou UDP ?
- Quels ports ?
- Quelles donnÃ©es ?
- IP addresses originales (si tunnel)
```

### Capture avec dÃ©cryptage (SSLKEYLOGFILE pour ESP)

```
Wireshark peut dÃ©chiffrer ESP si clÃ©s fournies

Configuration :
Edit â†’ Preferences â†’ Protocols â†’ ESP

ESP SAs:
[Add new SA]
  Protocol: IPv4
  Src: 203.0.113.10
  Dst: 198.51.100.20
  SPI: 0x12345678
  Encryption: AES-GCM [RFC4106]
  Encryption key: [32 bytes hex]
  Salt: [4 bytes hex]

RÃ©sultat aprÃ¨s dÃ©cryptage :

Encapsulating Security Payload
    SPI: 0x12345678
    Sequence: 1000
    IV: 0x0000000000000000

    [Decrypted Data]
    Internet Protocol Version 4
        Source: 10.1.0.5          â† IP originale visible
        Destination: 10.2.0.10    â† IP originale visible

    Transmission Control Protocol
        Source Port: 45678
        Destination Port: 443

    Hypertext Transfer Protocol
        GET /api/data HTTP/1.1
        Host: internal.example.com
        ...

Maintenant visible :
âœ“ Protocole original (TCP)
âœ“ Ports (45678 â†’ 443)
âœ“ Adresses IP originales
âœ“ DonnÃ©es applicatives (HTTP)

Note : Seulement si vous avez les clÃ©s !
En production : impossible pour attaquant
```

## ProblÃ¨mes courants et debugging

### ESP Authentication Failed

```
Erreur : "ESP authentication failed"

Causes possibles :

1. ClÃ© incorrecte :
   Gateway A : Key = 0x1234...
   Gateway B : Key = 0x5678...
   â†’ ICV ne matche pas

2. Algorithme mismatch :
   Gateway A : HMAC-SHA256
   Gateway B : HMAC-SHA384
   â†’ Calcul ICV diffÃ©rent

3. Corruption rÃ©seau :
   Paquet modifiÃ© en transit
   â†’ ICV invalide (comportement attendu)

4. Replay attack dÃ©tectÃ© :
   Sequence number dÃ©jÃ  reÃ§u
   â†’ Paquet rejetÃ©

Debug :
# Check SA configuration
ip xfrm state

# VÃ©rifier ICV algorithm
setkey -D

# Logs IPsec
journalctl -u strongswan | grep "authentication failed"

# Wireshark : Comparer ICV calculated vs received
```

### Fragmentation Issues

```
ProblÃ¨me : Paquets trop gros aprÃ¨s encapsulation ESP

SymptÃ´me :
- Petits paquets OK
- Gros paquets (>1400 bytes) DROP
- Connexions TCP Ã©tablies mais data fails
- HTTP downloads stall

Cause :
MTU path : 1500 bytes
Paquet : 1460 bytes (TCP MSS)
+ ESP overhead : ~50 bytes
= 1510 bytes > MTU
â†’ Fragmentation nÃ©cessaire
â†’ Certains Ã©quipements drop fragments

Solution :

1. MSS Clamping :
iptables -A FORWARD -p tcp --tcp-flags SYN,RST SYN \
    -j TCPMSS --set-mss 1360

2. Reduce interface MTU :
ip link set dev eth0 mtu 1400

3. PMTUD (si ICMP pas bloquÃ©) :
# Automatique, pas de config

4. Check fragmentation :
tcpdump -i any 'ip[6:2] & 0x1fff != 0'
# Affiche paquets fragmentÃ©s

Verification :
ping -M do -s 1400 remote-host
# -M do : Don't fragment
# Si reply OK : MTU OK
```

## Conclusion

AH et ESP sont les protocoles fondamentaux d'IPsec qui assurent la protection rÃ©elle des donnÃ©es au niveau IP.

**Points clÃ©s Ã  retenir** :

```
AH (Authentication Header) :
âœ“ IntÃ©gritÃ© de tout le paquet (y compris IP header)
âœ“ Authentification de l'origine
âœ“ Anti-replay
âœ— AUCUN chiffrement
âœ— Incompatible NAT (fondamentalement)
âœ— Pratiquement obsolÃ¨te (<1% usage)
â†’ NE PAS UTILISER en 2024

ESP (Encapsulating Security Payload) :
âœ“ Chiffrement du payload (confidentialitÃ©)
âœ“ IntÃ©gritÃ© du payload
âœ“ Authentification
âœ“ Anti-replay
âœ“ Compatible NAT (avec NAT-T)
âœ“ Support AEAD (GCM, ChaCha20-Poly1305)
âœ“ Standard universel (>99% usage)
â†’ TOUJOURS UTILISER

Algorithmes recommandÃ©s 2024 :
1. AES-256-GCM (avec AES-NI)
2. ChaCha20-Poly1305 (sans AES-NI, mobile)
3. AES-128-GCM (acceptable)

Ã‰viter :
âœ— 3DES (cassable, lent)
âœ— CBC sans AEAD (vulnÃ©rabilitÃ©s)
âœ— MD5, SHA-1 (affaiblis)
âœ— NULL cipher (pas de sÃ©curitÃ©)

SÃ©curitÃ© :
âœ“ Rekeying rÃ©gulier (1 heure typique)
âœ“ Perfect Forward Secrecy (PFS)
âœ“ Anti-replay window (64+ paquets)
âœ“ Nonce unique (critique pour GCM)

Debugging :
- Wireshark avec clÃ©s ESP
- ip xfrm state (Linux)
- show crypto ipsec sa (Cisco)
- Logs strongSwan/Racoon
```

**RÃ¨gle d'or** :

```
Utiliser ESP uniquement
AES-256-GCM ou ChaCha20-Poly1305
Rekeying actif
Monitoring

= Configuration sÃ»re et performante
```

Cette comprÃ©hension dÃ©taillÃ©e d'AH et ESP permet de :
- Configurer correctement IPsec
- Diagnostiquer problÃ¨mes cryptographiques
- Choisir algorithmes appropriÃ©s
- Comprendre traces rÃ©seau
- Optimiser performance et sÃ©curitÃ©

Dans les sections suivantes du tutoriel, nous continuerons avec les VPN et pare-feu, qui utilisent ces protocoles ESP comme fondation pour crÃ©er des architectures de sÃ©curitÃ© rÃ©seau complÃ¨tes.

â­ï¸ [VPN : principes et protocoles](/06-securite/06-vpn.md)
