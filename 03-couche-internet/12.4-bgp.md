üîù Retour au [Sommaire](/SOMMAIRE.md)

# 3.12.4 BGP : le protocole d'Internet

## Introduction

Imaginez Internet non pas comme un seul r√©seau g√©ant, mais comme **des milliers de r√©seaux ind√©pendants** (appartenant √† des FAI, des entreprises, des universit√©s, des gouvernements) qui doivent coop√©rer pour acheminer le trafic global. Chacun de ces r√©seaux a ses propres r√®gles, ses propres int√©r√™ts commerciaux, et ses propres pr√©f√©rences de routage.

**BGP (Border Gateway Protocol)** est le protocole qui permet √† tous ces r√©seaux ind√©pendants de communiquer entre eux et de partager les informations de routage. C'est litt√©ralement **le protocole qui fait fonctionner Internet**.

### Analogie : Le syst√®me postal international

Pensez √† BGP comme le syst√®me qui r√©git la coop√©ration entre les services postaux de tous les pays du monde :

- Chaque pays (= AS, Syst√®me Autonome) g√®re son propre syst√®me postal interne
- Pour envoyer une lettre √† l'√©tranger, les pays doivent coop√©rer
- Chaque pays d√©cide avec quels autres pays il a des accords
- Il peut y avoir des pr√©f√©rences : "Pr√©f√®re passer par ce pays plut√¥t que celui-l√†"
- Des consid√©rations politiques et commerciales entrent en jeu
- Mais au final, tous travaillent ensemble pour que votre lettre arrive √† destination

## BGP vs IGP : Une distinction fondamentale

Avant de plonger dans BGP, il est crucial de comprendre la diff√©rence entre deux cat√©gories de protocoles de routage.

### IGP (Interior Gateway Protocol)

Les protocoles que nous avons vus jusqu'ici (RIP, OSPF) sont des **IGP** :
- Utilis√©s **√† l'int√©rieur** d'une organisation
- Tous les routeurs appartiennent √† la m√™me entit√© administrative
- Objectif : Trouver le chemin **techniquement optimal** (plus court, plus rapide)
- Confiance totale entre les routeurs
- Pas de consid√©rations politiques ou commerciales

**Exemples d'IGP** :
- RIP
- OSPF
- EIGRP (Cisco)
- IS-IS

### EGP (Exterior Gateway Protocol)

BGP est un **EGP** :
- Utilis√© **entre** diff√©rentes organisations
- Les routeurs appartiennent √† des entit√©s diff√©rentes
- Objectif : Respecter des **politiques de routage** (commerciales, politiques, techniques)
- M√©fiance potentielle entre partenaires
- Consid√©rations business importantes

**BGP est le seul EGP moderne utilis√©**.

### Tableau comparatif

| Crit√®re | IGP (OSPF, RIP) | EGP (BGP) |
|---------|-----------------|-----------|
| **Port√©e** | Intra-organisation | Inter-organisations |
| **Objectif principal** | Chemin optimal technique | Respect des politiques |
| **Confiance** | Totale | Limit√©e |
| **M√©trique** | Technique (co√ªt, sauts) | Politique (pr√©f√©rences) |
| **√âchelle** | Dizaines/centaines routeurs | Centaines de milliers routes |
| **Convergence** | Rapide (secondes) | Lente (minutes) |
| **Crit√®re** | Performance | Politique et contr√¥le |

## Le concept de syst√®me autonome (AS)

### D√©finition

Un **syst√®me autonome** (AS - Autonomous System) est :
- Un ensemble de r√©seaux IP sous une **administration commune**
- Qui pr√©sente une **politique de routage unique** vers Internet
- Identifi√© par un **num√©ro d'AS (ASN)** unique

**Num√©ros d'AS** :
- ASN 16 bits : 1 √† 65535 (format historique)
- ASN 32 bits : jusqu'√† 4 294 967 295 (format moderne)
- ASN priv√©s : 64512-65534 (comme les IP priv√©es)

### Analogie : Les pays

Un AS est comme un pays :
- Il a un **num√©ro unique** (comme un code pays)
- Il a ses **propres lois internes** (politiques de routage)
- Il a des **fronti√®res** avec d'autres AS
- Il peut choisir avec qui il fait des **accords** (peering)
- Il peut avoir des **pr√©f√©rences** (routes pr√©f√©r√©es)

### Exemples d'AS r√©els

| Organisation | ASN | Type |
|--------------|-----|------|
| Google | AS15169 | Content Provider |
| Cloudflare | AS13335 | CDN |
| Orange (France) | AS3215 | FAI |
| OVH | AS16276 | H√©bergeur |
| Universit√© Harvard | AS11 | Institution |
| Microsoft | AS8075 | Tech Company |

**V√©rification en ligne** : Vous pouvez chercher "What is my ASN" pour conna√Ætre l'AS de votre FAI.

### Qui a besoin d'un AS ?

Vous avez besoin d'un AS si :
- Vous √™tes un **FAI** fournissant l'acc√®s Internet
- Vous √™tes une **grande entreprise** avec plusieurs connexions Internet
- Vous voulez faire du **multihoming** (connexions √† plusieurs FAI)
- Vous g√©rez un **CDN** ou un r√©seau de contenu global
- Vous voulez avoir un **contr√¥le total** sur votre routage Internet

Vous n'avez **PAS** besoin d'un AS si :
- Vous √™tes une petite entreprise avec une seule connexion Internet
- Vous utilisez juste la connexion de votre FAI
- Vous n'avez pas de politiques de routage complexes

## eBGP vs iBGP

BGP se d√©cline en deux variantes selon o√π il est utilis√©.

### eBGP (External BGP)

**eBGP** est utilis√© **entre diff√©rents AS**.

```
AS 100                    AS 200
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇRouter A ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄeBGP‚îÄ‚îÄ‚îÄ‚îÄ‚Üí‚îÇRouter B ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  (FAI 1)                  (FAI 2)
```

**Caract√©ristiques** :
- Les routeurs sont dans des AS diff√©rents
- G√©n√©ralement directement connect√©s physiquement
- TTL = 1 par d√©faut (voisins directs)
- Change le num√©ro AS dans les annonces (ajoute son propre AS)
- Utilis√© aux fronti√®res entre organisations

**Analogie** : C'est comme les relations diplomatiques entre pays.

### iBGP (Internal BGP)

**iBGP** est utilis√© **√† l'int√©rieur du m√™me AS**.

```
     AS 100
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ R1 ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ R2 ‚îÇ‚îÇ ‚Üê iBGP entre R1 et R2
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Caract√©ristiques** :
- Les routeurs sont dans le m√™me AS
- Peuvent ne pas √™tre directement connect√©s
- TTL = 255 par d√©faut
- Ne change pas le num√©ro AS
- Utilis√© pour propager les routes externes √† l'int√©rieur de l'AS

**Pourquoi iBGP ?**

Imaginons :
```
     Internet (AS 200)
         |
    [R1] ‚Üê Apprend routes via eBGP
         |
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ   AS 100    ‚îÇ
  ‚îÇ  [R2]  [R3] ‚îÇ ‚Üê Comment R2 et R3 apprennent-ils ces routes ?
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Solution** : R1 redistribue les routes BGP √† R2 et R3 via **iBGP**.

**R√®gle importante** : Une route apprise via iBGP **n'est pas r√©annonc√©e** √† un autre voisin iBGP (pr√©vention de boucles).

### eBGP vs iBGP : R√©sum√©

| Aspect | eBGP | iBGP |
|--------|------|------|
| **Usage** | Entre AS diff√©rents | Dans le m√™me AS |
| **AS_PATH** | Modifi√© (AS ajout√©) | Non modifi√© |
| **Next-hop** | Modifi√© (soi-m√™me) | Pr√©serv√© |
| **TTL par d√©faut** | 1 | 255 |
| **Connexion physique** | G√©n√©ralement directe | Peut √™tre indirecte |
| **Redistribution** | Vers iBGP et eBGP | Uniquement vers eBGP |

## Fonctionnement de BGP : Path Vector

### Qu'est-ce qu'un protocole Path Vector ?

BGP est un protocole **path vector** (vecteur de chemin), une √©volution du vecteur de distance.

**Principe** : BGP n'annonce pas seulement la destination et la distance, mais **le chemin complet** (liste des AS travers√©s).

**Analogie** : C'est comme un itin√©raire complet :
- Vecteur de distance (RIP) : "Paris est √† 3 villes de distance"
- Path vector (BGP) : "Pour aller √† Paris, tu passes par Rennes, Le Mans, puis Paris"

### Format d'une annonce BGP

```
R√©seau : 203.0.113.0/24
AS_PATH : 100 200 300
Next-hop : 10.0.0.1
Origine : IGP
```

**Traduction** : "Pour atteindre le r√©seau 203.0.113.0/24, passe par les AS 100, puis 200, puis 300, et envoie les paquets √† 10.0.0.1"

### Pr√©vention des boucles

L'**AS_PATH** pr√©vient les boucles automatiquement :

```
AS 100 annonce : 203.0.113.0/24, AS_PATH = [100]
AS 200 re√ßoit et propage : AS_PATH = [200, 100]
AS 300 re√ßoit et propage : AS_PATH = [300, 200, 100]
AS 100 re√ßoit cette annonce avec AS_PATH = [300, 200, 100]
‚Üí AS 100 voit son propre num√©ro dans le chemin
‚Üí REJET de l'annonce (boucle d√©tect√©e)
```

**C'est brillamment simple** : Si tu vois ton propre num√©ro AS dans le chemin, c'est une boucle, donc rejette !

## √âtablissement d'une session BGP

### Configuration des voisins

Contrairement √† OSPF (d√©couverte automatique), BGP n√©cessite une **configuration manuelle** des voisins.

```
Configuration d'un routeur :

router bgp 100                      ! Mon AS = 100
  neighbor 10.0.0.2 remote-as 200   ! Voisin eBGP dans AS 200
  neighbor 192.168.1.2 remote-as 100 ! Voisin iBGP dans mon AS
  network 203.0.113.0 mask 255.255.255.0 ! Annonce ce r√©seau
```

### Processus d'√©tablissement (FSM - Finite State Machine)

BGP utilise **TCP port 179** (connexion fiable) et passe par plusieurs √©tats :

1. **Idle** : √âtat initial, pas de connexion
2. **Connect** : Tentative de connexion TCP
3. **Active** : R√©essaie la connexion si √©chec
4. **OpenSent** : Message OPEN envoy√©
5. **OpenConfirm** : Message OPEN re√ßu et valid√©
6. **Established** : Session √©tablie, √©change de routes ‚úÖ

**Une fois √©tablie**, la session reste ouverte ind√©finiment (contrairement aux mises √† jour p√©riodiques de RIP/OSPF).

### Types de messages BGP

| Type | Usage |
|------|-------|
| **OPEN** | Initie la session, n√©gocie les param√®tres |
| **UPDATE** | Annonce de nouvelles routes ou retrait de routes |
| **KEEPALIVE** | Maintient la session active (envoy√© r√©guli√®rement) |
| **NOTIFICATION** | Signale une erreur, ferme la session |

## Les attributs BGP

BGP utilise des **attributs** pour d√©crire les routes et influencer la s√©lection du meilleur chemin. C'est ce qui rend BGP si puissant et flexible.

### Classification des attributs

- **Well-known mandatory** : Doivent √™tre pr√©sents dans toute mise √† jour
- **Well-known discretionary** : Reconnus par tous, mais optionnels
- **Optional transitive** : Propag√©s m√™me si non reconnus
- **Optional non-transitive** : Non propag√©s si non reconnus

### Les attributs principaux

#### 1. AS_PATH (Well-known mandatory)

**Le plus important** : Liste des AS travers√©s.

**Usages** :
- Pr√©vention des boucles
- M√©trique par d√©faut (plus court = meilleur)
- Influence des d√©cisions de routage

**Exemple** :
```
Route A : AS_PATH = [100, 200, 300] ‚Üê 3 AS
Route B : AS_PATH = [100, 500] ‚Üê 2 AS
‚Üí BGP pr√©f√®re Route B (plus court)
```

**Manipulation** : On peut "allonger" artificiellement un chemin pour le rendre moins attractif :
```
Ajout de prepending :
AS_PATH = [100, 100, 100, 200] ‚Üê AS 100 r√©p√©t√© 3 fois
```

#### 2. NEXT_HOP (Well-known mandatory)

**Indique l'adresse IP** du prochain routeur √† utiliser pour atteindre le r√©seau.

**Comportement** :
- **eBGP** : Modifi√© (l'adresse du routeur BGP qui envoie)
- **iBGP** : Pr√©serv√© (l'adresse du routeur eBGP original)

**Probl√®me courant iBGP** :
```
[R1-eBGP]‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[R2-iBGP]
  |                |
AS 200           AS 100

R1 annonce 203.0.113.0/24 avec NEXT_HOP = 10.0.0.1 (adresse de R1)
R2 propage √† iBGP avec NEXT_HOP = 10.0.0.1 (pr√©serv√©)
‚Üí Les autres routeurs iBGP doivent pouvoir joindre 10.0.0.1 !
```

**Solution** : S'assurer que l'IGP (OSPF) propage les routes vers les NEXT_HOP.

#### 3. LOCAL_PREF (Well-known discretionary)

**Pr√©f√©rence locale** pour influencer le trafic **sortant** de l'AS.

**Caract√©ristiques** :
- Plus √©lev√© = meilleur
- Par d√©faut = 100
- Propag√© uniquement en iBGP (pas en eBGP)
- √âvalu√© **en premier** dans le processus de s√©lection

**Sc√©nario** :
```
       Internet
         /  \
    FAI A    FAI B
        \  /
       AS 100

Pr√©f√©rer FAI A pour tout le trafic sortant :
- Routes via FAI A : LOCAL_PREF = 200
- Routes via FAI B : LOCAL_PREF = 100
‚Üí Tous les routeurs internes pr√©f√®rent FAI A
```

#### 4. MED (Multi-Exit Discriminator)

**M√©trique externe** pour influencer le trafic **entrant** dans l'AS.

**Caract√©ristiques** :
- Plus bas = meilleur (inverse de LOCAL_PREF !)
- Par d√©faut = 0
- Propag√© aux AS voisins (contrairement √† LOCAL_PREF)
- Compar√© uniquement entre routes du m√™me AS voisin

**Sc√©nario** :
```
AS 100 a deux liens vers AS 200 :
- Lien A : rapide
- Lien B : lent

AS 100 annonce ses r√©seaux √† AS 200 :
- Via Lien A : MED = 10 (pr√©f√©r√©)
- Via Lien B : MED = 50
‚Üí AS 200 pr√©f√®re envoyer le trafic via Lien A
```

**Analogie** : LOCAL_PREF = "Quelle porte je pr√©f√®re pour sortir de chez moi", MED = "Quelle porte je sugg√®re aux visiteurs d'utiliser"

#### 5. ORIGIN (Well-known mandatory)

**Source de la route** :
- **IGP (i)** : Route originaire de l'AS (network statement)
- **EGP (e)** : Historique, rarement utilis√©
- **Incomplete (?)** : Route redistribu√©e depuis un autre protocole

**Pr√©f√©rence** : IGP > EGP > Incomplete

#### 6. WEIGHT (Cisco propri√©taire)

**Attribut local Cisco**, non propag√©.

**Caract√©ristiques** :
- Plus √©lev√© = meilleur
- Par d√©faut = 0 (routes re√ßues), 32768 (routes locales)
- √âvalu√© **avant tout**, m√™me LOCAL_PREF
- Utile pour influencer le routage sur un routeur unique

### Tableau r√©capitulatif

| Attribut | Type | Port√©e | Valeur pr√©f√©r√©e | Usage principal |
|----------|------|--------|-----------------|-----------------|
| **AS_PATH** | Well-known | Tous | Plus court | Pr√©vention boucles, m√©trique |
| **NEXT_HOP** | Well-known | Tous | N/A | Prochain saut |
| **LOCAL_PREF** | Well-known | iBGP | Plus √©lev√© | Trafic sortant |
| **MED** | Optional | AS voisins | Plus bas | Trafic entrant |
| **ORIGIN** | Well-known | Tous | IGP | Source route |
| **WEIGHT** | Cisco | Local | Plus √©lev√© | Pr√©f√©rence locale |

## Processus de s√©lection du meilleur chemin

Quand BGP re√ßoit plusieurs routes vers la m√™me destination, il doit choisir la meilleure selon un algorithme **d√©terministe** et **pr√©dictible**.

### L'algorithme (ordre strict)

BGP √©value les routes dans cet ordre pr√©cis :

```
1. WEIGHT (Cisco) : Plus √©lev√© gagne
   ‚Üì Si √©galit√©
2. LOCAL_PREF : Plus √©lev√© gagne
   ‚Üì Si √©galit√©
3. Routes locales : Pr√©f√©r√©es aux routes apprises
   ‚Üì Si √©galit√©
4. AS_PATH : Plus court gagne
   ‚Üì Si √©galit√©
5. ORIGIN : IGP > EGP > Incomplete
   ‚Üì Si √©galit√©
6. MED : Plus bas gagne (si m√™me AS voisin)
   ‚Üì Si √©galit√©
7. eBGP > iBGP : Routes eBGP pr√©f√©r√©es
   ‚Üì Si √©galit√©
8. IGP metric : Plus bas co√ªt vers NEXT_HOP
   ‚Üì Si √©galit√©
9. Router ID : Plus bas Router ID gagne
```

**Important** : BGP **s'arr√™te d√®s qu'un crit√®re d√©partage** les routes. Il ne descend la liste que si √©galit√©.

### Exemple de s√©lection

Trois routes vers 203.0.113.0/24 :

```
Route A :
  WEIGHT = 0, LOCAL_PREF = 100, AS_PATH = [200, 300], MED = 50

Route B :
  WEIGHT = 0, LOCAL_PREF = 150, AS_PATH = [400], MED = 10

Route C :
  WEIGHT = 100, LOCAL_PREF = 100, AS_PATH = [500, 600], MED = 100
```

**Processus** :
1. Comparaison WEIGHT : Route C = 100, A et B = 0 ‚Üí **Route C gagne** ‚úÖ
2. On ne va pas plus loin (Route C s√©lectionn√©e)

**Si Route C n'existait pas** :
1. WEIGHT √©gal (0)
2. LOCAL_PREF : B = 150, A = 100 ‚Üí **Route B gagne** ‚úÖ

**Mn√©monique** : "**W**e **L**ove **O**ranges **A**s **O**ranges **M**ean **P**ure **R**efreshment" (Weight, Local_pref, Origin, AS_path, Origin, MED, Paths, Router-id)

## Politiques de routage BGP

La vraie puissance de BGP r√©side dans sa capacit√© √† impl√©menter des **politiques de routage** complexes.

### Filtrage des routes

**Sc√©nario** : Vous ne voulez pas que certaines routes soient annonc√©es ou accept√©es.

**M√©thodes** :
- **Prefix-lists** : Filtrer par pr√©fixe IP
- **AS-path filters** : Filtrer par AS dans le chemin
- **Community filters** : Filtrer par tags logiques

**Exemple** :
```
ip prefix-list DENY-DEFAULT deny 0.0.0.0/0
ip prefix-list DENY-DEFAULT permit 0.0.0.0/0 le 32

router bgp 100
  neighbor 10.0.0.2 prefix-list DENY-DEFAULT out
```
‚Üí N'annonce jamais la route par d√©faut √† ce voisin

### Manipulation des attributs

**Sc√©nario** : Influencer les d√©cisions de routage.

**Exemple LOCAL_PREF** :
```
route-map PREFER-FAI-A permit 10
  match as-path 200
  set local-preference 200

route-map PREFER-FAI-A permit 20
  set local-preference 100

router bgp 100
  neighbor 10.0.0.1 route-map PREFER-FAI-A in
```
‚Üí Pr√©f√©rer les routes venant de AS 200

**Exemple AS-PATH prepending** :
```
route-map PREPEND permit 10
  set as-path prepend 100 100 100

router bgp 100
  neighbor 10.0.0.2 route-map PREPEND out
```
‚Üí Rend nos routes moins attractives pour ce voisin

### Communities BGP

Les **communities** sont des tags (√©tiquettes) attach√©s aux routes pour grouper et g√©rer les politiques.

**Format** : AS:valeur (ex: 100:10)

**Communities well-known** :
- **NO_EXPORT** (0xFFFFFF01) : Ne pas exporter hors de l'AS
- **NO_ADVERTISE** (0xFFFFFF02) : Ne pas annoncer √† aucun pair
- **INTERNET** (0:0) : Annoncer √† tous

**Utilisation** :
```
route-map TAG-BACKUP
  set community 100:999

router bgp 100
  neighbor 10.0.0.1 send-community
  neighbor 10.0.0.1 route-map TAG-BACKUP out
```

Ensuite, les voisins peuvent filtrer ou modifier les routes selon la community.

## Multihoming : Connexions multiples √† Internet

Le **multihoming** est une raison majeure d'utiliser BGP.

### Qu'est-ce que le multihoming ?

Se connecter √† Internet via **plusieurs FAI** pour :
- Redondance (si un FAI tombe, l'autre prend le relais)
- √âquilibrage de charge
- Optimisation des co√ªts
- Performance (choisir le meilleur chemin)

### Types de multihoming

#### 1. Multihoming simple (sans BGP)

```
    [Entreprise]
       /    \
  FAI A     FAI B
  (D√©faut)  (Secours)
```

**Configuration** :
- Route par d√©faut via FAI A
- Route statique de secours via FAI B (m√©trique plus √©lev√©e)
- Utilise NAT, diff√©rentes IP publiques

**Limitations** :
- Basculement lent
- Pas de contr√¥le sur le trafic entrant
- Pas d'optimisation

#### 2. Multihoming avec BGP (Provider Independent)

```
    [Entreprise - AS 100]
    (Espace IP propre)
       /    \
  FAI A     FAI B
```

**Avantages** :
- Annonce le m√™me espace IP via les deux FAI
- Contr√¥le du trafic entrant et sortant
- Basculement automatique
- Optimisation des chemins

**Configuration typique** :
```
router bgp 100
  neighbor 10.1.0.1 remote-as 200  ! FAI A
  neighbor 10.2.0.1 remote-as 300  ! FAI B
  network 203.0.113.0 mask 255.255.255.0

  ! Pr√©f√©rer FAI A pour le trafic sortant
  neighbor 10.1.0.1 route-map PREFER-A in

  ! Influencer le trafic entrant avec MED
  neighbor 10.1.0.1 route-map MED-10 out
  neighbor 10.2.0.1 route-map MED-50 out
```

### Load balancing entrant et sortant

**Trafic sortant** (contr√¥le total) :
- Utiliser LOCAL_PREF pour diriger le trafic
- Possibilit√© de load-balance sur plusieurs liens

**Trafic entrant** (influence limit√©e) :
- Utiliser MED pour sugg√©rer des pr√©f√©rences
- AS-PATH prepending pour rendre un chemin moins attractif
- Communities pour signaler des intentions

**R√©alit√©** : On ne contr√¥le jamais compl√®tement le trafic entrant (c'est l'AS distant qui d√©cide).

## BGP et la s√©curit√©

### Probl√®mes de s√©curit√© BGP

BGP a √©t√© con√ßu dans les ann√©es 90 avec l'hypoth√®se de confiance mutuelle. Mais aujourd'hui :

#### 1. Hijacking BGP

Un AS malveillant ou mal configur√© annonce des pr√©fixes qui ne lui appartiennent pas.

**Exemple c√©l√®bre** : Pakistan Telecom en 2008
- Pakistan a annonc√© 208.65.153.0/24 (YouTube)
- Le trafic mondial vers YouTube a √©t√© d√©tourn√© vers le Pakistan
- Panne mondiale de YouTube pendant plusieurs heures

#### 2. Route leaks

Un AS annonce par erreur des routes apprises d'un voisin √† un autre, cr√©ant des chemins sous-optimaux.

```
AS A ‚îÄ‚îÄ‚Üí AS B ‚îÄ‚îÄ‚Üí AS C
         ‚Üì
       Leak !
         ‚Üì
       AS D

AS D re√ßoit les routes de A via B (normalement interdit)
```

#### 3. Absence d'authentification

Par d√©faut, BGP ne v√©rifie pas :
- Que l'AS qui annonce un pr√©fixe en est vraiment propri√©taire
- Que l'AS_PATH est correct
- Que l'annonce n'est pas falsifi√©e

### Solutions de s√©curit√©

#### 1. Filtrage rigoureux

```
! N'accepter que les routes l√©gitimes
ip as-path access-list 10 permit ^200$
ip as-path access-list 10 permit ^200_[0-9]+$

! Rejeter les pr√©fixes trop sp√©cifiques ou trop g√©n√©raux
ip prefix-list SANITY deny 0.0.0.0/0 le 7
ip prefix-list SANITY deny 0.0.0.0/0 ge 25
```

#### 2. RPKI (Resource Public Key Infrastructure)

Infrastructure de cl√©s publiques pour valider :
- L'AS propri√©taire d'un pr√©fixe (ROA - Route Origin Authorization)
- La longueur maximale de pr√©fixe annonc√©e

**√âtats de validation** :
- **Valid** ‚úÖ : ROA existe et correspond
- **Invalid** ‚ùå : ROA existe mais ne correspond pas
- **Unknown** ‚ö†Ô∏è : Pas de ROA (la majorit√© aujourd'hui)

**Configuration** :
```
router bgp 100
  bgp rpki server tcp 192.0.2.1 port 323 refresh 600

route-map RPKI-FILTER deny 10
  match rpki invalid
route-map RPKI-FILTER permit 20

neighbor 10.0.0.1 route-map RPKI-FILTER in
```

#### 3. BGPsec

Extension de BGP pour signer cryptographiquement l'AS_PATH.

**Statut** : Sp√©cifi√© mais tr√®s peu d√©ploy√© (complexit√©, performance).

#### 4. Authentification MD5

Protection minimale de la session TCP BGP :
```
router bgp 100
  neighbor 10.0.0.1 password SecretKey123
```

Emp√™che l'injection de fausses mises √† jour, mais ne valide pas le contenu.

## Avantages de BGP

### 1. Scalabilit√© exceptionnelle
- G√®re plus de **900 000 routes** dans la table BGP globale (2024)
- Utilis√© par tous les AS d'Internet
- Prouv√© √† l'√©chelle mondiale

### 2. Flexibilit√© des politiques
- Contr√¥le total sur le routage
- Politiques commerciales, politiques, techniques
- Multihoming sophistiqu√©

### 3. Stabilit√©
- Sessions persistantes (pas de mises √† jour p√©riodiques)
- Convergence contr√¥l√©e
- Pas de boucles gr√¢ce √† AS_PATH

### 4. Standard ouvert
- RFC 4271 (BGP-4)
- Support√© par tous les fabricants
- Interop√©rabilit√© mondiale

### 5. Richesse des attributs
- Nombreux crit√®res de s√©lection
- Manipulation fine du routage
- Extensible (nouveaux attributs possibles)

### 6. Pas de limite de distance
- Aucune restriction sur le nombre d'AS travers√©s
- Adapt√© √† l'√©chelle mondiale

### 7. Support IPv4 et IPv6
- BGP multiprotocol (MP-BGP)
- M√™me protocole pour plusieurs adresses families
- VPNs (MPLS VPNs)

## Inconv√©nients de BGP

### 1. Complexit√© extr√™me
- Courbe d'apprentissage tr√®s raide
- Configuration d√©taill√©e n√©cessaire
- Difficile √† d√©boguer
- Erreurs peuvent avoir impact global

### 2. Convergence lente
- Minutes √† dizaines de minutes
- Path exploration (teste diff√©rents chemins)
- Peut causer des blackholes temporaires

### 3. Consommation de ressources
- Table BGP compl√®te : ~900 000 routes = plusieurs Go de RAM
- CPU pour traiter les mises √† jour
- √âquipements haut de gamme n√©cessaires

### 4. S√©curit√© limit√©e
- Peu de m√©canismes de s√©curit√© natifs
- Vuln√©rable au hijacking et aux leaks
- RPKI/BGPsec peu d√©ploy√©s

### 5. Pas de QoS
- BGP route les paquets, mais ne garantit pas de qualit√© de service
- Pas de consid√©ration de latence ou de perte
- Uniquement politique et disponibilit√©

### 6. Configuration manuelle
- Pas de d√©couverte automatique
- Chaque voisin doit √™tre configur√©
- Risque d'erreurs humaines √©lev√©

### 7. Trop de flexibilit√© ?
- Possibilit√© de mal configurer avec impact majeur
- Erreurs peuvent propager mondialement
- N√©cessite expertise approfondie

## Quand utiliser BGP ?

### ‚úÖ Vous avez besoin de BGP si :

1. **Multihoming vers plusieurs FAI**
   - Vous voulez de la redondance
   - Vous voulez contr√¥ler le routage
   - Vous avez votre propre espace IP

2. **Vous √™tes un FAI**
   - Vous fournissez des connexions Internet
   - Vous devez √©changer des routes avec d'autres FAI
   - Vous avez votre propre AS

3. **Grands r√©seaux d'entreprise**
   - Multiples sites g√©ographiques
   - Connexions √† plusieurs FAI
   - Besoins de politiques de routage complexes

4. **Content Delivery Networks (CDN)**
   - Pr√©sence dans de multiples AS
   - Optimisation des chemins pour la performance
   - Contr√¥le du routage entrant

5. **Datacenters et cloud providers**
   - Infrastructure distribu√©e globalement
   - Besoin de contr√¥le fin du routage
   - Anycast IP

### ‚ùå Vous n'avez PAS besoin de BGP si :

1. **Connexion unique √† Internet**
   - Une seule connexion √† un FAI
   - Route par d√©faut statique suffit

2. **Petit r√©seau**
   - Pas de besoins de politiques complexes
   - Budget limit√©
   - Expertise limit√©e

3. **Multihoming simple**
   - Deux connexions avec basculement simple
   - Pas de besoin de contr√¥le fin
   - NAT et routes statiques suffisent

## Exemple de configuration BGP compl√®te

### Sc√©nario

Entreprise avec AS 65001, multihom√©e vers deux FAI :

```
               Internet
               /     \
        FAI A (200)  FAI B (300)
             \       /
              \     /
           [Routeur BGP]
           AS 65001
        203.0.113.0/24
```

### Configuration

```
! Configuration de base
router bgp 65001
  bgp router-id 1.1.1.1
  bgp log-neighbor-changes

  ! Annonce de notre r√©seau
  network 203.0.113.0 mask 255.255.255.0

  ! Voisin eBGP vers FAI A
  neighbor 10.1.0.1 remote-as 200
  neighbor 10.1.0.1 description FAI-A
  neighbor 10.1.0.1 password SecretA
  neighbor 10.1.0.1 route-map PREFER-FAI-A in
  neighbor 10.1.0.1 route-map ANNOUNCE-OUT out

  ! Voisin eBGP vers FAI B
  neighbor 10.2.0.1 remote-as 300
  neighbor 10.2.0.1 description FAI-B
  neighbor 10.2.0.1 password SecretB
  neighbor 10.2.0.1 route-map BACKUP-FAI-B in
  neighbor 10.2.0.1 route-map ANNOUNCE-OUT out

! Pr√©f√©rer FAI A pour le trafic sortant (LOCAL_PREF)
route-map PREFER-FAI-A permit 10
  set local-preference 200

! FAI B comme backup
route-map BACKUP-FAI-B permit 10
  set local-preference 100

! Influencer trafic entrant (MED)
route-map ANNOUNCE-OUT permit 10
  match ip address prefix-list OUR-NETWORKS
  set metric 10

! Liste de nos r√©seaux
ip prefix-list OUR-NETWORKS permit 203.0.113.0/24

! Filtrage entrant (s√©curit√© de base)
ip prefix-list BOGONS deny 0.0.0.0/8 le 32
ip prefix-list BOGONS deny 10.0.0.0/8 le 32
ip prefix-list BOGONS deny 172.16.0.0/12 le 32
ip prefix-list BOGONS deny 192.168.0.0/16 le 32
ip prefix-list BOGONS deny 224.0.0.0/4 le 32
ip prefix-list BOGONS permit 0.0.0.0/0 le 32
```

### R√©sultat

- **Trafic sortant** : Pr√©f√®re FAI A (LOCAL_PREF 200 vs 100)
- **Trafic entrant** : FAI A et B voient MED 10 (pr√©f√©rence √©gale)
- **S√©curit√©** : Filtrage des pr√©fixes bogons
- **Authentification** : Mots de passe sur les sessions
- **Redondance** : Si FAI A tombe, bascule automatique vers FAI B

## BGP dans le monde r√©el

### Statistiques (2024)

- **~75 000 AS actifs** dans Internet
- **~900 000 routes IPv4** dans la table BGP globale
- **~180 000 routes IPv6**
- **~40 nouvelles annonces par seconde** en moyenne
- **Plus long AS_PATH observ√©** : ~30 AS

### Exemples d'utilisations

#### 1. Anycast DNS
```
Cloudflare annonce 1.1.1.1 depuis des centaines d'AS
‚Üí BGP route chaque utilisateur vers le serveur le plus proche
```

#### 2. Mitigation DDoS
```
En cas d'attaque, annoncer le pr√©fixe cibl√© depuis un scrubbing center
‚Üí Le trafic est redirig√©, nettoy√©, puis renvoy√©
```

#### 3. Traffic engineering
```
Grandes entreprises ajustent leurs annonces BGP pour :
- √âquilibrer la charge entre liens
- √âviter les congestions
- Optimiser les co√ªts (certains transits plus chers que d'autres)
```

## Points cl√©s √† retenir

1. **BGP est le protocole d'Internet** : C'est lui qui permet √† tous les AS de coop√©rer
2. **Syst√®me autonome (AS)** : Groupe de r√©seaux sous une administration commune
3. **eBGP vs iBGP** : Entre AS diff√©rents vs au sein du m√™me AS
4. **Path vector** : BGP annonce le chemin complet (AS_PATH) pr√©venant les boucles
5. **Attributs BGP** : WEIGHT, LOCAL_PREF, AS_PATH, MED, etc. influencent la s√©lection
6. **Politiques de routage** : BGP permet un contr√¥le fin du routage (commercial, politique)
7. **Multihoming** : Connexions multiples avec redondance et contr√¥le
8. **S√©curit√© limit√©e** : Vuln√©rable au hijacking, RPKI apporte des am√©liorations
9. **Complexe mais puissant** : N√©cessite expertise, mais offre contr√¥le total
10. **Convergence lente** : Minutes vs secondes pour OSPF, mais stabilit√© sup√©rieure

## Ce qui vient ensuite

Dans les sections suivantes, nous explorerons :
- **3.12.5** : M√©triques et convergence - Comparaison approfondie des temps de convergence et optimisations
- **3.12.6** : Implications pour les architectures cloud et microservices - Comment le routage moderne s'adapte aux nouvelles architectures

Vous avez maintenant une vue compl√®te des principaux protocoles de routage utilis√©s dans les r√©seaux, du simple RIP au complexe BGP qui fait tourner Internet !

---

**Conseil pratique** : BGP est le protocole le plus complexe du r√©seau. Ne vous attendez pas √† le ma√Ætriser rapidement. M√™me les ing√©nieurs exp√©riment√©s continuent d'apprendre. Commencez par bien comprendre les concepts (AS, eBGP/iBGP, attributs de base), puis progressez vers les configurations r√©elles. Si vous voulez travailler pour un FAI ou g√©rer de grandes infrastructures, investir du temps dans BGP est absolument essentiel. Pour la plupart des autres r√¥les, comprendre conceptuellement BGP suffit !

‚è≠Ô∏è [M√©triques et convergence](/03-couche-internet/12.5-metriques-convergence.md)
